<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Our Date Night</title>
  <!-- Supabase JS Library -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8f9fa; min-height: 100vh; }
    
    /* Colors */
    :root {
      --primary: #ff6b6b;
      --secondary: #667eea;
      --success: #4ecdc4;
    }
    
    /* Loading Overlay */
    .loading-overlay { position: fixed; inset: 0; background: white; display: flex; align-items: center; justify-content: center; z-index: 9999; flex-direction: column; gap: 16px; }
    .loading-overlay.hidden { display: none; }
    .loading-spinner { width: 48px; height: 48px; border: 4px solid #eee; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* Welcome Screen */
    .welcome { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 24px; background: linear-gradient(135deg, #667eea 0%, #ff6b6b 100%); }
    .welcome.hidden { display: none; }
    .welcome-content { text-align: center; max-width: 400px; }
    .welcome-logo { font-size: 64px; margin-bottom: 16px; }
    .welcome h1 { font-size: 36px; font-weight: 800; color: white; margin-bottom: 8px; }
    .welcome p { color: rgba(255,255,255,0.9); margin-bottom: 48px; font-size: 18px; }
    .welcome-btn { width: 100%; padding: 16px 24px; border-radius: 30px; border: none; font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 16px; transition: transform 0.2s, box-shadow 0.2s; }
    .welcome-btn:hover { transform: translateY(-2px); }
    .welcome-btn.login { background: white; color: var(--secondary); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
    .welcome-btn.guest { background: transparent; color: white; border: 2px solid white; }
    .welcome-btn.guest:hover { background: rgba(255,255,255,0.1); }
    
    /* Login Modal */
    .login-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 300; padding: 24px; }
    .login-modal.active { display: flex; }
    .login-box { background: white; border-radius: 24px; padding: 32px; width: 100%; max-width: 360px; }
    .login-box h2 { font-size: 24px; margin-bottom: 8px; color: #333; }
    .login-box p { color: #888; margin-bottom: 24px; font-size: 14px; }
    .login-input { width: 100%; padding: 14px 16px; border: 2px solid #eee; border-radius: 12px; font-size: 16px; margin-bottom: 12px; transition: border-color 0.2s; }
    .login-input:focus { outline: none; border-color: var(--secondary); }
    .login-submit { width: 100%; padding: 14px; border-radius: 12px; border: none; background: var(--secondary); color: white; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 8px; }
    .login-submit:hover { background: #5a6fd6; }
    .login-submit:disabled { background: #ccc; cursor: not-allowed; }
    .login-switch { text-align: center; margin-top: 16px; font-size: 14px; color: #888; }
    .login-switch a { color: var(--secondary); cursor: pointer; font-weight: 600; }
    .login-close { position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.9); border: none; width: 36px; height: 36px; border-radius: 50%; font-size: 20px; cursor: pointer; }
    .login-error { color: var(--primary); font-size: 13px; margin-bottom: 12px; display: none; }
    .login-error.show { display: block; }
    .login-success { color: var(--success); font-size: 13px; margin-bottom: 12px; display: none; }
    .login-success.show { display: block; }
    
    /* Onboarding */
    .onboarding { min-height: 100vh; display: none; align-items: center; justify-content: center; padding: 24px; }
    .onboarding.active { display: flex; }
    .onboarding-content { text-align: center; max-width: 400px; }
    .onboarding h2 { font-size: 20px; color: #666; margin-bottom: 4px; }
    .onboarding h1 { font-size: 32px; font-weight: 800; color: var(--primary); margin-bottom: 8px; }
    .onboarding p { color: #888; margin-bottom: 32px; }
    .onboarding .user-greeting { font-size: 14px; color: var(--secondary); margin-bottom: 24px; }
    .profile-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .profile-btn { background: white; border: none; border-radius: 16px; padding: 24px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.1); transition: transform 0.2s, box-shadow 0.2s; }
    .profile-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
    .profile-btn .emoji { font-size: 32px; display: block; margin-bottom: 8px; }
    .profile-btn .label { font-weight: 600; color: #333; }
    
    /* App Container */
    .app { display: none; min-height: 100vh; padding-bottom: 80px; }
    .app.active { display: block; }
    
    /* Header */
    .header { background: #000; padding: 12px 16px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
    .header-left { display: flex; align-items: center; gap: 8px; }
    .header-logo { font-size: 18px; }
    .header-title { color: var(--primary); font-weight: 700; font-size: 18px; }
    .header-right { display: flex; align-items: center; gap: 8px; cursor: pointer; }
    .header-info { text-align: right; }
    .header-type { color: white; font-size: 13px; font-weight: 500; }
    .header-location { color: #ccc; font-size: 11px; }
    .header-avatar { width: 32px; height: 32px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; }
    .logged-in-badge { background: var(--success); color: white; font-size: 9px; padding: 2px 6px; border-radius: 10px; margin-left: 4px; }
    
    /* Content */
    .content { padding: 16px; }
    .section-title { font-size: 20px; font-weight: 700; margin-bottom: 16px; }
    .hidden { display: none !important; }
    
    /* Swipe Card */
    .card-container { max-width: 400px; margin: 0 auto; }
    .swipe-card { background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.15); cursor: grab; transition: transform 0.1s; }
    .swipe-card:active { cursor: grabbing; }
    .card-image { width: 100%; height: 280px; object-fit: cover; background: #ddd; }
    .card-body { padding: 16px; }
    .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
    .card-title { font-size: 20px; font-weight: 700; color: #222; flex: 1; padding-right: 8px; }
    .card-price { background: #4caf50; color: white; padding: 4px 10px; border-radius: 8px; font-size: 12px; font-weight: 600; }
    .card-meta { display: flex; flex-wrap: wrap; gap: 8px; font-size: 12px; color: #666; margin-bottom: 8px; }
    .card-desc { font-size: 14px; color: #555; margin-bottom: 8px; line-height: 1.4; }
    .card-address { font-size: 13px; color: #888; }
    .card-dots { position: absolute; bottom: 12px; left: 50%; transform: translateX(-50%); display: flex; gap: 6px; background: rgba(0,0,0,0.5); padding: 6px 12px; border-radius: 20px; }
    .card-dot { width: 8px; height: 8px; border-radius: 50%; background: rgba(255,255,255,0.5); cursor: pointer; }
    .card-dot.active { background: white; }
    .card-image-wrapper { position: relative; height: 280px; }
    .card-gallery-btn { position: absolute; top: 12px; right: 12px; background: rgba(0,0,0,0.6); color: white; border: none; padding: 6px 12px; border-radius: 20px; font-size: 13px; cursor: pointer; }
    
    /* Swipe Buttons */
    .swipe-buttons { display: flex; justify-content: center; gap: 64px; margin-top: 24px; }
    .swipe-btn { width: 64px; height: 64px; border-radius: 50%; border: 4px solid; background: white; font-size: 24px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
    .swipe-btn.pass { border-color: var(--primary); }
    .swipe-btn.pass:hover { background: var(--primary); }
    .swipe-btn.like { border-color: var(--success); }
    .swipe-btn.like:hover { background: var(--success); }
    .swipe-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    /* Empty State */
    .empty-state { background: white; border-radius: 16px; padding: 48px 24px; text-align: center; color: #888; }
    
    /* Filter Chips */
    .filter-chips { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; }
    .filter-chip { padding: 8px 14px; border-radius: 20px; border: none; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s; background: #e9ecef; color: #555; }
    .filter-chip.active { background: var(--secondary); color: white; }
    
    /* List Items */
    .list-item { background: white; border-radius: 12px; padding: 12px; display: flex; gap: 12px; margin-bottom: 12px; }
    .list-image { width: 80px; height: 80px; border-radius: 10px; object-fit: cover; cursor: pointer; flex-shrink: 0; }
    .list-content { flex: 1; min-width: 0; }
    .list-title { font-weight: 600; color: #333; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .list-meta { font-size: 12px; color: #666; margin-bottom: 4px; }
    .list-rating { font-size: 12px; color: var(--primary); }
    .list-actions { display: flex; gap: 8px; margin-top: 8px; }
    .btn-small { padding: 6px 12px; border-radius: 20px; border: none; font-size: 11px; font-weight: 600; color: white; cursor: pointer; }
    .btn-success { background: var(--success); }
    .btn-primary { background: var(--primary); }
    .btn-secondary { background: var(--secondary); }
    .btn-gray { background: #ddd; color: #333; }
    
    /* Date Cards */
    .date-card { background: white; border-radius: 12px; padding: 16px; margin-bottom: 12px; }
    .date-title { font-weight: 600; margin-bottom: 4px; }
    .date-time { font-size: 13px; color: var(--secondary); margin-bottom: 4px; }
    .date-activities { font-size: 12px; color: #666; }
    
    /* Plan Section */
    .plan-card { background: white; border-radius: 16px; padding: 16px; }
    .plan-label { font-weight: 600; margin-bottom: 8px; display: block; }
    .plan-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 14px; margin-bottom: 16px; }
    .part-count-row { display: flex; gap: 8px; margin-bottom: 16px; }
    .part-count-btn { width: 40px; height: 40px; border-radius: 50%; border: none; font-weight: 600; cursor: pointer; background: #e9ecef; color: #555; }
    .part-count-btn.active { background: var(--secondary); color: white; }
    .part-row { display: flex; align-items: center; gap: 12px; background: #f8f9fa; border-radius: 12px; padding: 12px; margin-bottom: 8px; }
    .part-num { font-size: 18px; font-weight: 700; color: var(--secondary); width: 24px; }
    .part-select { flex: 1; background: white; border: none; padding: 10px 12px; border-radius: 8px; cursor: pointer; text-align: left; font-size: 14px; }
    .btn-full { width: 100%; padding: 14px; border-radius: 25px; border: none; font-weight: 700; font-size: 15px; cursor: pointer; margin-top: 16px; }
    .btn-full.secondary { background: var(--secondary); color: white; }
    .btn-full.primary { background: var(--primary); color: white; }
    
    /* Plan Selecting */
    .plan-header { padding: 16px; border-bottom: 1px solid #eee; background: white; position: sticky; top: 56px; z-index: 10; }
    .plan-header-row { display: flex; align-items: center; justify-content: space-between; }
    .plan-back { font-size: 24px; background: none; border: none; cursor: pointer; }
    .plan-header-center { text-align: center; }
    .plan-header-title { font-weight: 700; }
    .plan-header-subtitle { font-size: 13px; color: var(--secondary); }
    .progress-bar { height: 4px; background: #e9ecef; border-radius: 2px; margin-top: 12px; overflow: hidden; }
    .progress-fill { height: 100%; background: var(--secondary); transition: width 0.3s; }
    .activity-btn { width: 100%; background: white; border: 2px solid #f0f0f0; border-radius: 12px; padding: 12px; display: flex; align-items: center; gap: 12px; text-align: left; cursor: pointer; margin-bottom: 12px; transition: border-color 0.2s; }
    .activity-btn:hover { border-color: var(--secondary); }
    .activity-btn img { width: 64px; height: 64px; border-radius: 8px; object-fit: cover; }
    .activity-btn-content { flex: 1; min-width: 0; }
    .activity-btn-title { font-weight: 600; margin-bottom: 4px; }
    .activity-btn-category { font-size: 12px; color: #666; margin-bottom: 4px; }
    .activity-btn-meta { display: flex; gap: 8px; font-size: 11px; color: #888; }
    .activity-btn-meta .price { color: #4caf50; font-weight: 600; }
    .activity-btn-arrow { font-size: 20px; color: var(--secondary); }
    
    /* Complete */
    .complete-title { font-size: 24px; font-weight: 700; text-align: center; margin-bottom: 24px; }
    .complete-item { display: flex; align-items: center; gap: 12px; background: #f8f9fa; border-radius: 12px; padding: 12px; margin-bottom: 12px; }
    .complete-num { font-size: 20px; font-weight: 700; color: var(--secondary); width: 32px; }
    .complete-img { width: 56px; height: 56px; border-radius: 8px; object-fit: cover; }
    .complete-info p:first-child { font-weight: 600; }
    .complete-info p:last-child { font-size: 13px; color: #666; }
    
    /* Profile */
    .profile-card { background: white; border-radius: 16px; padding: 16px; margin-bottom: 24px; }
    .profile-card p { margin-bottom: 4px; }
    .profile-card strong { font-weight: 600; }
    .logout-btn { background: #eee; color: #666; margin-top: 12px; }
    
    /* Bottom Nav */
    .nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #eee; padding: 8px 16px 12px; display: flex; justify-content: space-around; align-items: flex-end; z-index: 100; }
    .nav-item { display: flex; flex-direction: column; align-items: center; background: none; border: none; cursor: pointer; padding: 4px 8px; }
    .nav-icon { font-size: 20px; color: #aaa; }
    .nav-label { font-size: 11px; color: #aaa; margin-top: 2px; }
    .nav-item.active .nav-icon, .nav-item.active .nav-label { color: var(--primary); }
    .nav-item.active .nav-label { font-weight: 600; }
    .nav-center { margin-top: -20px; }
    .nav-center-btn { width: 56px; height: 56px; border-radius: 50%; background: var(--primary); border: none; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 15px rgba(255,107,107,0.4); }
    .nav-center-btn span { filter: brightness(0) invert(1); }
    
    /* Modal */
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 200; }
    .modal.active { display: flex; }
    .modal-content { background: #000; border-radius: 16px; width: 90%; max-width: 600px; height: 70%; position: relative; overflow: hidden; }
    .modal-image { width: 100%; height: 100%; object-fit: contain; }
    .modal-close { position: absolute; top: 12px; right: 12px; width: 32px; height: 32px; border-radius: 50%; background: rgba(0,0,0,0.7); color: white; border: none; font-weight: bold; cursor: pointer; }
    .modal-nav { position: absolute; bottom: 16px; left: 50%; transform: translateX(-50%); display: flex; gap: 8px; }
    .modal-dot { width: 10px; height: 10px; border-radius: 50%; background: rgba(255,255,255,0.5); border: none; cursor: pointer; }
    .modal-dot.active { background: white; }
    
    /* Verification Modal */
    .verify-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 300; padding: 24px; overflow-y: auto; }
    .verify-modal.active { display: flex; }
    .verify-box { background: white; border-radius: 24px; padding: 32px; width: 100%; max-width: 400px; max-height: 90vh; overflow-y: auto; }
    .verify-box h2 { font-size: 24px; margin-bottom: 8px; color: #333; }
    .verify-box p { color: #888; margin-bottom: 24px; font-size: 14px; }
    .verify-step { margin-bottom: 24px; }
    .verify-step-title { font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
    .verify-step-num { background: var(--secondary); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; }
    .verify-upload-box { border: 2px dashed #ddd; border-radius: 12px; padding: 24px; text-align: center; cursor: pointer; transition: all 0.2s; }
    .verify-upload-box:hover { border-color: var(--secondary); background: #f8f9ff; }
    .verify-upload-box.has-file { border-color: var(--success); background: #f0fff8; }
    .verify-upload-box input { display: none; }
    .verify-upload-icon { font-size: 32px; margin-bottom: 8px; }
    .verify-upload-text { color: #888; font-size: 14px; }
    .verify-upload-text.success { color: var(--success); }
    .verify-camera-box { border: 2px solid #ddd; border-radius: 12px; overflow: hidden; position: relative; }
    .verify-video { width: 100%; height: 200px; object-fit: cover; background: #000; }
    .verify-canvas { display: none; }
    .verify-selfie-preview { width: 100%; height: 200px; object-fit: cover; display: none; }
    .verify-camera-btn { position: absolute; bottom: 12px; left: 50%; transform: translateX(-50%); background: var(--primary); color: white; border: none; padding: 12px 24px; border-radius: 25px; font-weight: 600; cursor: pointer; }
    .verify-camera-btn:hover { background: #e85a5a; }
    .verify-retake { background: #666; margin-right: 8px; }
    .verify-status { padding: 16px; border-radius: 12px; text-align: center; margin-bottom: 16px; }
    .verify-status.pending { background: #fff3cd; color: #856404; }
    .verify-status.verified { background: #d4edda; color: #155724; }
    .verified-badge { background: var(--success); color: white; font-size: 10px; padding: 2px 8px; border-radius: 10px; margin-left: 8px; }
    
    /* Upload Content Modal */
    .upload-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: flex-start; justify-content: center; z-index: 300; padding: 24px; overflow-y: auto; }
    .upload-modal.active { display: flex; }
    .upload-box { background: white; border-radius: 24px; padding: 24px; width: 100%; max-width: 400px; margin: auto; }
    .upload-box h2 { font-size: 22px; margin-bottom: 8px; color: #333; }
    .upload-box p { color: #888; margin-bottom: 16px; font-size: 14px; }
    .upload-preview { width: 100%; max-height: 120px; border-radius: 12px; object-fit: cover; margin-bottom: 12px; display: none; background: #000; }
    .upload-video-preview { width: 100%; max-height: 120px; border-radius: 12px; object-fit: cover; margin-bottom: 12px; display: none; }
    .upload-input-group { margin-bottom: 12px; }
    .upload-input-group label { font-weight: 600; margin-bottom: 6px; display: block; font-size: 14px; }
    .upload-input-group input, .upload-input-group select, .upload-input-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 10px; font-size: 14px; }
    .upload-input-group textarea { resize: none; height: 60px; }
    .upload-file-btn { width: 100%; padding: 20px; border: 2px dashed #ddd; border-radius: 12px; background: white; cursor: pointer; text-align: center; margin-bottom: 12px; transition: all 0.2s; }
    .upload-file-btn:hover { border-color: var(--secondary); }
    .upload-file-btn.has-file { border-color: var(--success); background: #f0fff8; padding: 10px; }
    .user-content-badge { position: absolute; top: 12px; left: 12px; background: var(--secondary); color: white; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; display: flex; align-items: center; gap: 4px; }
    .user-content-badge .verified-check { color: #4caf50; }
    .card-user-info { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #eee; }
    .card-user-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; }
    .card-user-name { font-weight: 600; font-size: 14px; }
    .card-user-verified { color: var(--success); font-size: 12px; }
    
    /* Hamburger Menu */
    .hamburger-btn { background: none; border: none; cursor: pointer; padding: 8px; display: flex; flex-direction: column; gap: 4px; }
    .hamburger-btn span { display: block; width: 20px; height: 2px; background: white; border-radius: 2px; }
    .side-menu { position: fixed; top: 0; left: -280px; width: 280px; height: 100%; background: white; z-index: 400; transition: left 0.3s ease; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
    .side-menu.active { left: 0; }
    .side-menu-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 350; display: none; }
    .side-menu-overlay.active { display: block; }
    .side-menu-header { background: linear-gradient(135deg, #667eea 0%, #ff6b6b 100%); padding: 32px 24px; color: white; }
    .side-menu-header h2 { font-size: 20px; margin-bottom: 4px; }
    .side-menu-header p { font-size: 13px; opacity: 0.9; }
    .side-menu-items { padding: 16px 0; }
    .side-menu-item { display: flex; align-items: center; gap: 16px; padding: 16px 24px; cursor: pointer; transition: background 0.2s; text-decoration: none; color: #333; }
    .side-menu-item:hover { background: #f8f9fa; }
    .side-menu-item-icon { font-size: 20px; width: 28px; text-align: center; }
    .side-menu-item-text { font-size: 15px; font-weight: 500; }
    .side-menu-divider { height: 1px; background: #eee; margin: 8px 24px; }
    
    /* Payment Modal */
    .payment-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 500; padding: 24px; overflow-y: auto; }
    .payment-modal.active { display: flex; }
    .payment-box { background: white; border-radius: 24px; padding: 32px; width: 100%; max-width: 400px; max-height: 90vh; overflow-y: auto; }
    .payment-box h2 { font-size: 24px; margin-bottom: 8px; color: #333; }
    .payment-box p { color: #888; margin-bottom: 24px; font-size: 14px; }
    .saved-cards { margin-bottom: 24px; }
    .saved-card { display: flex; align-items: center; gap: 12px; padding: 16px; background: #f8f9fa; border-radius: 12px; margin-bottom: 12px; }
    .saved-card-icon { font-size: 24px; }
    .saved-card-info { flex: 1; }
    .saved-card-number { font-weight: 600; }
    .saved-card-exp { font-size: 12px; color: #888; }
    .saved-card-delete { background: none; border: none; color: var(--primary); cursor: pointer; font-size: 18px; padding: 4px; }
    .no-cards { text-align: center; color: #888; padding: 24px; background: #f8f9fa; border-radius: 12px; }
    .payment-form-group { margin-bottom: 16px; }
    .payment-form-group label { font-weight: 600; margin-bottom: 8px; display: block; font-size: 14px; }
    .payment-form-group input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 16px; }
    .payment-form-row { display: flex; gap: 12px; }
    .payment-form-row .payment-form-group { flex: 1; }
    
    /* Admin Panel */
    .admin-section { background: #fff3cd; border-radius: 16px; padding: 16px; margin-bottom: 24px; }
    .admin-section h3 { color: #856404; margin-bottom: 12px; }
    .admin-item { background: white; border-radius: 12px; padding: 12px; margin-bottom: 12px; display: flex; gap: 12px; align-items: center; }
    .admin-item-img { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; }
    .admin-item-info { flex: 1; }
    .admin-item-name { font-weight: 600; }
    .admin-item-email { font-size: 12px; color: #888; }
    .admin-item-date { font-size: 11px; color: #aaa; }
    .admin-btns { display: flex; gap: 8px; }
    .admin-btn { padding: 8px 16px; border: none; border-radius: 20px; font-weight: 600; cursor: pointer; font-size: 12px; }
    .admin-btn.approve { background: var(--success); color: white; }
    .admin-btn.reject { background: var(--primary); color: white; }
    .admin-btn.view { background: #eee; color: #333; }
  </style>
</head>
<body>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-spinner"></div>
  <p>Loading...</p>
</div>

<!-- Welcome Screen -->
<div class="welcome hidden" id="welcome">
  <div class="welcome-content">
    <div class="welcome-logo">üíï</div>
    <h1>Our Date Night</h1>
    <p>Plan the perfect date together</p>
    <button class="welcome-btn login" onclick="showLoginModal()">Log In / Sign Up</button>
    <button class="welcome-btn guest" onclick="continueAsGuest()">Continue as Guest</button>
  </div>
</div>

<!-- Login Modal -->
<div class="login-modal" id="loginModal">
  <button class="login-close" onclick="closeLoginModal()">‚úï</button>
  <div class="login-box">
    <h2 id="loginTitle">Welcome Back</h2>
    <p id="loginSubtitle">Log in to save your date plans</p>
    <div class="login-error" id="loginError">Invalid email or password</div>
    <div class="login-success" id="loginSuccess">Check your email for confirmation link!</div>
    <input type="email" class="login-input" id="loginEmail" placeholder="Email address">
    <input type="password" class="login-input" id="loginPassword" placeholder="Password">
    <input type="text" class="login-input hidden" id="loginName" placeholder="Your name">
    <button class="login-submit" id="loginSubmit" onclick="handleLogin()">Log In</button>
    <div class="login-switch">
      <span id="switchText">Don't have an account?</span> <a id="switchLink" onclick="toggleLoginMode()">Sign Up</a>
    </div>
  </div>
</div>

<!-- Onboarding Screen -->
<div class="onboarding" id="onboarding">
  <div class="onboarding-content">
    <h2>Welcome to</h2>
    <h1>Our Date Night</h1>
    <div class="user-greeting" id="userGreeting"></div>
    <p>Choose how you're planning to date.</p>
    <div class="profile-grid">
      <button class="profile-btn" onclick="selectProfile('Individual')">
        <span class="emoji">üßç</span>
        <span class="label">Individual</span>
      </button>
      <button class="profile-btn" onclick="selectProfile('Couple')">
        <span class="emoji">‚ù§Ô∏è</span>
        <span class="label">Couple</span>
      </button>
      <button class="profile-btn" onclick="selectProfile('Group')">
        <span class="emoji">üë•</span>
        <span class="label">Group</span>
      </button>
      <button class="profile-btn" onclick="selectProfile('Friends')">
        <span class="emoji">üéâ</span>
        <span class="label">Friends</span>
      </button>
    </div>
  </div>
</div>

<!-- Main App -->
<div class="app" id="app">
  <!-- Header -->
  <header class="header">
    <div class="header-left">
      <button class="hamburger-btn" onclick="openSideMenu()">
        <span></span>
        <span></span>
        <span></span>
      </button>
      <span class="header-logo">üíï</span>
      <span class="header-title">Our Date Night</span>
    </div>
    <div class="header-right" onclick="showTab('profile')">
      <div class="header-info">
        <div class="header-type">
          <span id="headerType">Guest</span>
          <span class="logged-in-badge hidden" id="loggedInBadge">‚úì</span>
        </div>
        <div class="header-location">üìç New York, NY</div>
      </div>
      <div class="header-avatar">üë§</div>
    </div>
  </header>

  <!-- Tab: Discover -->
  <div class="content tab-content" id="tab-discover">
    <h2 class="section-title">Discover Together üíï</h2>
    <div class="card-container">
      <div id="swipeCard"></div>
      <div class="empty-state hidden" id="emptyDiscover">
        You're all caught up! Adjust interests or browse for more.
      </div>
    </div>
    <div class="swipe-buttons" id="swipeButtons">
      <button class="swipe-btn pass" onclick="passActivity()">‚úñ</button>
      <button class="swipe-btn like" onclick="likeActivity()">‚ù§Ô∏è</button>
    </div>
  </div>

  <!-- Tab: Browse -->
  <div class="content tab-content hidden" id="tab-browse">
    <h2 class="section-title">Browse All Ideas üîé</h2>
    <div class="filter-chips" id="browseFilters"></div>
    <div id="browseList"></div>
  </div>

  <!-- Tab: Saved -->
  <div class="content tab-content hidden" id="tab-saved">
    <h2 class="section-title">Saved Ideas ‚ù§Ô∏è</h2>
    <div id="savedList"></div>
  </div>

  <!-- Tab: Dates -->
  <div class="content tab-content hidden" id="tab-dates">
    <h2 class="section-title">Upcoming Dates</h2>
    <div id="upcomingDates"></div>
    <h2 class="section-title" style="margin-top:24px;">Past Dates</h2>
    <div id="pastDates"></div>
  </div>

  <!-- Tab: Plan -->
  <div class="content tab-content hidden" id="tab-plan">
    <div id="planSetup">
      <h2 class="section-title">Plan Your Date üìÖ</h2>
      <div class="plan-card">
        <label class="plan-label">Start Date & Time</label>
        <input type="datetime-local" class="plan-input" id="planDateTime">
        
        <label class="plan-label">How many parts?</label>
        <div class="part-count-row" id="partCountRow"></div>
        
        <label class="plan-label">Preview Your Date</label>
        <div id="partsPreview"></div>
        
        <button class="btn-full secondary" onclick="startPlanSelection()">Plan My Date ‚Üí</button>
      </div>
    </div>
    
    <div id="planSelecting" class="hidden">
      <div class="plan-header">
        <div class="plan-header-row">
          <button class="plan-back" onclick="planBack()">‚Üê</button>
          <div class="plan-header-center">
            <div class="plan-header-title" id="planStepTitle">Part 1 of 2</div>
            <div class="plan-header-subtitle" id="planStepType">Dinner</div>
          </div>
          <div style="width:24px;"></div>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" id="planProgress"></div>
        </div>
      </div>
      <div style="padding:16px;" id="planActivities"></div>
    </div>
    
    <div id="planComplete" class="hidden">
      <h2 class="complete-title">üéâ Your Date is Planned!</h2>
      <div id="completedItems"></div>
      <button class="btn-full secondary" onclick="finishPlan()">Done</button>
    </div>
  </div>

  <!-- Tab: Profile -->
  <div class="content tab-content hidden" id="tab-profile">
    <h2 class="section-title">Your Profile üë§</h2>
    <div class="profile-card">
      <p><strong>Name:</strong> <span id="profileName">Guest</span><span class="verified-badge hidden" id="profileVerifiedBadge">‚úì Verified</span></p>
      <p><strong>Email:</strong> <span id="profileEmail">-</span></p>
      <p><strong>Type:</strong> <span id="profileType">Guest</span></p>
      <p><strong>Location:</strong> New York, NY</p>
      <p style="margin-top:8px;"><strong>Stats:</strong> ‚ù§Ô∏è <span id="statLiked">0</span> liked ‚Ä¢ ‚úñ <span id="statPassed">0</span> passed</p>
      <p id="accountStatus" style="margin-top:8px;color:var(--success);font-size:13px;"></p>
    </div>
    
    <!-- Admin Panel (only visible to admins) -->
    <div id="adminSection" class="admin-section" style="display:none;">
      <h3>üëë Admin Panel</h3>
      <p style="font-size:13px;color:#856404;margin-bottom:12px;">Pending verification requests:</p>
      <div id="pendingVerifications">
        <p style="color:#888;font-size:13px;">No pending requests</p>
      </div>
    </div>
    
    <!-- Verification Section -->
    <div id="verificationSection" class="profile-card" style="display:none;">
      <h3 style="font-weight:700;margin-bottom:12px;">üõ°Ô∏è Verification Status</h3>
      <div id="notVerifiedBox">
        <p style="color:#888;font-size:14px;margin-bottom:12px;">Get verified to share your own photos and videos from your dates!</p>
        <button class="btn-full secondary" onclick="openVerifyModal()">Get Verified</button>
      </div>
      <div id="pendingVerifyBox" style="display:none;">
        <p style="color:#856404;font-size:14px;">‚è≥ Verification pending review (usually 24-48 hours)...</p>
      </div>
      <div id="verifiedBox" style="display:none;">
        <p style="color:#155724;font-size:14px;margin-bottom:12px;">‚úÖ You are verified!</p>
        <button class="btn-full secondary" onclick="openUploadModal()">üì∏ Upload Content</button>
      </div>
    </div>
    
    <h3 style="font-weight:700;margin-bottom:12px;">Interests</h3>
    <div class="filter-chips" id="interestChips"></div>
    
    <button class="btn-full primary" style="margin-top:24px;" onclick="resetProfile()">Reset Profile</button>
    <button class="btn-full logout-btn" id="logoutBtn" onclick="logout()">Log Out</button>
  </div>

  <!-- Bottom Nav -->
  <nav class="nav">
    <button class="nav-item" onclick="showTab('dates')">
      <span class="nav-icon">üìÖ</span>
      <span class="nav-label">Dates</span>
    </button>
    <button class="nav-item" onclick="showTab('browse')">
      <span class="nav-icon">üß≠</span>
      <span class="nav-label">Browse</span>
    </button>
    <button class="nav-item nav-center" onclick="showTab('discover')">
      <div class="nav-center-btn"><span>üéØ</span></div>
      <span class="nav-label" style="margin-top:4px;">Discover</span>
    </button>
    <button class="nav-item" onclick="showTab('saved')">
      <span class="nav-icon">‚ù§Ô∏è</span>
      <span class="nav-label">Saved</span>
    </button>
    <button class="nav-item" onclick="showTab('plan')">
      <span class="nav-icon">‚ú®</span>
      <span class="nav-label">Plan</span>
    </button>
  </nav>
</div>

<!-- Gallery Modal -->
<div class="modal" id="galleryModal">
  <div class="modal-content">
    <img class="modal-image" id="modalImage" src="" alt="">
    <button class="modal-close" onclick="closeModal()">‚úï</button>
    <div class="modal-nav" id="modalNav"></div>
  </div>
</div>

<!-- Verification Modal -->
<div class="verify-modal" id="verifyModal">
  <div class="verify-box">
    <h2>üõ°Ô∏è Get Verified</h2>
    <p>Verify your identity to upload your own date experiences and help others discover great places!</p>
    
    <div id="verifyPendingStatus" class="verify-status pending" style="display:none;">
      ‚è≥ Your verification is being reviewed. This usually takes 24-48 hours.
    </div>
    
    <div id="verifyApprovedStatus" class="verify-status verified" style="display:none;">
      ‚úÖ You are verified! You can now upload your own content.
    </div>
    
    <div id="verifyForm">
      <div class="verify-step">
        <div class="verify-step-title">
          <span class="verify-step-num">1</span>
          Upload Government ID
        </div>
        <div class="verify-upload-box" id="idUploadBox" onclick="document.getElementById('idInput').click()">
          <input type="file" id="idInput" accept="image/*" onchange="handleIdUpload(event)">
          <div class="verify-upload-icon">ü™™</div>
          <div class="verify-upload-text" id="idUploadText">Tap to upload State ID or Passport</div>
        </div>
      </div>
      
      <div class="verify-step">
        <div class="verify-step-title">
          <span class="verify-step-num">2</span>
          Take a Selfie
        </div>
        <div class="verify-camera-box">
          <video class="verify-video" id="verifyVideo" autoplay playsinline></video>
          <canvas class="verify-canvas" id="verifyCanvas"></canvas>
          <img class="verify-selfie-preview" id="selfiePreview" alt="Selfie">
          <div id="cameraButtons">
            <button class="verify-camera-btn" id="captureBtn" onclick="captureSelfie()">üì∏ Take Photo</button>
          </div>
          <div id="retakeButtons" style="display:none; text-align:center; padding:12px;">
            <button class="verify-camera-btn verify-retake" onclick="retakeSelfie()">‚Ü©Ô∏è Retake</button>
          </div>
        </div>
      </div>
      
      <button class="btn-full secondary" id="submitVerifyBtn" onclick="submitVerification()" disabled>Submit for Verification</button>
    </div>
    
    <button class="btn-full" style="background:#eee;color:#666;margin-top:12px;" onclick="closeVerifyModal()">Close</button>
  </div>
</div>

<!-- Upload Content Modal -->
<div class="upload-modal" id="uploadModal">
  <div class="upload-box">
    <h2>üì∏ Share Your Experience</h2>
    <p>Upload photos or videos from your date to help others discover great places!</p>
    
    <button class="upload-file-btn" id="contentUploadBtn" onclick="document.getElementById('contentInput').click()">
      <input type="file" id="contentInput" accept="image/*,video/*" onchange="handleContentUpload(event)">
      <div class="verify-upload-icon">üì∑</div>
      <div class="verify-upload-text" id="contentUploadText">Tap to select photo or video</div>
    </button>
    
    <div style="display:flex;gap:8px;margin-bottom:16px;">
      <button class="btn-full" style="background:#eee;color:#333;margin:0;flex:1;" onclick="document.getElementById('cameraInput').click()">
        üì∏ Take Photo
        <input type="file" id="cameraInput" accept="image/*" capture="environment" onchange="handleContentUpload(event)" style="display:none;">
      </button>
      <button class="btn-full" style="background:#eee;color:#333;margin:0;flex:1;" onclick="document.getElementById('libraryInput').click()">
        üñºÔ∏è Photo Library
        <input type="file" id="libraryInput" accept="image/*,video/*" onchange="handleContentUpload(event)" style="display:none;">
      </button>
    </div>
    
    <img class="upload-preview" id="uploadPreview" alt="Preview">
    <video class="upload-video-preview" id="uploadVideoPreview" controls></video>
    
    <div class="upload-input-group">
      <label>Select Place</label>
      <select id="uploadPlace">
        <option value="">Choose a place...</option>
      </select>
    </div>
    
    <div class="upload-input-group">
      <label>Caption</label>
      <textarea id="uploadCaption" placeholder="Share your experience..."></textarea>
    </div>
    
    <button class="btn-full secondary" id="submitContentBtn" onclick="submitContent()" disabled>Post</button>
    <button class="btn-full" style="background:#eee;color:#666;margin-top:12px;" onclick="closeUploadModal()">Cancel</button>
  </div>
</div>

<!-- Side Menu Overlay -->
<div class="side-menu-overlay" id="sideMenuOverlay" onclick="closeSideMenu()"></div>

<!-- Side Menu -->
<div class="side-menu" id="sideMenu">
  <div class="side-menu-header">
    <h2>üíï Our Date Night</h2>
    <p>Plan the perfect date</p>
  </div>
  <div class="side-menu-items">
    <div class="side-menu-item" onclick="openPaymentModal()">
      <span class="side-menu-item-icon">üí≥</span>
      <span class="side-menu-item-text">Payments</span>
    </div>
    <div class="side-menu-divider"></div>
    <a class="side-menu-item" href="https://www.tiktok.com/@eatwhiletraveling" target="_blank">
      <span class="side-menu-item-icon">üì±</span>
      <span class="side-menu-item-text">Contact Us</span>
    </a>
  </div>
</div>

<!-- Payment Modal -->
<div class="payment-modal" id="paymentModal">
  <div class="payment-box">
    <h2>üí≥ Payment Methods</h2>
    <p>Manage your saved payment methods</p>
    
    <div class="saved-cards" id="savedCards">
      <div class="no-cards" id="noCardsMessage">
        <p>No payment methods saved yet</p>
      </div>
    </div>
    
    <h3 style="font-weight:600;margin-bottom:16px;">Add New Card</h3>
    
    <div class="payment-form-group">
      <label>Card Number</label>
      <input type="text" id="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19" oninput="formatCardNumber(this)">
    </div>
    
    <div class="payment-form-group">
      <label>Cardholder Name</label>
      <input type="text" id="cardName" placeholder="John Doe">
    </div>
    
    <div class="payment-form-row">
      <div class="payment-form-group">
        <label>Expiry</label>
        <input type="text" id="cardExpiry" placeholder="MM/YY" maxlength="5" oninput="formatExpiry(this)">
      </div>
      <div class="payment-form-group">
        <label>CVV</label>
        <input type="text" id="cardCvv" placeholder="123" maxlength="4">
      </div>
    </div>
    
    <button class="btn-full secondary" onclick="savePaymentMethod()">Save Card</button>
    <button class="btn-full" style="background:#eee;color:#666;margin-top:12px;" onclick="closePaymentModal()">Close</button>
  </div>
</div>

<script>
// ============ SUPABASE SETUP ============
const SUPABASE_URL = 'https://yvobrmkvtpvrldpewrma.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl2b2JybWt2dHB2cmxkcGV3cm1hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2NzUxMTksImV4cCI6MjA4MzI1MTExOX0.9TFhi_qL2VDx4691bR225KCYuOZqWRd5t5PWI3w2J9M';

const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ============ DATA ============
const NYC_ACTIVITIES = [
  { id: 'dining-0', title: "Katz's Delicatessen", category: 'Dining', description: "Iconic NYC deli famous for pastrami sandwiches since 1888.", price: '$$', rating: 4.6, reviewCount: 8234, distance: 'NYC', address: 'Lower East Side, NY', tags: ['restaurants'], media: ['https://images.unsplash.com/photo-1553909489-cd47e0907980?w=800', 'https://images.unsplash.com/photo-1619096252214-ef06c45683e3?w=800', 'https://images.unsplash.com/photo-1555939594-58d7cb561ad1?w=800'] },
  { id: 'dining-1', title: "Joe's Pizza", category: 'Dining', description: "Classic NY slice joint, serving perfect pizza since 1975.", price: '$', rating: 4.7, reviewCount: 5621, distance: 'NYC', address: 'Greenwich Village, NY', tags: ['restaurants'], media: ['https://images.unsplash.com/photo-1513104890138-7c749659a591?w=800', 'https://images.unsplash.com/photo-1574071318508-1cdbab80d002?w=800'] },
  { id: 'dining-2', title: 'Carbone', category: 'Dining', description: "Upscale Italian-American with old-school charm.", price: '$$$', rating: 4.8, reviewCount: 3456, distance: 'NYC', address: 'Greenwich Village, NY', tags: ['restaurants'], media: ['https://images.unsplash.com/photo-1555992336-fb0d29498b13?w=800', 'https://images.unsplash.com/photo-1551218372-a8789b81b253?w=800'] },
  { id: 'dining-3', title: 'Peter Luger Steak House', category: 'Dining', description: "Legendary Brooklyn steakhouse since 1887.", price: '$$$', rating: 4.7, reviewCount: 9821, distance: 'NYC', address: 'Williamsburg, Brooklyn', tags: ['restaurants'], media: ['https://images.unsplash.com/photo-1546833999-b9f581a1996d?w=800', 'https://images.unsplash.com/photo-1558030006-450675393462?w=800'] },
  { id: 'dining-4', title: 'Le Bernardin', category: 'Dining', description: "Three Michelin-starred seafood temple.", price: '$$$$', rating: 4.9, reviewCount: 2134, distance: 'NYC', address: 'Midtown, NY', tags: ['restaurants'], media: ['https://images.unsplash.com/photo-1559339352-11d035aa65de?w=800', 'https://images.unsplash.com/photo-1580554530778-ca36943938b2?w=800'] },
  { id: 'movies-0', title: 'AMC Empire 25', category: 'Movie Theater', description: "Massive Times Square multiplex with IMAX.", price: '$$', rating: 4.5, reviewCount: 8901, distance: 'NYC', address: 'Times Square, NY', tags: ['movies'], media: ['https://images.unsplash.com/photo-1489599849927-2ee91cede3ba?w=800', 'https://images.unsplash.com/photo-1517604931442-7e0c8ed2963c?w=800'] },
  { id: 'movies-1', title: 'Nitehawk Cinema', category: 'Movie Theater', description: "Dine-in theater serving food and cocktails.", price: '$$', rating: 4.6, reviewCount: 4567, distance: 'NYC', address: 'Williamsburg, Brooklyn', tags: ['movies'], media: ['https://images.unsplash.com/photo-1594909122845-11baa439b7bf?w=800', 'https://images.unsplash.com/photo-1489599849927-2ee91cede3ba?w=800'] },
  { id: 'outdoor-0', title: 'Central Park Boathouse', category: 'Outdoor', description: "Romantic rowboat rentals on Central Park Lake.", price: '$$', rating: 4.7, reviewCount: 7890, distance: 'NYC', address: 'Central Park, NY', tags: ['outdoor'], media: ['https://images.unsplash.com/photo-1568515387631-8b650bbcdb90?w=800', 'https://images.unsplash.com/photo-1534430458160-e5945e863c0c?w=800'] },
  { id: 'outdoor-1', title: 'Brooklyn Bridge Park', category: 'Outdoor', description: "Stunning waterfront views of Manhattan.", price: '$', rating: 4.8, reviewCount: 12345, distance: 'NYC', address: 'Brooklyn, NY', tags: ['outdoor'], media: ['https://images.unsplash.com/photo-1514565131-fce0801e5785?w=800', 'https://images.unsplash.com/photo-1518391846015-55a9cc003b25?w=800'] },
  { id: 'outdoor-2', title: 'The High Line', category: 'Outdoor', description: "Elevated park with gardens and art.", price: '$', rating: 4.7, reviewCount: 15678, distance: 'NYC', address: 'Chelsea, NY', tags: ['outdoor'], media: ['https://images.unsplash.com/photo-1555109307-f7d9da25c244?w=800', 'https://images.unsplash.com/photo-1565094052366-dd58cd3eaf6e?w=800'] },
  { id: 'arts-0', title: 'The Met Museum', category: 'Arts & Culture', description: "World-class museum with 2 million works.", price: '$$', rating: 4.8, reviewCount: 25678, distance: 'NYC', address: 'Upper East Side, NY', tags: ['arts'], media: ['https://images.unsplash.com/photo-1564399579883-451a5d44ec08?w=800', 'https://images.unsplash.com/photo-1566127444979-b3d2b64977e9?w=800'] },
  { id: 'arts-1', title: 'MoMA', category: 'Arts & Culture', description: "Iconic modern and contemporary art.", price: '$$', rating: 4.7, reviewCount: 18901, distance: 'NYC', address: 'Midtown, NY', tags: ['arts'], media: ['https://images.unsplash.com/photo-1564399580075-5dfe19c205f3?w=800', 'https://images.unsplash.com/photo-1577083553936-205ff5d3e44f?w=800'] },
  { id: 'nightlife-0', title: 'Press Lounge Rooftop', category: 'Nightlife', description: "Elegant rooftop bar with Hudson views.", price: '$$$', rating: 4.6, reviewCount: 5678, distance: 'NYC', address: "Hell's Kitchen, NY", tags: ['nightlife'], media: ['https://images.unsplash.com/photo-1514933651103-005eec06c04b?w=800', 'https://images.unsplash.com/photo-1566417713940-fe7c737a9ef2?w=800'] },
  { id: 'nightlife-1', title: 'The Dead Rabbit', category: 'Nightlife', description: "Award-winning Irish pub with cocktails.", price: '$$', rating: 4.7, reviewCount: 9876, distance: 'NYC', address: 'Financial District, NY', tags: ['nightlife'], media: ['https://images.unsplash.com/photo-1572116469696-31de0f17cc34?w=800', 'https://images.unsplash.com/photo-1546171753-97d7676e4602?w=800'] },
  { id: 'shopping-0', title: 'SoHo Boutiques', category: 'Shopping', description: "Trendy boutiques in cobblestone SoHo.", price: '$$$', rating: 4.5, reviewCount: 9876, distance: 'NYC', address: 'SoHo, NY', tags: ['shopping'], media: ['https://images.unsplash.com/photo-1441986300917-64674bd600d8?w=800', 'https://images.unsplash.com/photo-1483985988355-763728e1935b?w=800'] },
  { id: 'wellness-0', title: 'Aire Ancient Baths', category: 'Wellness', description: "Luxurious thermal baths in TriBeCa.", price: '$$$', rating: 4.8, reviewCount: 6234, distance: 'NYC', address: 'TriBeCa, NY', tags: ['wellness'], media: ['https://images.unsplash.com/photo-1544161515-4ab6ce6db874?w=800', 'https://images.unsplash.com/photo-1540555700478-4be289fbecef?w=800'] },
];

const ALL_INTERESTS = [
  { key: 'restaurants', label: 'üçΩÔ∏è Dining' },
  { key: 'movies', label: 'üé¨ Movies' },
  { key: 'outdoor', label: 'üèÉ Outdoor' },
  { key: 'arts', label: 'üé® Arts' },
  { key: 'nightlife', label: 'üåÉ Nightlife' },
  { key: 'shopping', label: 'üõçÔ∏è Shopping' },
  { key: 'wellness', label: 'üßò Wellness' },
];

const PART_TYPES = ['Coffee', 'Lunch', 'Dinner', 'Movie', 'Activity', 'Drinks'];

// ============ STATE ============
let isLoggedIn = false;
let isSignUpMode = false;
let isGuestMode = false;
let currentUser = null;
let userProfile = null;
let cameraStream = null;

// Local state for UI
let state = {
  interests: ['restaurants', 'nightlife', 'arts'],
  savedItems: [],
  swipedIds: [],
  dates: [],
  stats: { liked: 0, passed: 0 },
  browseFilters: [],
  currentTab: 'discover',
  planDate: '',
  numParts: 2,
  parts: ['Dinner', 'Activity', null, null],
  planStep: 'setup',
  currentPartIndex: 0,
  selectedPlanItems: [null, null, null, null],
  modalMedia: [],
  modalIndex: 0,
  verificationStatus: 'none',
  verificationData: { idImage: null, selfieImage: null }
};

let userGeneratedContent = [];

// ============ HELPERS ============
function formatDateTime(d) {
  return new Date(d).toLocaleString('en-US', { weekday: 'short', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
}

function getTagForPart(part) {
  if (['Coffee', 'Lunch', 'Dinner'].includes(part)) return 'restaurants';
  if (part === 'Movie') return 'movies';
  if (part === 'Activity') return 'outdoor';
  if (part === 'Drinks') return 'nightlife';
  return null;
}

function hideLoading() {
  document.getElementById('loadingOverlay').classList.add('hidden');
}

function showLoading() {
  document.getElementById('loadingOverlay').classList.remove('hidden');
}

// ============ SUPABASE DATA FUNCTIONS ============
async function loadUserProfile() {
  if (!currentUser) return null;
  
  const { data, error } = await db
    .from('profiles')
    .select('*')
    .eq('id', currentUser.id)
    .single();
  
  if (error && error.code === 'PGRST116') {
    // Profile doesn't exist, create it
    const { data: newProfile, error: createError } = await db
      .from('profiles')
      .insert({
        id: currentUser.id,
        email: currentUser.email,
        name: currentUser.user_metadata?.name || currentUser.email.split('@')[0]
      })
      .select()
      .single();
    
    if (createError) console.error('Error creating profile:', createError);
    return newProfile;
  }
  
  return data;
}

async function updateUserProfile(updates) {
  if (!currentUser) return;
  
  const { error } = await db
    .from('profiles')
    .update(updates)
    .eq('id', currentUser.id);
  
  if (error) console.error('Error updating profile:', error);
}

async function loadSavedItems() {
  if (!currentUser) return [];
  
  const { data, error } = await db
    .from('saved_items')
    .select('activity_id')
    .eq('user_id', currentUser.id);
  
  if (error) {
    console.error('Error loading saved items:', error);
    return [];
  }
  
  return data.map(item => {
    const activity = NYC_ACTIVITIES.find(a => a.id === item.activity_id);
    return activity;
  }).filter(Boolean);
}

async function loadSwipedItems() {
  if (!currentUser) return [];
  
  const { data, error } = await db
    .from('swiped_items')
    .select('activity_id')
    .eq('user_id', currentUser.id);
  
  if (error) {
    console.error('Error loading swiped items:', error);
    return [];
  }
  
  return data.map(item => item.activity_id);
}

async function loadPlannedDates() {
  if (!currentUser) return [];
  
  const { data, error } = await db
    .from('planned_dates')
    .select('*')
    .eq('user_id', currentUser.id)
    .order('datetime', { ascending: true });
  
  if (error) {
    console.error('Error loading dates:', error);
    return [];
  }
  
  return data;
}

async function loadUserContent() {
  try {
    const { data, error } = await db
      .from('user_content')
      .select('*')
      .order('created_at', { ascending: false })
      .limit(50);
    
    if (error) {
      console.error('Error loading user content:', error);
      return [];
    }
    
    return data || [];
  } catch (err) {
    console.error('loadUserContent error:', err);
    return [];
  }
}

async function saveSwipedItem(activityId, action) {
  if (!currentUser) return;
  
  const { error } = await db
    .from('swiped_items')
    .insert({
      user_id: currentUser.id,
      activity_id: activityId,
      action: action
    });
  
  if (error) console.error('Error saving swipe:', error);
}

async function saveSavedItem(activityId) {
  if (!currentUser) return;
  
  const { error } = await db
    .from('saved_items')
    .insert({
      user_id: currentUser.id,
      activity_id: activityId
    });
  
  if (error && error.code !== '23505') console.error('Error saving item:', error);
}

async function removeSavedItem(activityId) {
  if (!currentUser) return;
  
  const { error } = await db
    .from('saved_items')
    .delete()
    .eq('user_id', currentUser.id)
    .eq('activity_id', activityId);
  
  if (error) console.error('Error removing saved item:', error);
}

async function savePlannedDate(dateData) {
  if (!currentUser) return;
  
  const { error } = await db
    .from('planned_dates')
    .insert({
      user_id: currentUser.id,
      title: dateData.title,
      datetime: dateData.datetime,
      status: dateData.status,
      activities: dateData.activities
    });
  
  if (error) console.error('Error saving date:', error);
}

async function removePlannedDate(dateId) {
  if (!currentUser) return;
  
  const { error } = await db
    .from('planned_dates')
    .delete()
    .eq('id', dateId)
    .eq('user_id', currentUser.id);
  
  if (error) console.error('Error removing date:', error);
}

// ============ AUTH FUNCTIONS ============
async function checkSession() {
  try {
    const { data: { session }, error } = await db.auth.getSession();
    
    if (error) {
      console.error('Session error:', error);
      hideLoading();
      document.getElementById('welcome').classList.remove('hidden');
      return;
    }
    
    if (session) {
      currentUser = session.user;
      isLoggedIn = true;
      isGuestMode = false;
      
      // Load user data with error handling
      try {
        userProfile = await loadUserProfile();
        state.savedItems = await loadSavedItems();
        state.swipedIds = await loadSwipedItems();
        state.dates = await loadPlannedDates();
        userGeneratedContent = await loadUserContent();
      } catch (loadError) {
        console.error('Error loading user data:', loadError);
      }
      
      if (userProfile) {
        state.interests = userProfile.interests || ['restaurants', 'nightlife', 'arts'];
        state.stats.liked = userProfile.stats_liked || 0;
        state.stats.passed = userProfile.stats_passed || 0;
        state.verificationStatus = userProfile.verification_status || 'none';
        
        if (userProfile.profile_type) {
          document.getElementById('app').classList.add('active');
          updateUIForLoggedInUser();
          initApp();
        } else {
          document.getElementById('onboarding').classList.add('active');
          document.getElementById('userGreeting').textContent = `Welcome, ${userProfile.name}!`;
        }
      } else {
        document.getElementById('onboarding').classList.add('active');
        document.getElementById('userGreeting').textContent = `Welcome!`;
      }
    } else {
      // Load user content for guests too
      try {
        userGeneratedContent = await loadUserContent();
      } catch (e) {
        console.error('Error loading content:', e);
      }
      
      document.getElementById('welcome').classList.remove('hidden');
    }
  } catch (err) {
    console.error('checkSession error:', err);
    document.getElementById('welcome').classList.remove('hidden');
  }
  
  hideLoading();
}

function showLoginModal() {
  document.getElementById('loginModal').classList.add('active');
  isSignUpMode = false;
  updateLoginModal();
}

function closeLoginModal() {
  document.getElementById('loginModal').classList.remove('active');
  document.getElementById('loginError').classList.remove('show');
  document.getElementById('loginSuccess').classList.remove('show');
  document.getElementById('loginEmail').value = '';
  document.getElementById('loginPassword').value = '';
  document.getElementById('loginName').value = '';
}

function toggleLoginMode() {
  isSignUpMode = !isSignUpMode;
  updateLoginModal();
}

function updateLoginModal() {
  const title = document.getElementById('loginTitle');
  const subtitle = document.getElementById('loginSubtitle');
  const nameInput = document.getElementById('loginName');
  const submitBtn = document.getElementById('loginSubmit');
  const switchText = document.getElementById('switchText');
  const switchLink = document.getElementById('switchLink');
  
  document.getElementById('loginError').classList.remove('show');
  document.getElementById('loginSuccess').classList.remove('show');
  
  if (isSignUpMode) {
    title.textContent = 'Create Account';
    subtitle.textContent = 'Sign up to save your date plans';
    nameInput.classList.remove('hidden');
    submitBtn.textContent = 'Sign Up';
    switchText.textContent = 'Already have an account?';
    switchLink.textContent = 'Log In';
  } else {
    title.textContent = 'Welcome Back';
    subtitle.textContent = 'Log in to save your date plans';
    nameInput.classList.add('hidden');
    submitBtn.textContent = 'Log In';
    switchText.textContent = "Don't have an account?";
    switchLink.textContent = 'Sign Up';
  }
}

async function handleLogin() {
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;
  const name = document.getElementById('loginName').value.trim();
  const errorEl = document.getElementById('loginError');
  const successEl = document.getElementById('loginSuccess');
  const submitBtn = document.getElementById('loginSubmit');
  
  errorEl.classList.remove('show');
  successEl.classList.remove('show');
  
  if (!email || !password) {
    errorEl.textContent = 'Please fill in all fields';
    errorEl.classList.add('show');
    return;
  }
  
  if (!email.includes('@')) {
    errorEl.textContent = 'Please enter a valid email';
    errorEl.classList.add('show');
    return;
  }
  
  submitBtn.disabled = true;
  submitBtn.textContent = isSignUpMode ? 'Signing up...' : 'Logging in...';
  
  try {
    if (isSignUpMode) {
      // Sign Up
      if (!name) {
        errorEl.textContent = 'Please enter your name';
        errorEl.classList.add('show');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Sign Up';
        return;
      }
      
      const { data, error } = await db.auth.signUp({
        email,
        password,
        options: {
          data: { name }
        }
      });
      
      if (error) {
        errorEl.textContent = error.message;
        errorEl.classList.add('show');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Sign Up';
        return;
      }
      
      if (data.user && !data.session) {
        // Email confirmation required
        successEl.textContent = 'Check your email for the confirmation link!';
        successEl.classList.add('show');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Sign Up';
      } else if (data.session) {
        // Auto-confirmed, proceed
        currentUser = data.user;
        isLoggedIn = true;
        isGuestMode = false;
        closeLoginModal();
        
        userProfile = await loadUserProfile();
        userGeneratedContent = await loadUserContent();
        
        document.getElementById('welcome').classList.add('hidden');
        document.getElementById('onboarding').classList.add('active');
        document.getElementById('userGreeting').textContent = `Welcome, ${name}!`;
      }
      
    } else {
      // Log In
      const { data, error } = await db.auth.signInWithPassword({
        email,
        password
      });
      
      if (error) {
        errorEl.textContent = error.message;
        errorEl.classList.add('show');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Log In';
        return;
      }
      
      currentUser = data.user;
      isLoggedIn = true;
      isGuestMode = false;
      closeLoginModal();
      
      // Load user data
      userProfile = await loadUserProfile();
      state.savedItems = await loadSavedItems();
      state.swipedIds = await loadSwipedItems();
      state.dates = await loadPlannedDates();
      userGeneratedContent = await loadUserContent();
      
      if (userProfile) {
        state.interests = userProfile.interests || ['restaurants', 'nightlife', 'arts'];
        state.stats.liked = userProfile.stats_liked || 0;
        state.stats.passed = userProfile.stats_passed || 0;
        state.verificationStatus = userProfile.verification_status || 'none';
        
        document.getElementById('welcome').classList.add('hidden');
        
        if (userProfile.profile_type) {
          document.getElementById('app').classList.add('active');
          updateUIForLoggedInUser();
          initApp();
        } else {
          document.getElementById('onboarding').classList.add('active');
          document.getElementById('userGreeting').textContent = `Welcome back, ${userProfile.name}!`;
        }
      }
    }
  } catch (err) {
    errorEl.textContent = 'An error occurred. Please try again.';
    errorEl.classList.add('show');
    submitBtn.disabled = false;
    submitBtn.textContent = isSignUpMode ? 'Sign Up' : 'Log In';
  }
}

async function continueAsGuest() {
  isLoggedIn = false;
  isGuestMode = true;
  currentUser = null;
  
  state = {
    interests: ['restaurants', 'nightlife', 'arts'],
    savedItems: [],
    swipedIds: [],
    dates: [],
    stats: { liked: 0, passed: 0 },
    browseFilters: [],
    currentTab: 'discover',
    planDate: '',
    numParts: 2,
    parts: ['Dinner', 'Activity', null, null],
    planStep: 'setup',
    currentPartIndex: 0,
    selectedPlanItems: [null, null, null, null],
    modalMedia: [],
    modalIndex: 0,
    verificationStatus: 'none',
    verificationData: { idImage: null, selfieImage: null }
  };
  
  userGeneratedContent = await loadUserContent();
  
  document.getElementById('welcome').classList.add('hidden');
  document.getElementById('onboarding').classList.add('active');
  document.getElementById('userGreeting').textContent = 'Guest Mode - your data won\'t be saved';
}

async function selectProfile(type) {
  if (isLoggedIn && userProfile) {
    await updateUserProfile({ profile_type: type });
    userProfile.profile_type = type;
  }
  
  document.getElementById('onboarding').classList.remove('active');
  document.getElementById('app').classList.add('active');
  updateUIForLoggedInUser();
  initApp();
}

function updateUIForLoggedInUser() {
  const profileType = userProfile?.profile_type || 'Guest';
  document.getElementById('headerType').textContent = profileType;
  document.getElementById('profileType').textContent = profileType;
  
  if (isLoggedIn && userProfile) {
    document.getElementById('loggedInBadge').classList.remove('hidden');
    document.getElementById('profileName').textContent = userProfile.name || 'User';
    document.getElementById('profileEmail').textContent = userProfile.email;
    document.getElementById('accountStatus').textContent = '‚úì Your data is synced across all devices';
    document.getElementById('logoutBtn').style.display = 'block';
    document.getElementById('verificationSection').style.display = 'block';
  } else {
    document.getElementById('loggedInBadge').classList.add('hidden');
    document.getElementById('profileName').textContent = 'Guest';
    document.getElementById('profileEmail').textContent = '-';
    document.getElementById('accountStatus').textContent = '‚ö†Ô∏è Guest mode - data won\'t be saved';
    document.getElementById('logoutBtn').style.display = 'none';
    document.getElementById('verificationSection').style.display = 'none';
  }
  
  updateProfileVerificationUI();
}

async function logout() {
  if (confirm('Are you sure you want to log out?')) {
    await db.auth.signOut();
    isLoggedIn = false;
    currentUser = null;
    userProfile = null;
    location.reload();
  }
}

// ============ DISCOVER ============
function getDiscoverPool() {
  const userContent = userGeneratedContent
    .filter(c => !state.swipedIds.includes('user-' + c.id))
    .map(c => ({
      id: 'user-' + c.id,
      title: c.place_name,
      category: c.place_category,
      description: c.caption || `Shared by ${c.user_name}`,
      price: NYC_ACTIVITIES.find(a => a.id === c.place_id)?.price || '$$',
      rating: NYC_ACTIVITIES.find(a => a.id === c.place_id)?.rating || 4.5,
      reviewCount: NYC_ACTIVITIES.find(a => a.id === c.place_id)?.reviewCount || 0,
      distance: 'NYC',
      address: c.place_address,
      tags: NYC_ACTIVITIES.find(a => a.id === c.place_id)?.tags || [],
      media: [c.media_url],
      mediaType: c.media_type,
      isUserContent: true,
      userName: c.user_name,
      userVerified: c.user_verified,
      createdAt: c.created_at
    }));
  
  const regularActivities = NYC_ACTIVITIES
    .filter(item => state.interests.length === 0 || item.tags.some(t => state.interests.includes(t)))
    .filter(item => !state.swipedIds.includes(item.id));
  
  return [...userContent, ...regularActivities];
}

function renderDiscover() {
  const pool = getDiscoverPool();
  const card = document.getElementById('swipeCard');
  const empty = document.getElementById('emptyDiscover');
  const btns = document.getElementById('swipeButtons');
  
  if (pool.length === 0) {
    card.innerHTML = '';
    empty.classList.remove('hidden');
    btns.classList.add('hidden');
  } else {
    empty.classList.add('hidden');
    btns.classList.remove('hidden');
    const item = pool[0];
    
    const userBadge = item.isUserContent ? `
      <div class="user-content-badge">
        <span>üì∏</span> ${item.userName} ${item.userVerified ? '<span class="verified-check">‚úì</span>' : ''}
      </div>
    ` : '';
    
    const userInfo = item.isUserContent ? `
      <div class="card-user-info">
        <div style="width:32px;height:32px;border-radius:50%;background:var(--secondary);display:flex;align-items:center;justify-content:center;color:white;font-size:14px;">
          ${item.userName.charAt(0).toUpperCase()}
        </div>
        <span class="card-user-name">${item.userName}</span>
        ${item.userVerified ? '<span class="card-user-verified">‚úì Verified</span>' : ''}
      </div>
    ` : '';
    
    const mediaContent = item.mediaType === 'video' ? `
      <video class="card-image" src="${item.media[0]}" autoplay loop muted playsinline></video>
    ` : `
      <img class="card-image" src="${item.media[0]}" alt="${item.title}" id="cardImage">
    `;
    
    card.innerHTML = `
      <div class="swipe-card" id="currentCard">
        <div class="card-image-wrapper">
          ${mediaContent}
          ${userBadge}
          <button class="card-gallery-btn" onclick="openGallery('${item.id}')">üì∑ ${item.media.length}</button>
          ${!item.isUserContent && item.media.length > 1 ? `
          <div class="card-dots">
            ${item.media.map((_, i) => `<div class="card-dot ${i === 0 ? 'active' : ''}" onclick="changeCardImage(${i})"></div>`).join('')}
          </div>
          ` : ''}
        </div>
        <div class="card-body">
          ${userInfo}
          <div class="card-header">
            <h3 class="card-title">${item.title}</h3>
            <span class="card-price">${item.price}</span>
          </div>
          <div class="card-meta">
            <span>‚≠ê ${item.rating}</span>
            ${item.reviewCount ? `<span>‚Ä¢ ${item.reviewCount} reviews</span>` : ''}
            <span>‚Ä¢ ${item.distance}</span>
          </div>
          <p class="card-desc">${item.description}</p>
          <p class="card-address">üìç ${item.address}</p>
        </div>
      </div>
    `;
  }
}

let cardImageIndex = 0;
function changeCardImage(idx) {
  const pool = getDiscoverPool();
  if (pool.length === 0) return;
  cardImageIndex = idx;
  document.getElementById('cardImage').src = pool[0].media[idx];
  document.querySelectorAll('.card-dot').forEach((d, i) => d.classList.toggle('active', i === idx));
}

async function likeActivity() {
  const pool = getDiscoverPool();
  if (pool.length === 0) return;
  const item = pool[0];
  
  state.swipedIds.push(item.id);
  state.stats.liked++;
  
  if (!item.isUserContent && !state.savedItems.find(i => i.id === item.id)) {
    state.savedItems.push(item);
    if (isLoggedIn) {
      await saveSavedItem(item.id);
    }
  }
  
  if (isLoggedIn) {
    await saveSwipedItem(item.id, 'like');
    await updateUserProfile({ stats_liked: state.stats.liked });
  }
  
  cardImageIndex = 0;
  renderDiscover();
}

async function passActivity() {
  const pool = getDiscoverPool();
  if (pool.length === 0) return;
  
  state.swipedIds.push(pool[0].id);
  state.stats.passed++;
  
  if (isLoggedIn) {
    await saveSwipedItem(pool[0].id, 'pass');
    await updateUserProfile({ stats_passed: state.stats.passed });
  }
  
  cardImageIndex = 0;
  renderDiscover();
}

// ============ TABS ============
function showTab(tab) {
  state.currentTab = tab;
  document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
  document.getElementById('tab-' + tab).classList.remove('hidden');
  document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
  event.currentTarget.classList.add('active');
  
  if (tab === 'discover') renderDiscover();
  if (tab === 'browse') renderBrowse();
  if (tab === 'saved') renderSaved();
  if (tab === 'dates') renderDates();
  if (tab === 'plan') renderPlan();
  if (tab === 'profile') renderProfile();
}

// ============ BROWSE ============
function renderBrowse() {
  const filtersEl = document.getElementById('browseFilters');
  filtersEl.innerHTML = ALL_INTERESTS.map(i => `
    <button class="filter-chip ${state.browseFilters.includes(i.key) ? 'active' : ''}" onclick="toggleBrowseFilter('${i.key}')">${i.label}</button>
  `).join('');
  
  let items = NYC_ACTIVITIES;
  if (state.browseFilters.length > 0) {
    items = items.filter(item => item.tags.some(t => state.browseFilters.includes(t)));
  }
  
  document.getElementById('browseList').innerHTML = items.map(item => `
    <div class="list-item">
      <img class="list-image" src="${item.media[0]}" alt="${item.title}" onclick="openGallery('${item.id}')">
      <div class="list-content">
        <div class="list-title">${item.title}</div>
        <div class="list-meta">${item.category} ‚Ä¢ ${item.price} ‚Ä¢ ${item.distance}</div>
        <div class="list-rating">‚≠ê ${item.rating}</div>
        <div class="list-actions">
          <button class="btn-small btn-success" onclick="openBooking('${item.title}')">Book</button>
          <button class="btn-small btn-primary" onclick="saveItem('${item.id}')">Save</button>
        </div>
      </div>
    </div>
  `).join('');
}

function toggleBrowseFilter(key) {
  if (state.browseFilters.includes(key)) {
    state.browseFilters = state.browseFilters.filter(k => k !== key);
  } else {
    state.browseFilters.push(key);
  }
  renderBrowse();
}

async function saveItem(id) {
  const item = NYC_ACTIVITIES.find(i => i.id === id);
  if (item && !state.savedItems.find(i => i.id === id)) {
    state.savedItems.push(item);
    if (isLoggedIn) {
      await saveSavedItem(id);
    }
    alert('Saved to your favorites!');
  }
}

function openBooking(title) {
  const slug = title.toLowerCase().replace(/[^a-z0-9]+/g, '-');
  window.open('https://www.opentable.com/r/' + slug, '_blank');
}

// ============ SAVED ============
function renderSaved() {
  const list = document.getElementById('savedList');
  if (state.savedItems.length === 0) {
    list.innerHTML = '<p style="color:#888;">You haven\'t saved anything yet.</p>';
    return;
  }
  list.innerHTML = state.savedItems.map(item => `
    <div class="list-item">
      <img class="list-image" src="${item.media[0]}" alt="${item.title}" onclick="openGallery('${item.id}')">
      <div class="list-content">
        <div class="list-title">${item.title}</div>
        <div class="list-meta">${item.category} ‚Ä¢ ${item.price}</div>
        <div class="list-actions">
          <button class="btn-small btn-success" onclick="openBooking('${item.title}')">Book</button>
          <button class="btn-small btn-primary" onclick="removeItem('${item.id}')">Remove</button>
        </div>
      </div>
    </div>
  `).join('');
}

async function removeItem(id) {
  state.savedItems = state.savedItems.filter(i => i.id !== id);
  if (isLoggedIn) {
    await removeSavedItem(id);
  }
  renderSaved();
}

// ============ DATES ============
function renderDates() {
  const upcoming = state.dates.filter(d => d.status === 'upcoming');
  const past = state.dates.filter(d => d.status === 'past');
  
  document.getElementById('upcomingDates').innerHTML = upcoming.length === 0 
    ? '<p style="color:#888;">No upcoming dates yet.</p>'
    : upcoming.map(d => `
      <div class="date-card">
        <div class="date-title">${d.title}</div>
        <div class="date-time">${formatDateTime(d.datetime)}</div>
        <div class="date-activities">${(d.activities || []).join(' ‚Ä¢ ')}</div>
        <button class="btn-small btn-gray" style="margin-top:8px;" onclick="removeDate(${d.id})">Remove</button>
      </div>
    `).join('');
    
  document.getElementById('pastDates').innerHTML = past.length === 0
    ? '<p style="color:#888;">Your date history will appear here.</p>'
    : past.map(d => `
      <div class="date-card" style="opacity:0.8;">
        <div class="date-title">${d.title}</div>
        <div class="date-time">${formatDateTime(d.datetime)}</div>
      </div>
    `).join('');
}

async function removeDate(id) {
  state.dates = state.dates.filter(d => d.id !== id);
  if (isLoggedIn) {
    await removePlannedDate(id);
  }
  renderDates();
}

// ============ PLAN ============
function renderPlan() {
  if (!state.planDate) {
    const now = new Date();
    now.setHours(19, 0, 0, 0);
    document.getElementById('planDateTime').value = now.toISOString().slice(0, 16);
  }
  
  document.getElementById('partCountRow').innerHTML = [1,2,3,4].map(n => `
    <button class="part-count-btn ${state.numParts === n ? 'active' : ''}" onclick="setNumParts(${n})">${n}</button>
  `).join('');
  
  document.getElementById('partsPreview').innerHTML = Array.from({length: state.numParts}).map((_, i) => `
    <div class="part-row">
      <span class="part-num">${i + 1}</span>
      <button class="part-select" onclick="cyclePartType(${i})">${state.parts[i] || 'Pick part'}</button>
    </div>
  `).join('');
  
  document.getElementById('planSetup').classList.toggle('hidden', state.planStep !== 'setup');
  document.getElementById('planSelecting').classList.toggle('hidden', state.planStep !== 'selecting');
  document.getElementById('planComplete').classList.toggle('hidden', state.planStep !== 'complete');
  
  if (state.planStep === 'selecting') renderPlanSelecting();
  if (state.planStep === 'complete') renderPlanComplete();
}

function setNumParts(n) {
  state.numParts = n;
  renderPlan();
}

function cyclePartType(idx) {
  const current = state.parts[idx];
  const currentIdx = PART_TYPES.indexOf(current);
  state.parts[idx] = PART_TYPES[(currentIdx + 1) % PART_TYPES.length];
  renderPlan();
}

function startPlanSelection() {
  state.planDate = document.getElementById('planDateTime').value;
  state.planStep = 'selecting';
  state.currentPartIndex = 0;
  state.selectedPlanItems = [null, null, null, null];
  renderPlan();
}

function renderPlanSelecting() {
  document.getElementById('planStepTitle').textContent = `Part ${state.currentPartIndex + 1} of ${state.numParts}`;
  document.getElementById('planStepType').textContent = state.parts[state.currentPartIndex];
  document.getElementById('planProgress').style.width = `${((state.currentPartIndex + 1) / state.numParts) * 100}%`;
  
  const tag = getTagForPart(state.parts[state.currentPartIndex]);
  const activities = tag ? NYC_ACTIVITIES.filter(a => a.tags.includes(tag)) : [];
  
  document.getElementById('planActivities').innerHTML = activities.map(a => `
    <button class="activity-btn" onclick="selectPlanActivity('${a.id}')">
      <img src="${a.media[0]}" alt="${a.title}">
      <div class="activity-btn-content">
        <div class="activity-btn-title">${a.title}</div>
        <div class="activity-btn-category">${a.category}</div>
        <div class="activity-btn-meta">
          <span style="color:var(--primary);">üìç ${a.distance}</span>
          <span>‚≠ê ${a.rating}</span>
          <span class="price">${a.price}</span>
        </div>
      </div>
      <span class="activity-btn-arrow">‚Üí</span>
    </button>
  `).join('');
}

function selectPlanActivity(id) {
  const activity = NYC_ACTIVITIES.find(a => a.id === id);
  state.selectedPlanItems[state.currentPartIndex] = activity;
  
  if (state.currentPartIndex < state.numParts - 1) {
    state.currentPartIndex++;
    renderPlan();
  } else {
    state.planStep = 'complete';
    renderPlan();
  }
}

function planBack() {
  if (state.currentPartIndex > 0) {
    state.currentPartIndex--;
    renderPlan();
  } else {
    state.planStep = 'setup';
    renderPlan();
  }
}

function renderPlanComplete() {
  const completed = state.selectedPlanItems.slice(0, state.numParts).filter(Boolean);
  document.getElementById('completedItems').innerHTML = completed.map((a, i) => `
    <div class="complete-item">
      <span class="complete-num">${i + 1}</span>
      <img class="complete-img" src="${a.media[0]}" alt="${a.title}">
      <div class="complete-info">
        <p>${a.title}</p>
        <p>${state.parts[i]} ‚Ä¢ ${a.distance}</p>
      </div>
    </div>
  `).join('');
}

async function finishPlan() {
  const selected = state.selectedPlanItems.slice(0, state.numParts).filter(Boolean);
  const newDate = {
    id: Date.now(),
    title: 'Planned Date Night',
    datetime: state.planDate,
    status: 'upcoming',
    activities: selected.map(s => s.title),
  };
  
  state.dates.push(newDate);
  
  if (isLoggedIn) {
    await savePlannedDate(newDate);
  }
  
  state.planStep = 'setup';
  state.selectedPlanItems = [null, null, null, null];
  alert('Your date plan has been added to Upcoming Dates!');
  renderPlan();
}

// ============ PROFILE ============
async function renderProfile() {
  document.getElementById('statLiked').textContent = state.stats.liked;
  document.getElementById('statPassed').textContent = state.stats.passed;
  
  document.getElementById('interestChips').innerHTML = ALL_INTERESTS.map(i => `
    <button class="filter-chip ${state.interests.includes(i.key) ? 'active' : ''}" onclick="toggleInterest('${i.key}')">${i.label}</button>
  `).join('');
  
  updateUIForLoggedInUser();
  
  // Render admin panel if user is admin
  if (isLoggedIn && userProfile?.is_admin) {
    await renderAdminPanel();
  }
}

async function toggleInterest(key) {
  if (state.interests.includes(key)) {
    state.interests = state.interests.filter(k => k !== key);
  } else {
    state.interests.push(key);
  }
  
  if (isLoggedIn) {
    await updateUserProfile({ interests: state.interests });
  }
  
  renderProfile();
}

async function resetProfile() {
  if (confirm('Reset all your data?')) {
    state.interests = [];
    state.savedItems = [];
    state.swipedIds = [];
    state.stats = { liked: 0, passed: 0 };
    state.dates = [];
    
    // Note: For full reset with Supabase, you'd need to delete from all tables
    
    renderProfile();
    renderDiscover();
  }
}

function updateProfileVerificationUI() {
  const section = document.getElementById('verificationSection');
  const notVerified = document.getElementById('notVerifiedBox');
  const pending = document.getElementById('pendingVerifyBox');
  const verified = document.getElementById('verifiedBox');
  const badge = document.getElementById('profileVerifiedBadge');
  
  if (!isLoggedIn) {
    section.style.display = 'none';
    return;
  }
  
  section.style.display = 'block';
  
  if (state.verificationStatus === 'verified') {
    notVerified.style.display = 'none';
    pending.style.display = 'none';
    verified.style.display = 'block';
    badge.classList.remove('hidden');
  } else if (state.verificationStatus === 'pending') {
    notVerified.style.display = 'none';
    pending.style.display = 'block';
    verified.style.display = 'none';
    badge.classList.add('hidden');
  } else {
    notVerified.style.display = 'block';
    pending.style.display = 'none';
    verified.style.display = 'none';
    badge.classList.add('hidden');
  }
}

// ============ VERIFICATION ============
function openVerifyModal() {
  if (!isLoggedIn) {
    alert('Please log in to get verified.');
    return;
  }
  
  document.getElementById('verifyModal').classList.add('active');
  updateVerifyModalUI();
  
  if (state.verificationStatus !== 'verified' && state.verificationStatus !== 'pending') {
    startCamera();
  }
}

function closeVerifyModal() {
  document.getElementById('verifyModal').classList.remove('active');
  stopCamera();
}

function updateVerifyModalUI() {
  const form = document.getElementById('verifyForm');
  const pendingStatus = document.getElementById('verifyPendingStatus');
  const approvedStatus = document.getElementById('verifyApprovedStatus');
  
  if (state.verificationStatus === 'pending') {
    form.style.display = 'none';
    pendingStatus.style.display = 'block';
    approvedStatus.style.display = 'none';
  } else if (state.verificationStatus === 'verified') {
    form.style.display = 'none';
    pendingStatus.style.display = 'none';
    approvedStatus.style.display = 'block';
  } else {
    form.style.display = 'block';
    pendingStatus.style.display = 'none';
    approvedStatus.style.display = 'none';
  }
}

async function startCamera() {
  try {
    const video = document.getElementById('verifyVideo');
    cameraStream = await navigator.mediaDevices.getUserMedia({ 
      video: { facingMode: 'user' }, 
      audio: false 
    });
    video.srcObject = cameraStream;
    video.style.display = 'block';
    document.getElementById('selfiePreview').style.display = 'none';
    document.getElementById('cameraButtons').style.display = 'block';
    document.getElementById('retakeButtons').style.display = 'none';
  } catch (err) {
    console.error('Camera error:', err);
    alert('Could not access camera. Please allow camera permissions and try again.');
  }
}

function stopCamera() {
  if (cameraStream) {
    cameraStream.getTracks().forEach(track => track.stop());
    cameraStream = null;
  }
}

function captureSelfie() {
  const video = document.getElementById('verifyVideo');
  const canvas = document.getElementById('verifyCanvas');
  const preview = document.getElementById('selfiePreview');
  
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext('2d').drawImage(video, 0, 0);
  
  const imageData = canvas.toDataURL('image/jpeg');
  state.verificationData.selfieImage = imageData;
  
  preview.src = imageData;
  preview.style.display = 'block';
  video.style.display = 'none';
  document.getElementById('cameraButtons').style.display = 'none';
  document.getElementById('retakeButtons').style.display = 'block';
  
  stopCamera();
  checkVerifyFormComplete();
}

function retakeSelfie() {
  state.verificationData.selfieImage = null;
  document.getElementById('selfiePreview').style.display = 'none';
  startCamera();
  checkVerifyFormComplete();
}

function handleIdUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    state.verificationData.idImage = e.target.result;
    document.getElementById('idUploadBox').classList.add('has-file');
    document.getElementById('idUploadText').textContent = '‚úì ID uploaded';
    document.getElementById('idUploadText').classList.add('success');
    checkVerifyFormComplete();
  };
  reader.readAsDataURL(file);
}

function checkVerifyFormComplete() {
  const btn = document.getElementById('submitVerifyBtn');
  btn.disabled = !(state.verificationData.idImage && state.verificationData.selfieImage);
}

async function submitVerification() {
  if (!state.verificationData.idImage || !state.verificationData.selfieImage) {
    alert('Please complete both steps.');
    return;
  }
  
  const submitBtn = document.getElementById('submitVerifyBtn');
  submitBtn.disabled = true;
  submitBtn.textContent = 'Submitting...';
  
  try {
    // Upload ID image to storage
    const idResponse = await fetch(state.verificationData.idImage);
    const idBlob = await idResponse.blob();
    const idFileName = `verifications/${currentUser.id}/id-${Date.now()}.jpg`;
    
    const { error: idUploadError } = await db.storage
      .from('user-uploads')
      .upload(idFileName, idBlob, { contentType: 'image/jpeg' });
    
    if (idUploadError) {
      console.error('ID upload error:', idUploadError);
      alert('Error uploading ID. Please try again.');
      submitBtn.disabled = false;
      submitBtn.textContent = 'Submit for Verification';
      return;
    }
    
    // Upload selfie to storage
    const selfieResponse = await fetch(state.verificationData.selfieImage);
    const selfieBlob = await selfieResponse.blob();
    const selfieFileName = `verifications/${currentUser.id}/selfie-${Date.now()}.jpg`;
    
    const { error: selfieUploadError } = await db.storage
      .from('user-uploads')
      .upload(selfieFileName, selfieBlob, { contentType: 'image/jpeg' });
    
    if (selfieUploadError) {
      console.error('Selfie upload error:', selfieUploadError);
      alert('Error uploading selfie. Please try again.');
      submitBtn.disabled = false;
      submitBtn.textContent = 'Submit for Verification';
      return;
    }
    
    // Get public URLs
    const { data: idUrl } = db.storage.from('user-uploads').getPublicUrl(idFileName);
    const { data: selfieUrl } = db.storage.from('user-uploads').getPublicUrl(selfieFileName);
    
    // Update profile with pending status
    state.verificationStatus = 'pending';
    
    await updateUserProfile({
      verification_status: 'pending',
      verification_id_image: idUrl.publicUrl,
      verification_selfie: selfieUrl.publicUrl,
      verification_submitted_at: new Date().toISOString()
    });
    
    updateVerifyModalUI();
    updateProfileVerificationUI();
    
    alert('‚úÖ Your verification request has been submitted! An admin will review it within 24-48 hours.');
    closeVerifyModal();
    
  } catch (err) {
    console.error('Verification error:', err);
    alert('Error submitting verification. Please try again.');
  }
  
  submitBtn.disabled = false;
  submitBtn.textContent = 'Submit for Verification';
}

// ============ UPLOAD CONTENT ============
let uploadedContentFile = null;
let uploadedContentType = null;

// ============ ADMIN FUNCTIONS ============
async function loadPendingVerifications() {
  if (!userProfile?.is_admin) return [];
  
  try {
    const { data, error } = await db
      .from('profiles')
      .select('id, email, name, verification_status, verification_id_image, verification_selfie, verification_submitted_at')
      .eq('verification_status', 'pending')
      .order('verification_submitted_at', { ascending: true });
    
    if (error) {
      console.error('Error loading pending verifications:', error);
      return [];
    }
    
    return data || [];
  } catch (err) {
    console.error('loadPendingVerifications error:', err);
    return [];
  }
}

async function approveVerification(userId) {
  if (!userProfile?.is_admin) return;
  
  try {
    const { error } = await db
      .from('profiles')
      .update({ verification_status: 'verified' })
      .eq('id', userId);
    
    if (error) {
      console.error('Error approving:', error);
      alert('Error approving user');
      return;
    }
    
    alert('‚úÖ User approved!');
    renderProfile();
  } catch (err) {
    console.error('approveVerification error:', err);
  }
}

async function rejectVerification(userId) {
  if (!userProfile?.is_admin) return;
  
  try {
    const { error } = await db
      .from('profiles')
      .update({ 
        verification_status: 'none',
        verification_id_image: null,
        verification_selfie: null,
        verification_submitted_at: null
      })
      .eq('id', userId);
    
    if (error) {
      console.error('Error rejecting:', error);
      alert('Error rejecting user');
      return;
    }
    
    alert('‚ùå User rejected');
    renderProfile();
  } catch (err) {
    console.error('rejectVerification error:', err);
  }
}

function viewVerificationDocs(idImage, selfieImage) {
  // Open images in new tabs
  if (idImage) window.open(idImage, '_blank');
  if (selfieImage) window.open(selfieImage, '_blank');
}

async function renderAdminPanel() {
  if (!userProfile?.is_admin) {
    document.getElementById('adminSection').style.display = 'none';
    return;
  }
  
  document.getElementById('adminSection').style.display = 'block';
  
  const pending = await loadPendingVerifications();
  const container = document.getElementById('pendingVerifications');
  
  if (pending.length === 0) {
    container.innerHTML = '<p style="color:#888;font-size:13px;">No pending requests</p>';
    return;
  }
  
  container.innerHTML = pending.map(user => `
    <div class="admin-item">
      <img class="admin-item-img" src="${user.verification_selfie || 'https://via.placeholder.com/60'}" alt="Selfie">
      <div class="admin-item-info">
        <div class="admin-item-name">${user.name || 'Unknown'}</div>
        <div class="admin-item-email">${user.email}</div>
        <div class="admin-item-date">Submitted: ${new Date(user.verification_submitted_at).toLocaleDateString()}</div>
      </div>
      <div class="admin-btns">
        <button class="admin-btn view" onclick="viewVerificationDocs('${user.verification_id_image}', '${user.verification_selfie}')">View</button>
        <button class="admin-btn approve" onclick="approveVerification('${user.id}')">‚úì</button>
        <button class="admin-btn reject" onclick="rejectVerification('${user.id}')">‚úó</button>
      </div>
    </div>
  `).join('');
}

function openUploadModal() {
  if (!isLoggedIn || state.verificationStatus !== 'verified') {
    alert('You must be verified to upload content.');
    return;
  }
  
  document.getElementById('uploadModal').classList.add('active');
  
  const select = document.getElementById('uploadPlace');
  select.innerHTML = '<option value="">Choose a place...</option>' + 
    NYC_ACTIVITIES.map(a => `<option value="${a.id}">${a.title}</option>`).join('');
  
  // Reset all file inputs
  document.getElementById('uploadPreview').style.display = 'none';
  document.getElementById('uploadVideoPreview').style.display = 'none';
  document.getElementById('contentUploadBtn').classList.remove('has-file');
  document.getElementById('contentUploadText').textContent = 'Tap to select photo or video';
  document.getElementById('uploadCaption').value = '';
  document.getElementById('submitContentBtn').disabled = true;
  
  // Reset file inputs
  document.getElementById('contentInput').value = '';
  document.getElementById('cameraInput').value = '';
  document.getElementById('libraryInput').value = '';
  
  uploadedContentFile = null;
  uploadedContentType = null;
}

function closeUploadModal() {
  document.getElementById('uploadModal').classList.remove('active');
}

function handleContentUpload(event) {
  const file = event.target.files[0];
  if (!file) {
    console.log('No file selected');
    return;
  }
  
  console.log('File selected:', file.name, file.type, file.size);
  
  // Check file size (max 50MB)
  if (file.size > 50 * 1024 * 1024) {
    alert('File is too large. Maximum size is 50MB.');
    return;
  }
  
  // Show loading state
  document.getElementById('contentUploadBtn').classList.add('has-file');
  document.getElementById('contentUploadText').textContent = 'Loading...';
  
  // Determine file type
  if (file.type.startsWith('video/')) {
    uploadedContentType = 'video';
  } else if (file.type.startsWith('image/')) {
    uploadedContentType = 'image';
  } else {
    alert('Please select an image or video file.');
    return;
  }
  
  // Use URL.createObjectURL instead of FileReader (faster and more reliable)
  try {
    const objectUrl = URL.createObjectURL(file);
    uploadedContentFile = file; // Store the actual file, not base64
    
    if (uploadedContentType === 'video') {
      document.getElementById('uploadVideoPreview').src = objectUrl;
      document.getElementById('uploadVideoPreview').style.display = 'block';
      document.getElementById('uploadPreview').style.display = 'none';
    } else {
      document.getElementById('uploadPreview').src = objectUrl;
      document.getElementById('uploadPreview').style.display = 'block';
      document.getElementById('uploadVideoPreview').style.display = 'none';
    }
    
    document.getElementById('contentUploadText').textContent = '‚úì ' + file.name;
    checkUploadFormComplete();
    
  } catch (err) {
    console.error('Error loading file:', err);
    alert('Error loading file. Please try again.');
    document.getElementById('contentUploadText').textContent = 'Tap to select photo or video';
  }
}

function checkUploadFormComplete() {
  const btn = document.getElementById('submitContentBtn');
  const place = document.getElementById('uploadPlace').value;
  btn.disabled = !(uploadedContentFile && place);
}

async function submitContent() {
  const placeId = document.getElementById('uploadPlace').value;
  const caption = document.getElementById('uploadCaption').value;
  
  if (!uploadedContentFile || !placeId) {
    alert('Please select a photo/video and a place.');
    return;
  }
  
  const place = NYC_ACTIVITIES.find(a => a.id === placeId);
  const submitBtn = document.getElementById('submitContentBtn');
  submitBtn.disabled = true;
  submitBtn.textContent = 'Uploading...';
  
  try {
    // uploadedContentFile is now a File object
    const file = uploadedContentFile;
    
    // Generate unique filename
    const ext = file.name.split('.').pop() || (uploadedContentType === 'video' ? 'mp4' : 'jpg');
    const fileName = `${currentUser.id}/${Date.now()}.${ext}`;
    
    console.log('Uploading file:', fileName, file.type, file.size);
    
    // Upload to Supabase Storage
    const { data: uploadData, error: uploadError } = await db.storage
      .from('user-uploads')
      .upload(fileName, file, {
        contentType: file.type,
        upsert: false
      });
    
    if (uploadError) {
      console.error('Upload error:', uploadError);
      alert('Error uploading file: ' + uploadError.message);
      submitBtn.disabled = false;
      submitBtn.textContent = 'Post';
      return;
    }
    
    console.log('Upload successful:', uploadData);
    
    // Get public URL
    const { data: urlData } = db.storage
      .from('user-uploads')
      .getPublicUrl(fileName);
    
    const publicUrl = urlData.publicUrl;
    console.log('Public URL:', publicUrl);
    
    // Save to database
    const { error } = await db
      .from('user_content')
      .insert({
        user_id: currentUser.id,
        user_name: userProfile.name,
        user_verified: true,
        place_id: placeId,
        place_name: place.title,
        place_category: place.category,
        place_address: place.address,
        media_url: publicUrl,
        media_type: uploadedContentType,
        caption: caption
      });
    
    if (error) {
      console.error('Error saving content:', error);
      alert('Error saving content: ' + error.message);
      submitBtn.disabled = false;
      submitBtn.textContent = 'Post';
      return;
    }
    
    // Reload user content
    userGeneratedContent = await loadUserContent();
    
    closeUploadModal();
    alert('üéâ Your content has been posted!');
    renderDiscover();
    
  } catch (err) {
    console.error('Submit error:', err);
    alert('Error uploading content: ' + err.message);
  }
  
  submitBtn.disabled = false;
  submitBtn.textContent = 'Post';
}

// ============ MODAL ============
function openGallery(id) {
  let media = [];
  
  if (id.startsWith('user-')) {
    const contentId = parseInt(id.replace('user-', ''));
    const content = userGeneratedContent.find(c => c.id === contentId);
    if (content) media = [content.media_url];
  } else {
    const item = NYC_ACTIVITIES.find(i => i.id === id);
    if (item) media = item.media;
  }
  
  if (media.length === 0) return;
  
  state.modalMedia = media;
  state.modalIndex = 0;
  updateModal();
  document.getElementById('galleryModal').classList.add('active');
}

function updateModal() {
  document.getElementById('modalImage').src = state.modalMedia[state.modalIndex];
  document.getElementById('modalNav').innerHTML = state.modalMedia.map((_, i) => `
    <button class="modal-dot ${i === state.modalIndex ? 'active' : ''}" onclick="setModalIndex(${i})"></button>
  `).join('');
}

function setModalIndex(i) {
  state.modalIndex = i;
  updateModal();
}

function closeModal() {
  document.getElementById('galleryModal').classList.remove('active');
}

// ============ INIT ============
function initApp() {
  renderDiscover();
  renderBrowse();
  renderSaved();
  renderDates();
  renderPlan();
  renderProfile();
  document.querySelector('.nav-center').classList.add('active');
}

// ============ SIDE MENU ============
function openSideMenu() {
  document.getElementById('sideMenu').classList.add('active');
  document.getElementById('sideMenuOverlay').classList.add('active');
}

function closeSideMenu() {
  document.getElementById('sideMenu').classList.remove('active');
  document.getElementById('sideMenuOverlay').classList.remove('active');
}

// ============ PAYMENT METHODS ============
let savedPaymentMethods = JSON.parse(localStorage.getItem('dateNightPayments') || '[]');

function openPaymentModal() {
  closeSideMenu();
  document.getElementById('paymentModal').classList.add('active');
  renderSavedCards();
  
  // Clear form
  document.getElementById('cardNumber').value = '';
  document.getElementById('cardName').value = '';
  document.getElementById('cardExpiry').value = '';
  document.getElementById('cardCvv').value = '';
}

function closePaymentModal() {
  document.getElementById('paymentModal').classList.remove('active');
}

function renderSavedCards() {
  const container = document.getElementById('savedCards');
  const noCards = document.getElementById('noCardsMessage');
  
  if (savedPaymentMethods.length === 0) {
    noCards.style.display = 'block';
    container.innerHTML = '';
    container.appendChild(noCards);
    return;
  }
  
  noCards.style.display = 'none';
  container.innerHTML = savedPaymentMethods.map((card, index) => `
    <div class="saved-card">
      <span class="saved-card-icon">${getCardIcon(card.number)}</span>
      <div class="saved-card-info">
        <div class="saved-card-number">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ${card.last4}</div>
        <div class="saved-card-exp">Expires ${card.expiry}</div>
      </div>
      <button class="saved-card-delete" onclick="deletePaymentMethod(${index})">üóëÔ∏è</button>
    </div>
  `).join('');
}

function getCardIcon(number) {
  const firstDigit = number.charAt(0);
  if (firstDigit === '4') return 'üí≥'; // Visa
  if (firstDigit === '5') return 'üí≥'; // Mastercard
  if (firstDigit === '3') return 'üí≥'; // Amex
  return 'üí≥';
}

function formatCardNumber(input) {
  let value = input.value.replace(/\D/g, '');
  value = value.replace(/(.{4})/g, '$1 ').trim();
  input.value = value.substring(0, 19);
}

function formatExpiry(input) {
  let value = input.value.replace(/\D/g, '');
  if (value.length >= 2) {
    value = value.substring(0, 2) + '/' + value.substring(2);
  }
  input.value = value.substring(0, 5);
}

function savePaymentMethod() {
  const number = document.getElementById('cardNumber').value.replace(/\s/g, '');
  const name = document.getElementById('cardName').value.trim();
  const expiry = document.getElementById('cardExpiry').value;
  const cvv = document.getElementById('cardCvv').value;
  
  if (!number || number.length < 15) {
    alert('Please enter a valid card number');
    return;
  }
  if (!name) {
    alert('Please enter the cardholder name');
    return;
  }
  if (!expiry || expiry.length < 5) {
    alert('Please enter a valid expiry date');
    return;
  }
  if (!cvv || cvv.length < 3) {
    alert('Please enter a valid CVV');
    return;
  }
  
  const newCard = {
    last4: number.slice(-4),
    number: number.charAt(0), // Only store first digit for card type
    name: name,
    expiry: expiry
    // Note: Never store full card number or CVV in real app!
  };
  
  savedPaymentMethods.push(newCard);
  localStorage.setItem('dateNightPayments', JSON.stringify(savedPaymentMethods));
  
  // Clear form
  document.getElementById('cardNumber').value = '';
  document.getElementById('cardName').value = '';
  document.getElementById('cardExpiry').value = '';
  document.getElementById('cardCvv').value = '';
  
  renderSavedCards();
  alert('‚úÖ Payment method saved!');
}

function deletePaymentMethod(index) {
  if (confirm('Remove this payment method?')) {
    savedPaymentMethods.splice(index, 1);
    localStorage.setItem('dateNightPayments', JSON.stringify(savedPaymentMethods));
    renderSavedCards();
  }
}

// Start app
document.addEventListener('DOMContentLoaded', async function() {
  try {
    // Set a timeout to force hide loading after 5 seconds
    setTimeout(() => {
      hideLoading();
      if (!document.getElementById('app').classList.contains('active') && 
          !document.getElementById('onboarding').classList.contains('active')) {
        document.getElementById('welcome').classList.remove('hidden');
      }
    }, 5000);
    
    await checkSession();
  } catch (err) {
    console.error('Startup error:', err);
    hideLoading();
    document.getElementById('welcome').classList.remove('hidden');
  }
  
  // Add event listener for place selection
  document.getElementById('uploadPlace').addEventListener('change', checkUploadFormComplete);
});

// Close modals on backdrop click
document.getElementById('galleryModal').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});
document.getElementById('loginModal').addEventListener('click', function(e) {
  if (e.target === this) closeLoginModal();
});
document.getElementById('verifyModal').addEventListener('click', function(e) {
  if (e.target === this) closeVerifyModal();
});
document.getElementById('uploadModal').addEventListener('click', function(e) {
  if (e.target === this) closeUploadModal();
});
document.getElementById('paymentModal').addEventListener('click', function(e) {
  if (e.target === this) closePaymentModal();
});
</script>
</body>
</html>
