<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Our Date Night</title>
  <!-- Supabase JS Library -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8f9fa; min-height: 100vh; }
    
    /* Colors */
    :root {
      --primary: #ff6b6b;
      --secondary: #667eea;
      --success: #4ecdc4;
    }
    
    /* Loading Overlay */
    .loading-overlay { position: fixed; inset: 0; background: white; display: flex; align-items: center; justify-content: center; z-index: 9999; flex-direction: column; gap: 16px; }
    .loading-overlay.hidden { display: none; }
    .loading-spinner { width: 48px; height: 48px; border: 4px solid #eee; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* Welcome Screen */
    .welcome { min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 24px; background: linear-gradient(145deg, #1a1a1a 0%, #0d0d0d 50%, #1a1a1a 100%); position: relative; overflow: hidden; }
    .welcome::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(212,175,125,0.1) 0%, transparent 50%); animation: shimmer 8s ease-in-out infinite; }
    @keyframes shimmer { 0%, 100% { transform: translate(0, 0); } 50% { transform: translate(10%, 10%); } }
    .welcome.hidden { display: none; }
    .welcome-content { text-align: center; max-width: 400px; flex: 1; display: flex; flex-direction: column; justify-content: center; z-index: 1; }
    .welcome-logo { font-size: 80px; margin-bottom: 24px; filter: drop-shadow(0 0 20px rgba(212,175,125,0.5)); }
    .welcome h1 { font-size: 42px; font-weight: 800; color: #d4af7d; margin-bottom: 12px; text-shadow: 0 2px 20px rgba(212,175,125,0.3); }
    .welcome p { color: rgba(255,255,255,0.7); margin-bottom: 48px; font-size: 18px; }
    .welcome-footer { width: 100%; padding-bottom: 40px; z-index: 1; }
    .welcome-btn { width: 100%; padding: 18px 24px; border-radius: 30px; border: none; font-size: 17px; font-weight: 600; cursor: pointer; margin-bottom: 16px; transition: transform 0.2s, box-shadow 0.2s; }
    .welcome-btn:hover { transform: translateY(-2px); }
    .welcome-btn.login { background: linear-gradient(135deg, #d4af7d 0%, #c9a066 100%); color: #1a1a1a; box-shadow: 0 4px 20px rgba(212,175,125,0.4); }
    .welcome-btn.login:hover { box-shadow: 0 6px 30px rgba(212,175,125,0.6); }
    .welcome-btn.guest { background: transparent; color: #d4af7d; border: 2px solid #d4af7d; }
    .welcome-btn.guest:hover { background: rgba(212,175,125,0.1); }
    .welcome-btn.continue { background: linear-gradient(135deg, #d4af7d 0%, #c9a066 100%); color: #1a1a1a; box-shadow: 0 4px 20px rgba(212,175,125,0.4); }
    .welcome-btn.continue:hover { box-shadow: 0 6px 30px rgba(212,175,125,0.6); }
    
    /* Welcome Step 2 - After Login/Guest */
    .welcome2 { min-height: 100vh; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 24px; background: linear-gradient(145deg, #1a1a1a 0%, #0d0d0d 50%, #1a1a1a 100%); position: relative; overflow: hidden; }
    .welcome2::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(212,175,125,0.1) 0%, transparent 50%); animation: shimmer 8s ease-in-out infinite; }
    .welcome2.active { display: flex; }
    .welcome2-content { text-align: center; max-width: 400px; flex: 1; display: flex; flex-direction: column; justify-content: center; z-index: 1; }
    .welcome2-logo { font-size: 100px; margin-bottom: 32px; filter: drop-shadow(0 0 30px rgba(212,175,125,0.5)); }
    .welcome2 h2 { font-size: 22px; color: rgba(255,255,255,0.6); margin-bottom: 8px; font-weight: 400; }
    .welcome2 h1 { font-size: 38px; font-weight: 800; color: #d4af7d; margin-bottom: 16px; text-shadow: 0 2px 20px rgba(212,175,125,0.3); }
    .welcome2 p { color: rgba(255,255,255,0.5); font-size: 16px; }
    .welcome2 .user-greeting { font-size: 15px; color: #d4af7d; margin-top: 24px; background: rgba(212,175,125,0.1); padding: 10px 20px; border-radius: 25px; display: inline-block; }
    .welcome2-footer { width: 100%; max-width: 400px; padding-bottom: 50px; z-index: 1; }
    
    /* Login Modal */
    .login-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 300; padding: 24px; }
    .login-modal.active { display: flex; }
    .login-box { background: linear-gradient(145deg, #1a1a1a 0%, #0d0d0d 100%); border: 1px solid rgba(212,175,125,0.3); border-radius: 24px; padding: 32px; width: 100%; max-width: 360px; }
    .login-box h2 { font-size: 24px; margin-bottom: 8px; color: #d4af7d; }
    .login-box p { color: rgba(255,255,255,0.6); margin-bottom: 24px; font-size: 14px; }
    .login-input { width: 100%; padding: 14px 16px; border: 2px solid rgba(212,175,125,0.3); border-radius: 12px; font-size: 16px; margin-bottom: 12px; transition: border-color 0.2s; background: rgba(255,255,255,0.05); color: white; }
    .login-input:focus { outline: none; border-color: #d4af7d; }
    .login-input::placeholder { color: rgba(255,255,255,0.4); }
    .login-submit { width: 100%; padding: 14px; border-radius: 12px; border: none; background: linear-gradient(135deg, #d4af7d 0%, #c9a066 100%); color: #1a1a1a; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 8px; }
    .login-submit:hover { box-shadow: 0 4px 20px rgba(212,175,125,0.4); }
    .login-submit:disabled { background: #444; color: #888; cursor: not-allowed; }
    .login-switch { text-align: center; margin-top: 16px; font-size: 14px; color: rgba(255,255,255,0.6); }
    .login-switch a { color: #d4af7d; cursor: pointer; font-weight: 600; }
    .login-close { position: absolute; top: 20px; right: 20px; background: rgba(212,175,125,0.2); border: 1px solid rgba(212,175,125,0.3); color: #d4af7d; width: 36px; height: 36px; border-radius: 50%; font-size: 20px; cursor: pointer; }
    .login-error { color: #ff6b6b; font-size: 13px; margin-bottom: 12px; display: none; }
    .login-error.show { display: block; }
    .login-success { color: #4ecdc4; font-size: 13px; margin-bottom: 12px; display: none; }
    .login-success.show { display: block; }
    
    /* Onboarding */
    .onboarding { min-height: 100vh; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 24px; background: linear-gradient(145deg, #1a1a1a 0%, #0d0d0d 50%, #1a1a1a 100%); position: relative; overflow: hidden; }
    .onboarding::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(212,175,125,0.1) 0%, transparent 50%); animation: shimmer 8s ease-in-out infinite; }
    .onboarding.active { display: flex; }
    .onboarding-content { text-align: center; max-width: 400px; z-index: 1; }
    .onboarding h2 { font-size: 18px; color: rgba(255,255,255,0.6); margin-bottom: 8px; font-weight: 400; }
    .onboarding h1 { font-size: 32px; font-weight: 800; color: #d4af7d; margin-bottom: 16px; text-shadow: 0 2px 20px rgba(212,175,125,0.3); }
    .onboarding p { color: rgba(255,255,255,0.6); margin-bottom: 40px; }
    .onboarding .user-greeting { font-size: 14px; color: #d4af7d; margin-bottom: 24px; background: rgba(212,175,125,0.1); padding: 8px 16px; border-radius: 20px; display: inline-block; }
    .profile-grid { display: flex; flex-direction: column; gap: 16px; width: 100%; }
    .profile-btn { background: rgba(255,255,255,0.05); border: 1px solid rgba(212,175,125,0.2); border-radius: 20px; padding: 24px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 20px; }
    .profile-btn:hover { transform: translateY(-2px); background: rgba(212,175,125,0.1); border-color: #d4af7d; box-shadow: 0 8px 30px rgba(212,175,125,0.2); }
    .profile-btn .emoji { font-size: 48px; display: flex; align-items: center; justify-content: center; width: 70px; height: 70px; background: rgba(212,175,125,0.1); border-radius: 50%; }
    .profile-btn .label { font-weight: 600; color: white; font-size: 20px; }
    .profile-btn .sublabel { color: rgba(255,255,255,0.5); font-size: 14px; margin-top: 4px; }
    
    /* App Container */
    .app { display: none; min-height: 100vh; padding-bottom: 80px; }
    .app.active { display: block; }
    
    /* Header */
    .header { background: #000; padding: 12px 16px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
    .header-left { display: flex; align-items: center; gap: 8px; }
    .header-logo { font-size: 18px; }
    .header-title { color: var(--primary); font-weight: 700; font-size: 18px; }
    .header-right { display: flex; align-items: center; gap: 10px; cursor: pointer; }
    .header-location { color: #888; font-size: 12px; font-weight: 500; }
    .header-avatar { width: 36px; height: 36px; background: rgba(102,126,234,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; overflow: hidden; font-size: 14px; }
    .header-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .header-verified { background: var(--success); color: white; font-size: 10px; font-weight: 700; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-left: -6px; }
    
    /* Content */
    .content { padding: 16px; }
    .section-title { font-size: 20px; font-weight: 700; margin-bottom: 16px; }
    .hidden { display: none !important; }
    
    /* Swipe Card */
    .card-container { max-width: 400px; margin: 0 auto; position: relative; }
    .swipe-card { background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.15); cursor: grab; transition: none; position: relative; touch-action: pan-y; user-select: none; }
    .swipe-card.animating { transition: transform 0.3s ease, opacity 0.3s ease; }
    .swipe-card:active { cursor: grabbing; }
    .swipe-card .swipe-indicator { position: absolute; top: 50%; transform: translateY(-50%); font-size: 48px; font-weight: 800; padding: 12px 24px; border-radius: 12px; border: 4px solid; opacity: 0; z-index: 10; }
    .swipe-card .swipe-like { right: 20px; color: var(--success); border-color: var(--success); transform: translateY(-50%) rotate(20deg); }
    .swipe-card .swipe-nope { left: 20px; color: var(--primary); border-color: var(--primary); transform: translateY(-50%) rotate(-20deg); }
    .card-image { width: 100%; height: 280px; object-fit: cover; background: #ddd; pointer-events: none; }
    .card-body { padding: 16px; }
    .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
    .card-title { font-size: 20px; font-weight: 700; color: #222; flex: 1; padding-right: 8px; }
    .card-price { background: #4caf50; color: white; padding: 4px 10px; border-radius: 8px; font-size: 12px; font-weight: 600; }
    .card-meta { display: flex; flex-wrap: wrap; gap: 8px; font-size: 12px; color: #666; margin-bottom: 8px; }
    .card-desc { font-size: 14px; color: #555; margin-bottom: 8px; line-height: 1.4; }
    .card-address { font-size: 13px; color: #888; }
    .card-dots { position: absolute; bottom: 12px; left: 50%; transform: translateX(-50%); display: flex; gap: 6px; background: rgba(0,0,0,0.5); padding: 6px 12px; border-radius: 20px; }
    .card-dot { width: 8px; height: 8px; border-radius: 50%; background: rgba(255,255,255,0.5); cursor: pointer; }
    .card-dot.active { background: white; }
    .card-image-wrapper { position: relative; height: 280px; }
    .card-gallery-btn { position: absolute; top: 12px; right: 12px; background: rgba(0,0,0,0.6); color: white; border: none; padding: 6px 12px; border-radius: 20px; font-size: 13px; cursor: pointer; }
    
    /* Swipe Buttons */
    .swipe-buttons { display: flex; justify-content: center; gap: 64px; margin-top: 24px; padding-bottom: 100px; position: relative; z-index: 10; }
    .swipe-btn { width: 64px; height: 64px; border-radius: 50%; border: 4px solid; background: white; font-size: 24px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; -webkit-tap-highlight-color: transparent; }
    .swipe-btn.pass { border-color: var(--primary); }
    .swipe-btn.pass:hover, .swipe-btn.pass:active { background: var(--primary); }
    .swipe-btn.like { border-color: var(--success); }
    .swipe-btn.like:hover, .swipe-btn.like:active { background: var(--success); }
    .swipe-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    /* Empty State */
    .empty-state { background: white; border-radius: 16px; padding: 48px 24px; text-align: center; color: #888; }
    
    /* Filter Chips */
    .filter-chips { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; }
    .filter-chip { padding: 8px 14px; border-radius: 20px; border: none; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s; background: #e9ecef; color: #555; }
    .filter-chip.active { background: var(--secondary); color: white; }
    
    /* List Items */
    .list-item { background: white; border-radius: 12px; padding: 12px; display: flex; gap: 12px; margin-bottom: 12px; }
    .list-image { width: 80px; height: 80px; border-radius: 10px; object-fit: cover; cursor: pointer; flex-shrink: 0; }
    .list-content { flex: 1; min-width: 0; }
    .list-title { font-weight: 600; color: #333; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .list-meta { font-size: 12px; color: #666; margin-bottom: 4px; }
    .list-rating { font-size: 12px; color: var(--primary); }
    .list-actions { display: flex; gap: 8px; margin-top: 8px; }
    .btn-small { padding: 6px 12px; border-radius: 20px; border: none; font-size: 11px; font-weight: 600; color: white; cursor: pointer; }
    .btn-success { background: var(--success); }
    .btn-primary { background: var(--primary); }
    .btn-secondary { background: var(--secondary); }
    .btn-gray { background: #ddd; color: #333; }
    
    /* Date Cards */
    .date-card { background: white; border-radius: 12px; padding: 16px; margin-bottom: 12px; }
    .date-title { font-weight: 600; margin-bottom: 4px; }
    .date-time { font-size: 13px; color: var(--secondary); margin-bottom: 4px; }
    .date-activities { font-size: 12px; color: #666; }
    
    /* Plan Section */
    .plan-card { background: white; border-radius: 16px; padding: 16px; }
    .plan-label { font-weight: 600; margin-bottom: 8px; display: block; }
    .plan-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 14px; margin-bottom: 16px; }
    .part-count-row { display: flex; gap: 8px; margin-bottom: 16px; }
    .part-count-btn { width: 40px; height: 40px; border-radius: 50%; border: none; font-weight: 600; cursor: pointer; background: #e9ecef; color: #555; }
    .part-count-btn.active { background: var(--secondary); color: white; }
    .part-row { display: flex; align-items: center; gap: 12px; background: #f8f9fa; border-radius: 12px; padding: 12px; margin-bottom: 8px; }
    .part-num { font-size: 18px; font-weight: 700; color: var(--secondary); width: 24px; }
    .part-select { flex: 1; background: white; border: none; padding: 10px 12px; border-radius: 8px; cursor: pointer; text-align: left; font-size: 14px; }
    .btn-full { width: 100%; padding: 14px; border-radius: 25px; border: none; font-weight: 700; font-size: 15px; cursor: pointer; margin-top: 16px; }
    .btn-full.secondary { background: var(--secondary); color: white; }
    .btn-full.primary { background: var(--primary); color: white; }
    
    /* Plan Selecting */
    .plan-header { padding: 16px; border-bottom: 1px solid #eee; background: white; position: sticky; top: 56px; z-index: 10; }
    .plan-header-row { display: flex; align-items: center; justify-content: space-between; }
    .plan-back { font-size: 24px; background: none; border: none; cursor: pointer; }
    .plan-header-center { text-align: center; }
    .plan-header-title { font-weight: 700; }
    .plan-header-subtitle { font-size: 13px; color: var(--secondary); }
    .progress-bar { height: 4px; background: #e9ecef; border-radius: 2px; margin-top: 12px; overflow: hidden; }
    .progress-fill { height: 100%; background: var(--secondary); transition: width 0.3s; }
    .activity-btn { width: 100%; background: white; border: 2px solid #f0f0f0; border-radius: 12px; padding: 12px; display: flex; align-items: center; gap: 12px; text-align: left; cursor: pointer; margin-bottom: 12px; transition: border-color 0.2s; }
    .activity-btn:hover { border-color: var(--secondary); }
    .activity-btn img { width: 64px; height: 64px; border-radius: 8px; object-fit: cover; }
    .activity-btn-content { flex: 1; min-width: 0; }
    .activity-btn-title { font-weight: 600; margin-bottom: 4px; }
    .activity-btn-category { font-size: 12px; color: #666; margin-bottom: 4px; }
    .activity-btn-meta { display: flex; gap: 8px; font-size: 11px; color: #888; }
    .activity-btn-meta .price { color: #4caf50; font-weight: 600; }
    .activity-btn-arrow { font-size: 20px; color: var(--secondary); }
    
    /* Complete */
    .complete-title { font-size: 24px; font-weight: 700; text-align: center; margin-bottom: 24px; }
    .complete-item { display: flex; align-items: center; gap: 12px; background: #f8f9fa; border-radius: 12px; padding: 12px; margin-bottom: 12px; }
    .complete-num { font-size: 20px; font-weight: 700; color: var(--secondary); width: 32px; }
    .complete-img { width: 56px; height: 56px; border-radius: 8px; object-fit: cover; }
    .complete-info p:first-child { font-weight: 600; }
    .complete-info p:last-child { font-size: 13px; color: #666; }
    
    /* Profile */
    .profile-card { background: white; border-radius: 16px; padding: 16px; margin-bottom: 24px; }
    .profile-card p { margin-bottom: 4px; }
    .profile-card strong { font-weight: 600; }
    .profile-type-selector { display: flex; gap: 12px; }
    .profile-type-btn { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 16px 8px; border: 2px solid #eee; border-radius: 16px; background: white; cursor: pointer; transition: all 0.2s; }
    .profile-type-btn:hover { border-color: #ccc; background: #f9f9f9; }
    .profile-type-btn.active { border-color: var(--secondary); background: rgba(102,126,234,0.05); }
    .profile-type-btn span:first-child { font-size: 32px; }
    .profile-type-btn span:last-child { font-size: 13px; font-weight: 600; color: #333; }
    .logout-btn { background: #eee; color: #666; margin-top: 12px; }
    
    /* Bottom Nav */
    .nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #eee; padding: 8px 16px 12px; display: flex; justify-content: space-around; align-items: flex-end; z-index: 100; }
    .nav-item { display: flex; flex-direction: column; align-items: center; background: none; border: none; cursor: pointer; padding: 4px 8px; }
    .nav-icon { font-size: 20px; color: #aaa; }
    .nav-label { font-size: 11px; color: #aaa; margin-top: 2px; }
    .nav-item.active .nav-icon, .nav-item.active .nav-label { color: var(--primary); }
    .nav-item.active .nav-label { font-weight: 600; }
    .nav-center { margin-top: -20px; }
    .nav-center-btn { width: 56px; height: 56px; border-radius: 50%; background: #cc4444; border: none; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 15px rgba(204,68,68,0.5); transition: transform 0.2s; }
    .nav-center-btn span { filter: brightness(0) invert(1); }
    .nav-center-btn.pulse { animation: discover-pulse 1.5s ease-in-out infinite; }
    .nav-center-btn.pulse span { animation: discover-icon-pulse 1.5s ease-in-out infinite; }
    @keyframes discover-pulse { 0%, 100% { transform: scale(1); box-shadow: 0 4px 15px rgba(204,68,68,0.5); } 50% { transform: scale(1.1); box-shadow: 0 6px 25px rgba(204,68,68,0.7); } }
    @keyframes discover-icon-pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.15); } }
    
    /* Modal */
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: none; align-items: center; justify-content: center; z-index: 600; }
    .modal.active { display: flex; }
    .modal-content { background: #000; border-radius: 16px; width: 90%; max-width: 600px; height: 70%; position: relative; overflow: hidden; }
    .modal-image { width: 100%; height: 100%; object-fit: contain; }
    .modal-close { position: absolute; top: 12px; right: 12px; width: 32px; height: 32px; border-radius: 50%; background: rgba(0,0,0,0.7); color: white; border: none; font-weight: bold; cursor: pointer; z-index: 601; }
    .modal-nav { position: absolute; bottom: 16px; left: 50%; transform: translateX(-50%); display: flex; gap: 8px; }
    .modal-dot { width: 10px; height: 10px; border-radius: 50%; background: rgba(255,255,255,0.5); border: none; cursor: pointer; }
    .modal-dot.active { background: white; }
    
    /* Content Viewer Modal */
    .content-viewer-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: none; flex-direction: column; z-index: 650; }
    .content-viewer-modal.active { display: flex; }
    .content-viewer-header { display: flex; align-items: center; padding: 16px; gap: 12px; }
    .content-viewer-user { display: flex; align-items: center; gap: 10px; flex: 1; cursor: pointer; }
    .content-viewer-avatar { width: 40px; height: 40px; border-radius: 50%; background: var(--secondary); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 16px; overflow: hidden; }
    .content-viewer-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .content-viewer-name { color: white; font-weight: 600; }
    .content-viewer-close { background: none; border: none; color: white; font-size: 28px; cursor: pointer; padding: 8px; }
    .content-viewer-media { flex: 1; display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .content-viewer-media img, .content-viewer-media video { max-width: 100%; max-height: 100%; object-fit: contain; }
    .content-viewer-info { padding: 16px; color: white; }
    .content-viewer-place { font-weight: 600; margin-bottom: 4px; }
    .content-viewer-caption { color: rgba(255,255,255,0.8); font-size: 14px; margin-bottom: 12px; }
    .content-viewer-likes { display: flex; align-items: center; gap: 8px; }
    .content-viewer-like-btn { background: none; border: none; font-size: 24px; cursor: pointer; }
    .content-viewer-like-count { color: white; font-size: 14px; }
    
    /* Avatar Selector */
    .avatar-selector { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin: 16px 0; }
    .avatar-option { width: 100%; aspect-ratio: 1; border-radius: 50%; border: 3px solid transparent; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 28px; background: #f0f0f0; transition: all 0.2s; }
    .avatar-option:hover { transform: scale(1.1); }
    .avatar-option.selected { border-color: var(--secondary); }
    .avatar-option img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
    .avatar-upload-btn { background: #eee; border: 2px dashed #ccc; display: flex; align-items: center; justify-content: center; font-size: 24px; color: #888; }
    .avatar-upload-btn:hover { border-color: var(--secondary); color: var(--secondary); }
    
    /* Animated Avatars */
    @keyframes avatar-bounce { 
      0%, 100% { transform: translateY(0); } 
      50% { transform: translateY(-6px); } 
    }
    @keyframes avatar-wiggle { 
      0%, 100% { transform: rotate(0deg); } 
      25% { transform: rotate(-10deg); } 
      75% { transform: rotate(10deg); } 
    }
    @keyframes avatar-pulse { 
      0%, 100% { transform: scale(1); } 
      50% { transform: scale(1.15); } 
    }
    @keyframes avatar-spin { 
      0% { transform: rotate(0deg); } 
      100% { transform: rotate(360deg); } 
    }
    @keyframes avatar-float { 
      0%, 100% { transform: translateY(0) rotate(-5deg); } 
      50% { transform: translateY(-8px) rotate(5deg); } 
    }
    @keyframes avatar-shake { 
      0%, 100% { transform: translateX(0); } 
      25% { transform: translateX(-4px); } 
      75% { transform: translateX(4px); } 
    }
    @keyframes avatar-heartbeat { 
      0%, 100% { transform: scale(1); } 
      14% { transform: scale(1.2); } 
      28% { transform: scale(1); } 
      42% { transform: scale(1.2); } 
      70% { transform: scale(1); } 
    }
    @keyframes avatar-wave { 
      0%, 100% { transform: rotate(0deg); } 
      20% { transform: rotate(20deg); } 
      40% { transform: rotate(-10deg); } 
      60% { transform: rotate(20deg); } 
      80% { transform: rotate(-5deg); } 
    }
    @keyframes avatar-jelly { 
      0%, 100% { transform: scale(1, 1); } 
      25% { transform: scale(0.9, 1.1); } 
      50% { transform: scale(1.1, 0.9); } 
      75% { transform: scale(0.95, 1.05); } 
    }
    @keyframes avatar-glow {
      0%, 100% { filter: drop-shadow(0 0 2px rgba(255,107,107,0.5)); }
      50% { filter: drop-shadow(0 0 10px rgba(255,107,107,0.8)); }
    }
    
    .avatar-animated { display: inline-block; }
    .avatar-bounce { animation: avatar-bounce 1s ease-in-out infinite; }
    .avatar-wiggle { animation: avatar-wiggle 0.8s ease-in-out infinite; }
    .avatar-pulse { animation: avatar-pulse 1.2s ease-in-out infinite; }
    .avatar-spin { animation: avatar-spin 3s linear infinite; }
    .avatar-float { animation: avatar-float 2s ease-in-out infinite; }
    .avatar-shake { animation: avatar-shake 0.5s ease-in-out infinite; }
    .avatar-heartbeat { animation: avatar-heartbeat 1.5s ease-in-out infinite; }
    .avatar-wave { animation: avatar-wave 1s ease-in-out infinite; }
    .avatar-jelly { animation: avatar-jelly 0.8s ease-in-out infinite; }
    .avatar-glow { animation: avatar-glow 1.5s ease-in-out infinite; }
    
    /* User Profile Avatar Editable */
    .user-profile-avatar-editable { position: relative; cursor: pointer; }
    .user-profile-avatar-edit { position: absolute; bottom: 0; right: 0; background: var(--secondary); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; }
    
    /* Verification Modal */
    .verify-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 300; padding: 24px; overflow-y: auto; }
    .verify-modal.active { display: flex; }
    .verify-box { background: white; border-radius: 24px; padding: 32px; width: 100%; max-width: 400px; max-height: 90vh; overflow-y: auto; }
    .verify-box h2 { font-size: 24px; margin-bottom: 8px; color: #333; }
    .verify-box p { color: #888; margin-bottom: 24px; font-size: 14px; }
    .verify-step { margin-bottom: 24px; }
    .verify-step-title { font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
    .verify-step-num { background: var(--secondary); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; }
    .verify-upload-box { border: 2px dashed #ddd; border-radius: 12px; padding: 24px; text-align: center; cursor: pointer; transition: all 0.2s; }
    .verify-upload-box:hover { border-color: var(--secondary); background: #f8f9ff; }
    .verify-upload-box.has-file { border-color: var(--success); background: #f0fff8; }
    .verify-upload-box input { display: none; }
    .verify-upload-icon { font-size: 32px; margin-bottom: 8px; }
    .verify-upload-text { color: #888; font-size: 14px; }
    .verify-upload-text.success { color: var(--success); }
    .verify-camera-box { border: 2px solid #ddd; border-radius: 12px; overflow: hidden; position: relative; }
    .verify-video { width: 100%; height: 200px; object-fit: cover; background: #000; }
    .verify-canvas { display: none; }
    .verify-selfie-preview { width: 100%; height: 200px; object-fit: cover; display: none; }
    .verify-camera-btn { position: absolute; bottom: 12px; left: 50%; transform: translateX(-50%); background: var(--primary); color: white; border: none; padding: 12px 24px; border-radius: 25px; font-weight: 600; cursor: pointer; }
    .verify-camera-btn:hover { background: #e85a5a; }
    .verify-retake { background: #666; margin-right: 8px; }
    .verify-status { padding: 16px; border-radius: 12px; text-align: center; margin-bottom: 16px; }
    .verify-status.pending { background: #fff3cd; color: #856404; }
    .verify-status.verified { background: #d4edda; color: #155724; }
    .verified-badge { background: var(--success); color: white; font-size: 10px; padding: 2px 8px; border-radius: 10px; margin-left: 8px; }
    
    /* Upload Content Modal */
    .upload-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: flex-start; justify-content: center; z-index: 300; padding: 24px; overflow-y: auto; }
    .upload-modal.active { display: flex; }
    .upload-box { background: white; border-radius: 24px; padding: 24px; width: 100%; max-width: 400px; margin: auto; }
    .upload-box h2 { font-size: 22px; margin-bottom: 8px; color: #333; }
    .upload-box p { color: #888; margin-bottom: 16px; font-size: 14px; }
    .upload-preview { width: 100%; max-height: 120px; border-radius: 12px; object-fit: cover; margin-bottom: 12px; display: none; background: #000; }
    .upload-video-preview { width: 100%; max-height: 120px; border-radius: 12px; object-fit: cover; margin-bottom: 12px; display: none; }
    .upload-input-group { margin-bottom: 12px; }
    .upload-input-group label { font-weight: 600; margin-bottom: 6px; display: block; font-size: 14px; }
    .upload-input-group input, .upload-input-group select, .upload-input-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 10px; font-size: 14px; }
    .upload-input-group textarea { resize: none; height: 60px; }
    .upload-file-btn { width: 100%; padding: 20px; border: 2px dashed #ddd; border-radius: 12px; background: white; cursor: pointer; text-align: center; margin-bottom: 12px; transition: all 0.2s; }
    .upload-file-btn:hover { border-color: var(--secondary); }
    .upload-file-btn.has-file { border-color: var(--success); background: #f0fff8; padding: 10px; }
    .user-content-badge { position: absolute; top: 12px; left: 12px; background: var(--secondary); color: white; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; display: flex; align-items: center; gap: 4px; }
    .user-content-badge .verified-check { color: #4caf50; }
    .card-user-info { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #eee; }
    .card-user-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; }
    .card-user-name { font-weight: 600; font-size: 14px; }
    .card-user-verified { color: var(--success); font-size: 12px; }
    
    /* Hamburger Menu */
    .hamburger-btn { background: none; border: none; cursor: pointer; padding: 8px; display: flex; flex-direction: column; gap: 4px; }
    .hamburger-btn span { display: block; width: 20px; height: 2px; background: white; border-radius: 2px; }
    .side-menu { position: fixed; top: 0; left: -280px; width: 280px; height: 100%; background: white; z-index: 400; transition: left 0.3s ease; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
    .side-menu.active { left: 0; }
    .side-menu-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 350; display: none; }
    .side-menu-overlay.active { display: block; }
    .side-menu-header { background: linear-gradient(135deg, #667eea 0%, #ff6b6b 100%); padding: 32px 24px; color: white; }
    .side-menu-header h2 { font-size: 20px; margin-bottom: 4px; }
    .side-menu-header p { font-size: 13px; opacity: 0.9; }
    .side-menu-items { padding: 16px 0; }
    .side-menu-item { display: flex; align-items: center; gap: 16px; padding: 16px 24px; cursor: pointer; transition: background 0.2s; text-decoration: none; color: #333; }
    .side-menu-item:hover { background: #f8f9fa; }
    .side-menu-item-icon { font-size: 20px; width: 28px; text-align: center; }
    .side-menu-item-text { font-size: 15px; font-weight: 500; }
    .side-menu-divider { height: 1px; background: #eee; margin: 8px 24px; }
    
    /* Payment Modal */
    .payment-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 500; padding: 24px; overflow-y: auto; }
    .payment-modal.active { display: flex; }
    .payment-box { background: white; border-radius: 24px; padding: 32px; width: 100%; max-width: 400px; max-height: 90vh; overflow-y: auto; }
    .payment-box h2 { font-size: 24px; margin-bottom: 8px; color: #333; }
    .payment-box p { color: #888; margin-bottom: 24px; font-size: 14px; }
    .saved-cards { margin-bottom: 24px; }
    .saved-card { display: flex; align-items: center; gap: 12px; padding: 16px; background: #f8f9fa; border-radius: 12px; margin-bottom: 12px; }
    .saved-card-icon { font-size: 24px; }
    .saved-card-info { flex: 1; }
    .saved-card-number { font-weight: 600; }
    .saved-card-exp { font-size: 12px; color: #888; }
    .saved-card-delete { background: none; border: none; color: var(--primary); cursor: pointer; font-size: 18px; padding: 4px; }
    .no-cards { text-align: center; color: #888; padding: 24px; background: #f8f9fa; border-radius: 12px; }
    .payment-form-group { margin-bottom: 16px; }
    .payment-form-group label { font-weight: 600; margin-bottom: 8px; display: block; font-size: 14px; }
    .payment-form-group input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 16px; }
    .payment-form-row { display: flex; gap: 12px; }
    .payment-form-row .payment-form-group { flex: 1; }
    
    /* Admin Panel */
    .admin-section { background: #fff3cd; border-radius: 16px; padding: 16px; margin-bottom: 24px; }
    .admin-section h3 { color: #856404; margin-bottom: 12px; }
    .admin-item { background: white; border-radius: 12px; padding: 12px; margin-bottom: 12px; display: flex; gap: 12px; align-items: center; }
    .admin-item-img { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; }
    .admin-item-info { flex: 1; }
    .admin-item-name { font-weight: 600; }
    .admin-item-email { font-size: 12px; color: #888; }
    .admin-item-date { font-size: 11px; color: #aaa; }
    .admin-btns { display: flex; gap: 8px; }
    .admin-btn { padding: 8px 16px; border: none; border-radius: 20px; font-weight: 600; cursor: pointer; font-size: 12px; }
    .admin-btn.approve { background: var(--success); color: white; }
    .admin-btn.reject { background: var(--primary); color: white; }
    .admin-btn.view { background: #eee; color: #333; }
    
    /* Admin Dashboard Modal */
    .admin-dashboard-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; z-index: 400; overflow-y: auto; }
    .admin-dashboard-modal.active { display: block; }
    .admin-dashboard { background: #f8f9fa; min-height: 100%; padding: 20px; padding-bottom: 100px; }
    .admin-dashboard-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; }
    .admin-dashboard-header h1 { font-size: 24px; color: #333; }
    .admin-dashboard-close { background: white; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 20px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    
    /* Metrics Grid */
    .metrics-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 24px; }
    .metric-card { background: white; border-radius: 16px; padding: 20px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .metric-card.highlight { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .metric-value { font-size: 32px; font-weight: 700; margin-bottom: 4px; }
    .metric-label { font-size: 13px; opacity: 0.8; }
    .metric-change { font-size: 11px; margin-top: 4px; }
    .metric-change.up { color: var(--success); }
    .metric-change.down { color: var(--primary); }
    
    /* Admin Sections */
    .admin-card { background: white; border-radius: 16px; padding: 20px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .admin-card h3 { font-size: 16px; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
    .admin-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .admin-card-header h3 { margin-bottom: 0; }
    
    /* Admin Tables */
    .admin-table { width: 100%; border-collapse: collapse; }
    .admin-table th { text-align: left; padding: 12px 8px; font-size: 12px; color: #888; border-bottom: 1px solid #eee; }
    .admin-table td { padding: 12px 8px; font-size: 13px; border-bottom: 1px solid #eee; }
    .admin-table tr:last-child td { border-bottom: none; }
    .admin-table-user { display: flex; align-items: center; gap: 8px; }
    .admin-table-avatar { width: 32px; height: 32px; border-radius: 50%; background: var(--secondary); display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; overflow: hidden; }
    .admin-table-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .admin-status { padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; }
    .admin-status.verified { background: #d4edda; color: #155724; }
    .admin-status.pending { background: #fff3cd; color: #856404; }
    .admin-status.none { background: #f0f0f0; color: #666; }
    
    /* Admin Actions */
    .admin-action-btn { padding: 6px 12px; border: none; border-radius: 8px; font-size: 12px; cursor: pointer; margin-right: 4px; }
    .admin-action-btn.primary { background: var(--secondary); color: white; }
    .admin-action-btn.danger { background: var(--primary); color: white; }
    .admin-action-btn.secondary { background: #eee; color: #333; }
    
    /* Top Content List */
    .top-content-item { display: flex; gap: 12px; padding: 12px 0; border-bottom: 1px solid #eee; }
    .top-content-item:last-child { border-bottom: none; }
    .top-content-thumb { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; }
    .top-content-info { flex: 1; }
    .top-content-place { font-weight: 600; font-size: 14px; }
    .top-content-user { font-size: 12px; color: #888; }
    .top-content-stats { font-size: 12px; color: var(--secondary); }
    
    /* Admin Tabs */
    .admin-tabs { display: flex; gap: 8px; margin-bottom: 16px; overflow-x: auto; }
    .admin-tab { padding: 8px 16px; border: none; background: #eee; border-radius: 20px; font-size: 13px; cursor: pointer; white-space: nowrap; }
    .admin-tab.active { background: var(--secondary); color: white; }
    
    /* My Uploads Section */
    .my-uploads { margin-top: 24px; }
    .my-uploads h3 { font-weight: 700; margin-bottom: 12px; }
    .upload-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
    .upload-thumb { position: relative; aspect-ratio: 1; border-radius: 8px; overflow: hidden; cursor: pointer; }
    .upload-thumb img, .upload-thumb video { width: 100%; height: 100%; object-fit: cover; }
    .upload-thumb-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s; }
    .upload-thumb:hover .upload-thumb-overlay { opacity: 1; }
    .upload-thumb-delete { background: var(--primary); color: white; border: none; padding: 8px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; cursor: pointer; }
    .upload-thumb-video-icon { position: absolute; top: 4px; right: 4px; background: rgba(0,0,0,0.6); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; }
    
    /* Location Detail Modal */
    .location-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: flex-start; justify-content: center; z-index: 300; padding: 16px; overflow-y: auto; }
    .location-modal.active { display: flex; }
    .location-box { background: white; border-radius: 24px; width: 100%; max-width: 500px; margin: auto; overflow: hidden; }
    .location-header { position: relative; height: 200px; }
    .location-header img { width: 100%; height: 100%; object-fit: cover; }
    .location-header-overlay { position: absolute; inset: 0; background: linear-gradient(transparent 50%, rgba(0,0,0,0.7)); }
    .location-close { position: absolute; top: 12px; right: 12px; background: rgba(0,0,0,0.5); color: white; border: none; width: 36px; height: 36px; border-radius: 50%; font-size: 18px; cursor: pointer; }
    .location-title { position: absolute; bottom: 16px; left: 16px; right: 16px; color: white; }
    .location-title h2 { font-size: 24px; margin-bottom: 4px; }
    .location-title p { font-size: 14px; opacity: 0.9; }
    .location-body { padding: 20px; }
    .location-meta { display: flex; gap: 16px; margin-bottom: 16px; font-size: 14px; color: #666; }
    .location-desc { color: #555; line-height: 1.5; margin-bottom: 16px; }
    .location-address { color: #888; font-size: 14px; margin-bottom: 24px; }
    .location-section-title { font-weight: 700; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between; }
    .location-section-title span { font-size: 13px; color: #888; font-weight: 400; }
    .location-photos { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 16px; }
    .location-photo { aspect-ratio: 1; border-radius: 12px; overflow: hidden; cursor: pointer; position: relative; }
    .location-photo img, .location-photo video { width: 100%; height: 100%; object-fit: cover; }
    .location-photo-user { position: absolute; bottom: 8px; left: 8px; background: rgba(0,0,0,0.6); color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px; display: flex; align-items: center; gap: 4px; }
    .location-photo-likes { position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.6); color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px; }
    .location-actions { display: flex; gap: 12px; }
    .location-actions button { flex: 1; }
    
    /* User Profile Modal */
    .user-profile-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: flex-start; justify-content: center; z-index: 300; padding: 16px; overflow-y: auto; }
    .user-profile-modal.active { display: flex; }
    .user-profile-box { background: white; border-radius: 24px; width: 100%; max-width: 500px; margin: auto; overflow: hidden; }
    .user-profile-header { background: linear-gradient(135deg, #667eea 0%, #ff6b6b 100%); padding: 32px 20px; text-align: center; color: white; position: relative; }
    .user-profile-close { position: absolute; top: 12px; right: 12px; background: rgba(255,255,255,0.2); color: white; border: none; width: 36px; height: 36px; border-radius: 50%; font-size: 18px; cursor: pointer; }
    .user-profile-avatar { width: 80px; height: 80px; border-radius: 50%; background: white; display: flex; align-items: center; justify-content: center; font-size: 36px; margin: 0 auto 12px; color: var(--secondary); overflow: hidden; }
    .user-profile-name { font-size: 24px; font-weight: 700; margin-bottom: 4px; }
    .user-profile-verified { font-size: 14px; opacity: 0.9; }
    .user-profile-stats { display: flex; justify-content: center; gap: 32px; margin-top: 16px; }
    .user-profile-stat { text-align: center; }
    .user-profile-stat-num { font-size: 20px; font-weight: 700; }
    .user-profile-stat-label { font-size: 12px; opacity: 0.8; }
    .user-profile-body { padding: 20px; }
    .user-profile-section-title { font-weight: 700; margin-bottom: 12px; }
    .user-profile-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
    .user-profile-item { aspect-ratio: 1; border-radius: 8px; overflow: hidden; cursor: pointer; position: relative; }
    .user-profile-item img, .user-profile-item video { width: 100%; height: 100%; object-fit: cover; }
    .user-profile-item-likes { position: absolute; bottom: 4px; right: 4px; background: rgba(0,0,0,0.6); color: white; padding: 2px 6px; border-radius: 8px; font-size: 10px; }
    
    /* Content Like Button */
    .content-like-btn { background: none; border: none; cursor: pointer; font-size: 20px; display: flex; align-items: center; gap: 4px; color: #888; padding: 4px; }
    .content-like-btn.liked { color: var(--primary); }
    .content-like-btn span { font-size: 14px; }
    
    /* Card clickable title */
    .card-title-link { cursor: pointer; color: #222; transition: color 0.2s; }
    .card-title-link:hover { color: var(--secondary); }
    
    /* Card user clickable */
    .card-user-clickable { cursor: pointer; }
    .card-user-clickable:hover .card-user-name { color: var(--secondary); }
    
    /* Browse Cards */
    .browse-card { background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 16px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
    .browse-card:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0,0,0,0.12); }
    .browse-card-image { width: 100%; height: 160px; object-fit: cover; }
    .browse-card-body { padding: 16px; }
    .browse-card-title { font-size: 18px; font-weight: 700; margin-bottom: 4px; }
    .browse-card-meta { display: flex; gap: 12px; font-size: 13px; color: #888; margin-bottom: 8px; }
    .browse-card-desc { font-size: 14px; color: #666; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .browse-card-photos { display: flex; gap: 4px; margin-top: 12px; padding-top: 12px; border-top: 1px solid #eee; }
    .browse-card-photo { width: 40px; height: 40px; border-radius: 6px; object-fit: cover; }
    .browse-card-photo-more { width: 40px; height: 40px; border-radius: 6px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; font-size: 11px; color: #666; font-weight: 600; }
    
    /* Location Photos Grid (50 photos) */
    .location-photos-full { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; max-height: 400px; overflow-y: auto; }
    .location-photos-full .location-photo { aspect-ratio: 1; }
  </style>
</head>
<body>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-spinner"></div>
  <p>Loading...</p>
</div>

<!-- Welcome Screen -->
<div class="welcome hidden" id="welcome">
  <div class="welcome-content">
    <div class="welcome-logo">ðŸ’•</div>
    <h1>Our Date Night</h1>
    <p>Plan unforgettable moments together</p>
  </div>
  <div class="welcome-footer">
    <button class="welcome-btn login" onclick="showLoginModal()">Log In / Sign Up</button>
    <button class="welcome-btn guest" onclick="continueAsGuest()">Continue as Guest</button>
  </div>
</div>

<!-- Login Modal -->
<div class="login-modal" id="loginModal">
  <button class="login-close" onclick="closeLoginModal()">âœ•</button>
  <div class="login-box">
    <h2 id="loginTitle">Welcome Back</h2>
    <p id="loginSubtitle">Log in to save your date plans</p>
    <div class="login-error" id="loginError">Invalid email or password</div>
    <div class="login-success" id="loginSuccess">Check your email for confirmation link!</div>
    <input type="email" class="login-input" id="loginEmail" placeholder="Email address">
    <input type="password" class="login-input" id="loginPassword" placeholder="Password">
    <input type="text" class="login-input hidden" id="loginName" placeholder="Your name">
    <button class="login-submit" id="loginSubmit" onclick="handleLogin()">Log In</button>
    <div class="login-switch">
      <span id="switchText">Don't have an account?</span> <a id="switchLink" onclick="toggleLoginMode()">Sign Up</a>
    </div>
  </div>
</div>

<!-- Welcome Step 2 - After Login/Guest -->
<div class="welcome2" id="welcome2">
  <div class="welcome2-content">
    <div class="welcome2-logo">ðŸ’•</div>
    <h2>Welcome to</h2>
    <h1>Our Date Night</h1>
    <p>Let's plan something unforgettable</p>
    <div class="user-greeting" id="userGreeting2"></div>
  </div>
  <div class="welcome2-footer">
    <button class="welcome-btn continue" onclick="goToProfileSelect()">Continue Planning</button>
  </div>
</div>

<!-- Profile Selection Screen -->
<div class="onboarding" id="onboarding">
  <div class="onboarding-content">
    <h2>Who's joining you?</h2>
    <h1>Plan Your Night</h1>
    <p>Select how you'll be experiencing your date</p>
    <div class="profile-grid">
      <button class="profile-btn" onclick="selectProfile('Solo')">
        <div class="emoji"><span class="avatar-animated avatar-float">ðŸ§˜</span></div>
        <div>
          <div class="label">Solo</div>
          <div class="sublabel">Just me, myself & I</div>
        </div>
      </button>
      <button class="profile-btn" onclick="selectProfile('Couple')">
        <div class="emoji"><span class="avatar-animated avatar-heartbeat">ðŸ’‘</span></div>
        <div>
          <div class="label">Couple</div>
          <div class="sublabel">Romantic date for two</div>
        </div>
      </button>
      <button class="profile-btn" onclick="selectProfile('Friends')">
        <div class="emoji"><span class="avatar-animated avatar-bounce">ðŸŽ‰</span></div>
        <div>
          <div class="label">Friends</div>
          <div class="sublabel">Fun night with the crew</div>
        </div>
      </button>
    </div>
  </div>
</div>

<!-- Main App -->
<div class="app" id="app">
  <!-- Header -->
  <header class="header">
    <div class="header-left">
      <button class="hamburger-btn" onclick="openSideMenu()">
        <span></span>
        <span></span>
        <span></span>
      </button>
      <span class="header-logo">ðŸ’•</span>
      <span class="header-title">Our Date Night</span>
    </div>
    <div class="header-right" onclick="showTab('profile')">
      <div class="header-location">ðŸ“ New York, NY</div>
      <div class="header-avatar" id="headerAvatar">ðŸ‘¤</div>
      <span class="header-verified hidden" id="headerVerified">âœ“</span>
    </div>
  </header>

  <!-- Tab: Discover -->
  <div class="content tab-content" id="tab-discover">
    <h2 class="section-title">Discover Together ðŸ’•</h2>
    <div class="card-container">
      <div id="swipeCard"></div>
      <div class="empty-state hidden" id="emptyDiscover">
        You're all caught up! Adjust interests or browse for more.
      </div>
    </div>
    <div class="swipe-buttons" id="swipeButtons">
      <button class="swipe-btn pass" onclick="passActivity()">âœ–</button>
      <button class="swipe-btn like" onclick="likeActivity()">â¤ï¸</button>
    </div>
  </div>

  <!-- Tab: Browse -->
  <div class="content tab-content hidden" id="tab-browse">
    <h2 class="section-title">Browse All Ideas ðŸ”Ž</h2>
    <div class="filter-chips" id="browseFilters"></div>
    <div id="browseList"></div>
  </div>

  <!-- Tab: Saved -->
  <div class="content tab-content hidden" id="tab-saved">
    <h2 class="section-title">Saved Ideas â¤ï¸</h2>
    <div id="savedList"></div>
  </div>

  <!-- Tab: Dates -->
  <div class="content tab-content hidden" id="tab-dates">
    <h2 class="section-title">Upcoming Dates</h2>
    <div id="upcomingDates"></div>
    <h2 class="section-title" style="margin-top:24px;">Past Dates</h2>
    <div id="pastDates"></div>
  </div>

  <!-- Tab: Plan -->
  <div class="content tab-content hidden" id="tab-plan">
    <div id="planSetup">
      <h2 class="section-title">Plan Your Date ðŸ“…</h2>
      <div class="plan-card">
        <label class="plan-label">Start Date & Time</label>
        <input type="datetime-local" class="plan-input" id="planDateTime">
        
        <label class="plan-label">How many parts?</label>
        <div class="part-count-row" id="partCountRow"></div>
        
        <label class="plan-label">Preview Your Date</label>
        <div id="partsPreview"></div>
        
        <button class="btn-full secondary" onclick="startPlanSelection()">Plan My Date â†’</button>
      </div>
    </div>
    
    <div id="planSelecting" class="hidden">
      <div class="plan-header">
        <div class="plan-header-row">
          <button class="plan-back" onclick="planBack()">â†</button>
          <div class="plan-header-center">
            <div class="plan-header-title" id="planStepTitle">Part 1 of 2</div>
            <div class="plan-header-subtitle" id="planStepType">Dinner</div>
          </div>
          <div style="width:24px;"></div>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" id="planProgress"></div>
        </div>
      </div>
      <div style="padding:16px;" id="planActivities"></div>
    </div>
    
    <div id="planComplete" class="hidden">
      <h2 class="complete-title">ðŸŽ‰ Your Date is Planned!</h2>
      <div id="completedItems"></div>
      <button class="btn-full secondary" onclick="finishPlan()">Done</button>
    </div>
  </div>

  <!-- Tab: Profile -->
  <div class="content tab-content hidden" id="tab-profile">
    <h2 class="section-title">Your Profile ðŸ‘¤</h2>
    <div class="profile-card">
      <p><strong>Name:</strong> <span id="profileName">Guest</span><span class="verified-badge hidden" id="profileVerifiedBadge">âœ“ Verified</span></p>
      <p><strong>Email:</strong> <span id="profileEmail">-</span></p>
      <p><strong>Location:</strong> New York, NY</p>
      <p style="margin-top:8px;"><strong>Stats:</strong> â¤ï¸ <span id="statLiked">0</span> liked â€¢ âœ– <span id="statPassed">0</span> passed</p>
      <p id="accountStatus" style="margin-top:8px;color:var(--success);font-size:13px;"></p>
    </div>
    
    <!-- Profile Type Selector -->
    <div class="profile-card">
      <h3 style="font-weight:700;margin-bottom:12px;">Who's joining you?</h3>
      <div class="profile-type-selector">
        <button class="profile-type-btn" id="profileTypeSolo" onclick="changeProfileType('Solo')">
          <span class="avatar-animated avatar-float">ðŸ§˜</span>
          <span>Solo</span>
        </button>
        <button class="profile-type-btn" id="profileTypeCouple" onclick="changeProfileType('Couple')">
          <span class="avatar-animated avatar-heartbeat">ðŸ’‘</span>
          <span>Couple</span>
        </button>
        <button class="profile-type-btn" id="profileTypeFriends" onclick="changeProfileType('Friends')">
          <span class="avatar-animated avatar-bounce">ðŸŽ‰</span>
          <span>Friends</span>
        </button>
      </div>
    </div>
    
    <!-- Admin Panel (only visible to admins) -->
    <div id="adminSection" class="admin-section" style="display:none;">
      <h3>ðŸ‘‘ Admin Panel</h3>
      <p style="font-size:13px;color:#856404;margin-bottom:12px;">Pending verification requests:</p>
      <div id="pendingVerifications">
        <p style="color:#888;font-size:13px;">No pending requests</p>
      </div>
    </div>
    
    <!-- Verification Section -->
    <div id="verificationSection" class="profile-card" style="display:none;">
      <h3 style="font-weight:700;margin-bottom:12px;">ðŸ›¡ï¸ Verification Status</h3>
      <div id="notVerifiedBox">
        <p style="color:#888;font-size:14px;margin-bottom:12px;">Get verified to share your own photos and videos from your dates!</p>
        <button class="btn-full secondary" onclick="openVerifyModal()">Get Verified</button>
      </div>
      <div id="pendingVerifyBox" style="display:none;">
        <p style="color:#856404;font-size:14px;">â³ Verification pending review (usually 24-48 hours)...</p>
      </div>
      <div id="verifiedBox" style="display:none;">
        <p style="color:#155724;font-size:14px;margin-bottom:12px;">âœ… You are verified!</p>
        <button class="btn-full secondary" onclick="openUploadModal()">ðŸ“¸ Upload Content</button>
      </div>
    </div>
    
    <!-- My Uploads Section (verified users only) -->
    <div id="myUploadsSection" class="profile-card my-uploads" style="display:none;">
      <h3>ðŸ“¸ My Uploads</h3>
      <div class="upload-grid" id="myUploadsGrid">
        <p style="color:#888;font-size:13px;grid-column:1/-1;">You haven't uploaded anything yet.</p>
      </div>
    </div>
    
    <h3 style="font-weight:700;margin-bottom:12px;">Interests</h3>
    <div class="filter-chips" id="interestChips"></div>
    
    <button class="btn-full primary" style="margin-top:24px;" onclick="resetProfile()">Reset Profile</button>
    <button class="btn-full logout-btn" id="logoutBtn" onclick="logout()">Log Out</button>
  </div>

  <!-- Bottom Nav -->
  <nav class="nav">
    <button class="nav-item" onclick="showTab('dates')">
      <span class="nav-icon">ðŸ“…</span>
      <span class="nav-label">Dates</span>
    </button>
    <button class="nav-item" onclick="showTab('browse')">
      <span class="nav-icon">ðŸ§­</span>
      <span class="nav-label">Browse</span>
    </button>
    <button class="nav-item nav-center" onclick="showTab('discover')">
      <div class="nav-center-btn"><span>ðŸŽ¯</span></div>
      <span class="nav-label" style="margin-top:4px;">Discover</span>
    </button>
    <button class="nav-item" onclick="showTab('saved')">
      <span class="nav-icon">â¤ï¸</span>
      <span class="nav-label">Saved</span>
    </button>
    <button class="nav-item" onclick="showTab('plan')">
      <span class="nav-icon">âœ¨</span>
      <span class="nav-label">Plan</span>
    </button>
  </nav>
</div>

<!-- Gallery Modal -->
<div class="modal" id="galleryModal">
  <div class="modal-content">
    <img class="modal-image" id="modalImage" src="" alt="">
    <button class="modal-close" onclick="closeModal()">âœ•</button>
    <div class="modal-nav" id="modalNav"></div>
  </div>
</div>

<!-- Verification Modal -->
<div class="verify-modal" id="verifyModal">
  <div class="verify-box">
    <h2>ðŸ›¡ï¸ Get Verified</h2>
    <p>Take a quick selfie to verify your account and start sharing your date experiences!</p>
    
    <div id="verifyPendingStatus" class="verify-status pending" style="display:none;">
      â³ Your verification is being reviewed. This usually takes 24-48 hours.
    </div>
    
    <div id="verifyApprovedStatus" class="verify-status verified" style="display:none;">
      âœ… You are verified! You can now upload your own content.
    </div>
    
    <div id="verifyForm">
      <div class="verify-step">
        <div class="verify-step-title">
          <span class="verify-step-num">ðŸ“¸</span>
          Take a Selfie
        </div>
        <p style="font-size:13px;color:#888;margin-bottom:12px;">This helps us ensure real people are sharing genuine experiences.</p>
        <div class="verify-camera-box">
          <video class="verify-video" id="verifyVideo" autoplay playsinline></video>
          <canvas class="verify-canvas" id="verifyCanvas"></canvas>
          <img class="verify-selfie-preview" id="selfiePreview" alt="Selfie">
          <div id="cameraButtons">
            <button class="verify-camera-btn" id="captureBtn" onclick="captureSelfie()">ðŸ“¸ Take Photo</button>
          </div>
          <div id="retakeButtons" style="display:none; text-align:center; padding:12px;">
            <button class="verify-camera-btn verify-retake" onclick="retakeSelfie()">â†©ï¸ Retake</button>
          </div>
        </div>
      </div>
      
      <button class="btn-full secondary" id="submitVerifyBtn" onclick="submitVerification()" disabled>Submit for Verification</button>
    </div>
    
    <button class="btn-full" style="background:#eee;color:#666;margin-top:12px;" onclick="closeVerifyModal()">Close</button>
  </div>
</div>

<!-- Upload Content Modal -->
<div class="upload-modal" id="uploadModal">
  <div class="upload-box">
    <h2>ðŸ“¸ Share Your Experience</h2>
    <p>Upload photos or videos from your date to help others discover great places!</p>
    
    <button class="upload-file-btn" id="contentUploadBtn" onclick="document.getElementById('contentInput').click()">
      <input type="file" id="contentInput" accept="image/*,video/*" onchange="handleContentUpload(event)">
      <div class="verify-upload-icon">ðŸ“·</div>
      <div class="verify-upload-text" id="contentUploadText">Tap to select photo or video</div>
    </button>
    
    <div style="display:flex;gap:8px;margin-bottom:16px;">
      <button class="btn-full" style="background:#eee;color:#333;margin:0;flex:1;" onclick="document.getElementById('cameraInput').click()">
        ðŸ“¸ Take Photo
        <input type="file" id="cameraInput" accept="image/*" capture="environment" onchange="handleContentUpload(event)" style="display:none;">
      </button>
      <button class="btn-full" style="background:#eee;color:#333;margin:0;flex:1;" onclick="document.getElementById('libraryInput').click()">
        ðŸ–¼ï¸ Photo Library
        <input type="file" id="libraryInput" accept="image/*,video/*" onchange="handleContentUpload(event)" style="display:none;">
      </button>
    </div>
    
    <img class="upload-preview" id="uploadPreview" alt="Preview">
    <video class="upload-video-preview" id="uploadVideoPreview" controls></video>
    
    <div class="upload-input-group">
      <label>Select Place</label>
      <select id="uploadPlace">
        <option value="">Choose a place...</option>
      </select>
    </div>
    
    <div class="upload-input-group">
      <label>Caption</label>
      <textarea id="uploadCaption" placeholder="Share your experience..."></textarea>
    </div>
    
    <button class="btn-full secondary" id="submitContentBtn" onclick="submitContent()" disabled>Post</button>
    <button class="btn-full" style="background:#eee;color:#666;margin-top:12px;" onclick="closeUploadModal()">Cancel</button>
  </div>
</div>

<!-- Side Menu Overlay -->
<div class="side-menu-overlay" id="sideMenuOverlay" onclick="closeSideMenu()"></div>

<!-- Side Menu -->
<div class="side-menu" id="sideMenu">
  <div class="side-menu-header">
    <h2>ðŸ’• Our Date Night</h2>
    <p>Plan the perfect date</p>
  </div>
  <div class="side-menu-items">
    <div class="side-menu-item" id="adminDashboardItem" style="display:none;" onclick="openAdminDashboard()">
      <span class="side-menu-item-icon">ðŸ“Š</span>
      <span class="side-menu-item-text">Admin Dashboard</span>
    </div>
    <div class="side-menu-item" id="myPublicProfileItem" style="display:none;" onclick="openMyPublicProfile()">
      <span class="side-menu-item-icon">ðŸ‘¤</span>
      <span class="side-menu-item-text">My Public Profile</span>
    </div>
    <div class="side-menu-item" onclick="openPaymentModal()">
      <span class="side-menu-item-icon">ðŸ’³</span>
      <span class="side-menu-item-text">Payments</span>
    </div>
    <div class="side-menu-divider"></div>
    <a class="side-menu-item" href="https://www.tiktok.com/@eatwhiletraveling" target="_blank">
      <span class="side-menu-item-icon">ðŸ“±</span>
      <span class="side-menu-item-text">Contact Us</span>
    </a>
  </div>
</div>

<!-- Location Detail Modal -->
<div class="location-modal" id="locationModal">
  <div class="location-box">
    <div class="location-header">
      <img id="locationImage" src="" alt="">
      <div class="location-header-overlay"></div>
      <button class="location-close" onclick="closeLocationModal()">âœ•</button>
      <div class="location-title">
        <h2 id="locationName"></h2>
        <p id="locationCategory"></p>
      </div>
    </div>
    <div class="location-body">
      <div class="location-meta">
        <span id="locationRating">â­ 4.5</span>
        <span id="locationReviews">â€¢ 1,234 reviews</span>
        <span id="locationPrice">â€¢ $$</span>
      </div>
      <p class="location-desc" id="locationDesc"></p>
      <p class="location-address" id="locationAddress">ðŸ“ </p>
      
      <div class="location-section-title">
        ðŸ“¸ User Photos & Videos
        <span id="locationPhotoCount">0 posts</span>
      </div>
      <div class="location-photos" id="locationPhotos">
        <p style="color:#888;font-size:13px;grid-column:1/-1;">No user content yet. Be the first to share!</p>
      </div>
      
      <div class="location-actions">
        <button class="btn-full secondary" onclick="saveLocationFromModal()">â¤ï¸ Save</button>
        <button class="btn-full primary" onclick="bookLocationFromModal()">Book Now</button>
      </div>
    </div>
  </div>
</div>

<!-- User Profile Modal -->
<div class="user-profile-modal" id="userProfileModal">
  <div class="user-profile-box">
    <div class="user-profile-header">
      <button class="user-profile-close" onclick="closeUserProfileModal()">âœ•</button>
      <div class="user-profile-avatar-editable" id="userProfileAvatarContainer" onclick="openAvatarSelector()">
        <div class="user-profile-avatar" id="userProfileAvatar">J</div>
        <div class="user-profile-avatar-edit" id="avatarEditIcon" style="display:none;">âœï¸</div>
      </div>
      <div class="user-profile-name" id="userProfileName">John Doe</div>
      <div class="user-profile-verified">âœ“ Verified Reviewer</div>
      <div class="user-profile-stats">
        <div class="user-profile-stat">
          <div class="user-profile-stat-num" id="userProfilePosts">0</div>
          <div class="user-profile-stat-label">Posts</div>
        </div>
        <div class="user-profile-stat">
          <div class="user-profile-stat-num" id="userProfileLikes">0</div>
          <div class="user-profile-stat-label">Likes</div>
        </div>
      </div>
      <button class="btn-full" id="shareProfileBtn" style="display:none;margin-top:16px;background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.5);" onclick="shareProfile()">
        ðŸ“¤ Share Profile
      </button>
    </div>
    <div class="user-profile-body">
      <div class="user-profile-section-title">ðŸ“¸ Reviews</div>
      <div class="user-profile-grid" id="userProfileGrid">
        <p style="color:#888;font-size:13px;grid-column:1/-1;">No posts yet.</p>
      </div>
    </div>
  </div>
</div>

<!-- Content Viewer Modal -->
<div class="content-viewer-modal" id="contentViewerModal">
  <div class="content-viewer-header">
    <div class="content-viewer-user" id="contentViewerUser" onclick="viewContentUserProfile()">
      <div class="content-viewer-avatar" id="contentViewerAvatar">J</div>
      <div class="content-viewer-name" id="contentViewerName">User</div>
    </div>
    <button class="content-viewer-close" onclick="closeContentViewer()">âœ•</button>
  </div>
  <div class="content-viewer-media" id="contentViewerMedia"></div>
  <div class="content-viewer-info">
    <div class="content-viewer-place" id="contentViewerPlace">Place Name</div>
    <div class="content-viewer-caption" id="contentViewerCaption">Caption...</div>
    <div class="content-viewer-likes">
      <button class="content-viewer-like-btn" id="contentViewerLikeBtn" onclick="likeCurrentContent()">ðŸ¤</button>
      <span class="content-viewer-like-count" id="contentViewerLikeCount">0 likes</span>
    </div>
  </div>
</div>

<!-- Avatar Selector Modal -->
<div class="payment-modal" id="avatarModal">
  <div class="payment-box" style="max-height:85vh;overflow-y:auto;">
    <h2>Choose Your Avatar</h2>
    <p>Select an animated avatar or upload your own photo</p>
    
    <h4 style="font-size:13px;color:#888;margin:16px 0 8px;">ðŸ“· Custom Photo</h4>
    <div class="avatar-selector" style="grid-template-columns: repeat(4, 1fr);">
      <div class="avatar-option avatar-upload-btn" onclick="document.getElementById('avatarUploadInput').click()">
        âž•
        <input type="file" id="avatarUploadInput" accept="image/*" style="display:none;" onchange="handleAvatarUpload(event)">
      </div>
    </div>
    
    <h4 style="font-size:13px;color:#888;margin:16px 0 8px;">ðŸ˜Š Bouncing</h4>
    <div class="avatar-selector">
      <div class="avatar-option" onclick="selectAvatar('ðŸ˜Š', 'bounce')"><span class="avatar-animated avatar-bounce">ðŸ˜Š</span></div>
      <div class="avatar-option" onclick="selectAvatar('ðŸ˜„', 'bounce')"><span class="avatar-animated avatar-bounce">ðŸ˜„</span></div>
      <div class="avatar-option" onclick="selectAvatar('ðŸ¥³', 'bounce')"><span class="avatar-animated avatar-bounce">ðŸ¥³</span></div>
      <div class="avatar-option" onclick="selectAvatar('ðŸ˜Ž', 'bounce')"><span class="avatar-animated avatar-bounce">ðŸ˜Ž</span></div>
    </div>
    
    <h4 style="font-size:13px;color:#888;margin:16px 0 8px;">ðŸ’• Heartbeat</h4>
    <div class="avatar-selector">
      <div class="avatar-option" onclick="selectAvatar('ðŸ¥°', 'heartbeat')"><span class="avatar-animated avatar-heartbeat">ðŸ¥°</span></div>
      <div class="avatar-option" onclick="selectAvatar('ðŸ˜', 'heartbeat')"><span class="avatar-animated avatar-heartbeat">ðŸ˜</span></div>
      <div class="avatar-option" onclick="selectAvatar('ðŸ’–', 'heartbeat')"><span class="avatar-animated avatar-heartbeat">ðŸ’–</span></div>
      <div class="avatar-option" onclick="selectAvatar('â¤ï¸', 'heartbeat')"><span class="avatar-animated avatar-heartbeat">â¤ï¸</span></div>
    </div>
    
    <h4 style="font-size:13px;color:#888;margin:16px 0 8px;">ðŸ‘‹ Waving</h4>
    <div class="avatar-selector">
      <div class="avatar-option" onclick="selectAvatar('ðŸ‘‹', 'wave')"><span class="avatar-animated avatar-wave">ðŸ‘‹</span></div>
      <div class="avatar-option" onclick="selectAvatar('ðŸ¤—', 'wave')"><span class="avatar-animated avatar-wave">ðŸ¤—</span></div>
      <div class="avatar-option" onclick="selectAvatar('âœŒï¸', 'wave')"><span class="avatar-animated avatar-wave">âœŒï¸</span></div>
      <div class="avatar-option" onclick="selectAvatar('ðŸ™‹', 'wave')"><span class="avatar-animated avatar-wave">ðŸ™‹</span></div>
    </div>
    
    <h4 style="font-size:13px;color:#888;margin:16px 0 8px;">ðŸŒŸ Pulsing</h4>
    <div class="avatar-selector">
      <div class="avatar-option" onclick="selectAvatar('â­', 'pulse')"><span class="avatar-animated avatar-pulse">â­</span></div>
      <div class="avatar-option" onclick="selectAvatar('ðŸŒŸ', 'pulse')"><span class="avatar-animated avatar-pulse">ðŸŒŸ</span></div>
      <div class="avatar-option" onclick="selectAvatar('âœ¨', 'pulse')"><span class="avatar-animated avatar-pulse">âœ¨</span></div>
      <div class="avatar-option" onclick="selectAvatar('ðŸ’«', 'pulse')"><span class="avatar-animated avatar-pulse">ðŸ’«</span></div>
    </div>
    
    <h4 style="font-size:13px;color:#888;margin:16px 0 8px;">ðŸŽˆ Floating</h4>
    <div class="avatar-selector">
      <div class="avatar-option" onclick="selectAvatar('ðŸ¦‹', 'float')"><span class="avatar-animated avatar-float">ðŸ¦‹</span></div>
      <div class="avatar-option" onclick="selectAvatar('ðŸŽˆ', 'float')"><span class="avatar-animated avatar-float">ðŸŽˆ</span></div>
      <div class="avatar-option" onclick="selectAvatar('â˜ï¸', 'float')"><span class="avatar-animated avatar-float">â˜ï¸</span></div>
      <div class="avatar-option" onclick="selectAvatar('ðŸŒ™', 'float')"><span class="avatar-animated avatar-float">ðŸŒ™</span></div>
    </div>
    
    <h4 style="font-size:13px;color:#888;margin:16px 0 8px;">ðŸ”„ Spinning</h4>
    <div class="avatar-selector">
      <div class="avatar-option" onclick="selectAvatar('ðŸŒ€', 'spin')"><span class="avatar-animated avatar-spin">ðŸŒ€</span></div>
      <div class="avatar-option" onclick="selectAvatar('â˜€ï¸', 'spin')"><span class="avatar-animated avatar-spin">â˜€ï¸</span></div>
      <div class="avatar-option" onclick="selectAvatar('ðŸŒˆ', 'spin')"><span class="avatar-animated avatar-spin">ðŸŒˆ</span></div>
      <div class="avatar-option" onclick="selectAvatar('ðŸ’¿', 'spin')"><span class="avatar-animated avatar-spin">ðŸ’¿</span></div>
    </div>
    
    <h4 style="font-size:13px;color:#888;margin:16px 0 8px;">ðŸ¾ Wiggling</h4>
    <div class="avatar-selector">
      <div class="avatar-option" onclick="selectAvatar('ðŸ±', 'wiggle')"><span class="avatar-animated avatar-wiggle">ðŸ±</span></div>
      <div class="avatar-option" onclick="selectAvatar('ðŸ¶', 'wiggle')"><span class="avatar-animated avatar-wiggle">ðŸ¶</span></div>
      <div class="avatar-option" onclick="selectAvatar('ðŸ¦Š', 'wiggle')"><span class="avatar-animated avatar-wiggle">ðŸ¦Š</span></div>
      <div class="avatar-option" onclick="selectAvatar('ðŸ¼', 'wiggle')"><span class="avatar-animated avatar-wiggle">ðŸ¼</span></div>
    </div>
    
    <h4 style="font-size:13px;color:#888;margin:16px 0 8px;">ðŸ­ Jelly</h4>
    <div class="avatar-selector">
      <div class="avatar-option" onclick="selectAvatar('ðŸ­', 'jelly')"><span class="avatar-animated avatar-jelly">ðŸ­</span></div>
      <div class="avatar-option" onclick="selectAvatar('ðŸ§', 'jelly')"><span class="avatar-animated avatar-jelly">ðŸ§</span></div>
      <div class="avatar-option" onclick="selectAvatar('ðŸ©', 'jelly')"><span class="avatar-animated avatar-jelly">ðŸ©</span></div>
      <div class="avatar-option" onclick="selectAvatar('ðŸ¦', 'jelly')"><span class="avatar-animated avatar-jelly">ðŸ¦</span></div>
    </div>
    
    <button class="btn-full secondary" style="margin-top:16px;" onclick="saveAvatar()">Save Avatar</button>
    <button class="btn-full" style="background:#eee;color:#666;margin-top:12px;" onclick="closeAvatarModal()">Cancel</button>
  </div>
</div>

<!-- Admin Dashboard Modal -->
<div class="admin-dashboard-modal" id="adminDashboardModal">
  <div class="admin-dashboard">
    <div class="admin-dashboard-header">
      <h1>ðŸ“Š Admin Dashboard</h1>
      <button class="admin-dashboard-close" onclick="closeAdminDashboard()">âœ•</button>
    </div>
    
    <!-- Key Metrics -->
    <div class="metrics-grid">
      <div class="metric-card highlight">
        <div class="metric-value" id="metricTotalUsers">0</div>
        <div class="metric-label">Total Users</div>
      </div>
      <div class="metric-card">
        <div class="metric-value" id="metricVerifiedUsers">0</div>
        <div class="metric-label">Verified Users</div>
      </div>
      <div class="metric-card">
        <div class="metric-value" id="metricTotalPosts">0</div>
        <div class="metric-label">Total Posts</div>
      </div>
      <div class="metric-card">
        <div class="metric-value" id="metricTotalLikes">0</div>
        <div class="metric-label">Total Likes</div>
      </div>
    </div>
    
    <!-- Quick Actions -->
    <div class="admin-card">
      <h3>âš¡ Quick Actions</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button class="admin-action-btn primary" onclick="adminRefreshData()">ðŸ”„ Refresh Data</button>
        <button class="admin-action-btn secondary" onclick="adminExportUsers()">ðŸ“¥ Export Users</button>
        <button class="admin-action-btn secondary" onclick="adminExportContent()">ðŸ“¥ Export Content</button>
      </div>
    </div>
    
    <!-- Tabs -->
    <div class="admin-tabs">
      <button class="admin-tab active" onclick="showAdminTab('users')">ðŸ‘¥ Users</button>
      <button class="admin-tab" onclick="showAdminTab('content')">ðŸ“¸ Content</button>
      <button class="admin-tab" onclick="showAdminTab('locations')">ðŸ“ Locations</button>
    </div>
    
    <!-- Users Tab -->
    <div class="admin-card" id="adminTabUsers">
      <div class="admin-card-header">
        <h3>ðŸ‘¥ All Users</h3>
        <span style="font-size:12px;color:#888;" id="userCount">0 users</span>
      </div>
      <div style="overflow-x:auto;">
        <table class="admin-table">
          <thead>
            <tr>
              <th>User</th>
              <th>Status</th>
              <th>Posts</th>
              <th>Joined</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="adminUsersTable">
            <tr><td colspan="5" style="text-align:center;color:#888;">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- Content Tab -->
    <div class="admin-card" id="adminTabContent" style="display:none;">
      <div class="admin-card-header">
        <h3>ðŸ“¸ All Content</h3>
        <span style="font-size:12px;color:#888;" id="contentCount">0 posts</span>
      </div>
      <div id="adminContentList">
        <p style="text-align:center;color:#888;">Loading...</p>
      </div>
    </div>
    
    <!-- Locations Tab -->
    <div class="admin-card" id="adminTabLocations" style="display:none;">
      <div class="admin-card-header">
        <h3>ðŸ“ Top Locations</h3>
      </div>
      <div id="adminLocationsList">
        <p style="text-align:center;color:#888;">Loading...</p>
      </div>
    </div>
    
    <!-- Top Creators -->
    <div class="admin-card">
      <h3>ðŸ† Top Content Creators</h3>
      <div id="topCreatorsList">
        <p style="text-align:center;color:#888;">Loading...</p>
      </div>
    </div>
    
    <!-- Recent Activity -->
    <div class="admin-card">
      <h3>ðŸ• Recent Activity</h3>
      <div id="recentActivityList">
        <p style="text-align:center;color:#888;">Loading...</p>
      </div>
    </div>
  </div>
</div>

<!-- Payment Modal -->
<div class="payment-modal" id="paymentModal">
  <div class="payment-box">
    <h2>ðŸ’³ Payment Methods</h2>
    <p>Manage your saved payment methods</p>
    
    <div class="saved-cards" id="savedCards">
      <div class="no-cards" id="noCardsMessage">
        <p>No payment methods saved yet</p>
      </div>
    </div>
    
    <h3 style="font-weight:600;margin-bottom:16px;">Add New Card</h3>
    
    <div class="payment-form-group">
      <label>Card Number</label>
      <input type="text" id="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19" oninput="formatCardNumber(this)">
    </div>
    
    <div class="payment-form-group">
      <label>Cardholder Name</label>
      <input type="text" id="cardName" placeholder="John Doe">
    </div>
    
    <div class="payment-form-row">
      <div class="payment-form-group">
        <label>Expiry</label>
        <input type="text" id="cardExpiry" placeholder="MM/YY" maxlength="5" oninput="formatExpiry(this)">
      </div>
      <div class="payment-form-group">
        <label>CVV</label>
        <input type="text" id="cardCvv" placeholder="123" maxlength="4">
      </div>
    </div>
    
    <button class="btn-full secondary" onclick="savePaymentMethod()">Save Card</button>
    <button class="btn-full" style="background:#eee;color:#666;margin-top:12px;" onclick="closePaymentModal()">Close</button>
  </div>
</div>

<script>
// ============ SUPABASE SETUP ============
const SUPABASE_URL = 'https://yvobrmkvtpvrldpewrma.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl2b2JybWt2dHB2cmxkcGV3cm1hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2NzUxMTksImV4cCI6MjA4MzI1MTExOX0.9TFhi_qL2VDx4691bR225KCYuOZqWRd5t5PWI3w2J9M';

const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ============ DATA ============
const NYC_ACTIVITIES = [
  { id: 'dining-0', title: "Katz's Delicatessen", category: 'Dining', description: "Iconic NYC deli famous for pastrami sandwiches since 1888.", price: '$$', rating: 4.6, reviewCount: 8234, distance: 'NYC', address: 'Lower East Side, NY', tags: ['restaurants'], media: ['https://images.unsplash.com/photo-1553909489-cd47e0907980?w=800', 'https://images.unsplash.com/photo-1619096252214-ef06c45683e3?w=800', 'https://images.unsplash.com/photo-1555939594-58d7cb561ad1?w=800'] },
  { id: 'dining-1', title: "Joe's Pizza", category: 'Dining', description: "Classic NY slice joint, serving perfect pizza since 1975.", price: '$', rating: 4.7, reviewCount: 5621, distance: 'NYC', address: 'Greenwich Village, NY', tags: ['restaurants'], media: ['https://images.unsplash.com/photo-1513104890138-7c749659a591?w=800', 'https://images.unsplash.com/photo-1574071318508-1cdbab80d002?w=800'] },
  { id: 'dining-2', title: 'Carbone', category: 'Dining', description: "Upscale Italian-American with old-school charm.", price: '$$$', rating: 4.8, reviewCount: 3456, distance: 'NYC', address: 'Greenwich Village, NY', tags: ['restaurants'], media: ['https://images.unsplash.com/photo-1555992336-fb0d29498b13?w=800', 'https://images.unsplash.com/photo-1551218372-a8789b81b253?w=800'] },
  { id: 'dining-3', title: 'Peter Luger Steak House', category: 'Dining', description: "Legendary Brooklyn steakhouse since 1887.", price: '$$$', rating: 4.7, reviewCount: 9821, distance: 'NYC', address: 'Williamsburg, Brooklyn', tags: ['restaurants'], media: ['https://images.unsplash.com/photo-1546833999-b9f581a1996d?w=800', 'https://images.unsplash.com/photo-1558030006-450675393462?w=800'] },
  { id: 'dining-4', title: 'Le Bernardin', category: 'Dining', description: "Three Michelin-starred seafood temple.", price: '$$$$', rating: 4.9, reviewCount: 2134, distance: 'NYC', address: 'Midtown, NY', tags: ['restaurants'], media: ['https://images.unsplash.com/photo-1559339352-11d035aa65de?w=800', 'https://images.unsplash.com/photo-1580554530778-ca36943938b2?w=800'] },
  { id: 'movies-0', title: 'AMC Empire 25', category: 'Movie Theater', description: "Massive Times Square multiplex with IMAX.", price: '$$', rating: 4.5, reviewCount: 8901, distance: 'NYC', address: 'Times Square, NY', tags: ['movies'], media: ['https://images.unsplash.com/photo-1489599849927-2ee91cede3ba?w=800', 'https://images.unsplash.com/photo-1517604931442-7e0c8ed2963c?w=800'] },
  { id: 'movies-1', title: 'Nitehawk Cinema', category: 'Movie Theater', description: "Dine-in theater serving food and cocktails.", price: '$$', rating: 4.6, reviewCount: 4567, distance: 'NYC', address: 'Williamsburg, Brooklyn', tags: ['movies'], media: ['https://images.unsplash.com/photo-1594909122845-11baa439b7bf?w=800', 'https://images.unsplash.com/photo-1489599849927-2ee91cede3ba?w=800'] },
  { id: 'outdoor-0', title: 'Central Park Boathouse', category: 'Outdoor', description: "Romantic rowboat rentals on Central Park Lake.", price: '$$', rating: 4.7, reviewCount: 7890, distance: 'NYC', address: 'Central Park, NY', tags: ['outdoor'], media: ['https://images.unsplash.com/photo-1568515387631-8b650bbcdb90?w=800', 'https://images.unsplash.com/photo-1534430458160-e5945e863c0c?w=800'] },
  { id: 'outdoor-1', title: 'Brooklyn Bridge Park', category: 'Outdoor', description: "Stunning waterfront views of Manhattan.", price: '$', rating: 4.8, reviewCount: 12345, distance: 'NYC', address: 'Brooklyn, NY', tags: ['outdoor'], media: ['https://images.unsplash.com/photo-1514565131-fce0801e5785?w=800', 'https://images.unsplash.com/photo-1518391846015-55a9cc003b25?w=800'] },
  { id: 'outdoor-2', title: 'The High Line', category: 'Outdoor', description: "Elevated park with gardens and art.", price: '$', rating: 4.7, reviewCount: 15678, distance: 'NYC', address: 'Chelsea, NY', tags: ['outdoor'], media: ['https://images.unsplash.com/photo-1555109307-f7d9da25c244?w=800', 'https://images.unsplash.com/photo-1565094052366-dd58cd3eaf6e?w=800'] },
  { id: 'arts-0', title: 'The Met Museum', category: 'Arts & Culture', description: "World-class museum with 2 million works.", price: '$$', rating: 4.8, reviewCount: 25678, distance: 'NYC', address: 'Upper East Side, NY', tags: ['arts'], media: ['https://images.unsplash.com/photo-1564399579883-451a5d44ec08?w=800', 'https://images.unsplash.com/photo-1566127444979-b3d2b64977e9?w=800'] },
  { id: 'arts-1', title: 'MoMA', category: 'Arts & Culture', description: "Iconic modern and contemporary art.", price: '$$', rating: 4.7, reviewCount: 18901, distance: 'NYC', address: 'Midtown, NY', tags: ['arts'], media: ['https://images.unsplash.com/photo-1564399580075-5dfe19c205f3?w=800', 'https://images.unsplash.com/photo-1577083553936-205ff5d3e44f?w=800'] },
  { id: 'nightlife-0', title: 'Press Lounge Rooftop', category: 'Nightlife', description: "Elegant rooftop bar with Hudson views.", price: '$$$', rating: 4.6, reviewCount: 5678, distance: 'NYC', address: "Hell's Kitchen, NY", tags: ['nightlife'], media: ['https://images.unsplash.com/photo-1514933651103-005eec06c04b?w=800', 'https://images.unsplash.com/photo-1566417713940-fe7c737a9ef2?w=800'] },
  { id: 'nightlife-1', title: 'The Dead Rabbit', category: 'Nightlife', description: "Award-winning Irish pub with cocktails.", price: '$$', rating: 4.7, reviewCount: 9876, distance: 'NYC', address: 'Financial District, NY', tags: ['nightlife'], media: ['https://images.unsplash.com/photo-1572116469696-31de0f17cc34?w=800', 'https://images.unsplash.com/photo-1546171753-97d7676e4602?w=800'] },
  { id: 'shopping-0', title: 'SoHo Boutiques', category: 'Shopping', description: "Trendy boutiques in cobblestone SoHo.", price: '$$$', rating: 4.5, reviewCount: 9876, distance: 'NYC', address: 'SoHo, NY', tags: ['shopping'], media: ['https://images.unsplash.com/photo-1441986300917-64674bd600d8?w=800', 'https://images.unsplash.com/photo-1483985988355-763728e1935b?w=800'] },
  { id: 'wellness-0', title: 'Aire Ancient Baths', category: 'Wellness', description: "Luxurious thermal baths in TriBeCa.", price: '$$$', rating: 4.8, reviewCount: 6234, distance: 'NYC', address: 'TriBeCa, NY', tags: ['wellness'], media: ['https://images.unsplash.com/photo-1544161515-4ab6ce6db874?w=800', 'https://images.unsplash.com/photo-1540555700478-4be289fbecef?w=800'] },
];

const ALL_INTERESTS = [
  { key: 'restaurants', label: 'ðŸ½ï¸ Dining' },
  { key: 'movies', label: 'ðŸŽ¬ Movies' },
  { key: 'outdoor', label: 'ðŸƒ Outdoor' },
  { key: 'arts', label: 'ðŸŽ¨ Arts' },
  { key: 'nightlife', label: 'ðŸŒƒ Nightlife' },
  { key: 'shopping', label: 'ðŸ›ï¸ Shopping' },
  { key: 'wellness', label: 'ðŸ§˜ Wellness' },
];

const PART_TYPES = ['Coffee', 'Lunch', 'Dinner', 'Movie', 'Activity', 'Drinks'];

// ============ STATE ============
let isLoggedIn = false;
let isSignUpMode = false;
let isGuestMode = false;
let currentUser = null;
let userProfile = null;
let cameraStream = null;

// Local state for UI
let state = {
  interests: ['restaurants', 'nightlife', 'arts'],
  savedItems: [],
  swipedIds: [],
  dates: [],
  stats: { liked: 0, passed: 0 },
  browseFilters: [],
  currentTab: 'discover',
  planDate: '',
  numParts: 2,
  parts: ['Dinner', 'Activity', null, null],
  planStep: 'setup',
  currentPartIndex: 0,
  selectedPlanItems: [null, null, null, null],
  modalMedia: [],
  modalIndex: 0,
  verificationStatus: 'none',
  verificationData: { selfieImage: null }
};

let userGeneratedContent = [];

// ============ HELPERS ============
function formatDateTime(d) {
  return new Date(d).toLocaleString('en-US', { weekday: 'short', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
}

function getTagForPart(part) {
  if (['Coffee', 'Lunch', 'Dinner'].includes(part)) return 'restaurants';
  if (part === 'Movie') return 'movies';
  if (part === 'Activity') return 'outdoor';
  if (part === 'Drinks') return 'nightlife';
  return null;
}

function hideLoading() {
  document.getElementById('loadingOverlay').classList.add('hidden');
}

function showLoading() {
  document.getElementById('loadingOverlay').classList.remove('hidden');
}

// ============ SUPABASE DATA FUNCTIONS ============
async function loadUserProfile() {
  if (!currentUser) return null;
  
  const { data, error } = await db
    .from('profiles')
    .select('*')
    .eq('id', currentUser.id)
    .single();
  
  if (error && error.code === 'PGRST116') {
    // Profile doesn't exist, create it
    const { data: newProfile, error: createError } = await db
      .from('profiles')
      .insert({
        id: currentUser.id,
        email: currentUser.email,
        name: currentUser.user_metadata?.name || currentUser.email.split('@')[0]
      })
      .select()
      .single();
    
    if (createError) console.error('Error creating profile:', createError);
    return newProfile;
  }
  
  return data;
}

async function updateUserProfile(updates) {
  if (!currentUser) return;
  
  const { error } = await db
    .from('profiles')
    .update(updates)
    .eq('id', currentUser.id);
  
  if (error) console.error('Error updating profile:', error);
}

async function loadSavedItems() {
  if (!currentUser) return [];
  
  const { data, error } = await db
    .from('saved_items')
    .select('activity_id')
    .eq('user_id', currentUser.id);
  
  if (error) {
    console.error('Error loading saved items:', error);
    return [];
  }
  
  return data.map(item => {
    const activity = NYC_ACTIVITIES.find(a => a.id === item.activity_id);
    return activity;
  }).filter(Boolean);
}

async function loadSwipedItems() {
  if (!currentUser) return [];
  
  const { data, error } = await db
    .from('swiped_items')
    .select('activity_id')
    .eq('user_id', currentUser.id);
  
  if (error) {
    console.error('Error loading swiped items:', error);
    return [];
  }
  
  return data.map(item => item.activity_id);
}

async function loadPlannedDates() {
  if (!currentUser) return [];
  
  const { data, error } = await db
    .from('planned_dates')
    .select('*')
    .eq('user_id', currentUser.id)
    .order('datetime', { ascending: true });
  
  if (error) {
    console.error('Error loading dates:', error);
    return [];
  }
  
  return data;
}

async function loadUserContent() {
  try {
    const { data, error } = await db
      .from('user_content')
      .select('*')
      .order('created_at', { ascending: false })
      .limit(50);
    
    if (error) {
      console.error('Error loading user content:', error);
      return [];
    }
    
    return data || [];
  } catch (err) {
    console.error('loadUserContent error:', err);
    return [];
  }
}

async function saveSwipedItem(activityId, action) {
  if (!currentUser) return;
  
  const { error } = await db
    .from('swiped_items')
    .insert({
      user_id: currentUser.id,
      activity_id: activityId,
      action: action
    });
  
  if (error) console.error('Error saving swipe:', error);
}

async function saveSavedItem(activityId) {
  if (!currentUser) return;
  
  const { error } = await db
    .from('saved_items')
    .insert({
      user_id: currentUser.id,
      activity_id: activityId
    });
  
  if (error && error.code !== '23505') console.error('Error saving item:', error);
}

async function removeSavedItem(activityId) {
  if (!currentUser) return;
  
  const { error } = await db
    .from('saved_items')
    .delete()
    .eq('user_id', currentUser.id)
    .eq('activity_id', activityId);
  
  if (error) console.error('Error removing saved item:', error);
}

async function savePlannedDate(dateData) {
  if (!currentUser) return;
  
  const { error } = await db
    .from('planned_dates')
    .insert({
      user_id: currentUser.id,
      title: dateData.title,
      datetime: dateData.datetime,
      status: dateData.status,
      activities: dateData.activities
    });
  
  if (error) console.error('Error saving date:', error);
}

async function removePlannedDate(dateId) {
  if (!currentUser) return;
  
  const { error } = await db
    .from('planned_dates')
    .delete()
    .eq('id', dateId)
    .eq('user_id', currentUser.id);
  
  if (error) console.error('Error removing date:', error);
}

// ============ AUTH FUNCTIONS ============
async function checkSession() {
  try {
    const { data: { session }, error } = await db.auth.getSession();
    
    if (error) {
      console.error('Session error:', error);
      hideLoading();
      document.getElementById('welcome').classList.remove('hidden');
      return;
    }
    
    if (session) {
      currentUser = session.user;
      isLoggedIn = true;
      isGuestMode = false;
      
      // Load user data with error handling
      try {
        userProfile = await loadUserProfile();
        state.savedItems = await loadSavedItems();
        state.swipedIds = await loadSwipedItems();
        state.dates = await loadPlannedDates();
        userGeneratedContent = await loadUserContent();
      } catch (loadError) {
        console.error('Error loading user data:', loadError);
      }
      
      if (userProfile) {
        state.interests = userProfile.interests || ['restaurants', 'nightlife', 'arts'];
        state.stats.liked = userProfile.stats_liked || 0;
        state.stats.passed = userProfile.stats_passed || 0;
        state.verificationStatus = userProfile.verification_status || 'none';
        
        if (userProfile.profile_type) {
          document.getElementById('app').classList.add('active');
          updateUIForLoggedInUser();
          initApp();
        } else {
          document.getElementById('welcome2').classList.add('active');
          document.getElementById('userGreeting2').textContent = `Welcome, ${userProfile.name}!`;
        }
      } else {
        document.getElementById('welcome2').classList.add('active');
        document.getElementById('userGreeting2').textContent = `Welcome!`;
      }
    } else {
      // Load user content for guests too
      try {
        userGeneratedContent = await loadUserContent();
      } catch (e) {
        console.error('Error loading content:', e);
      }
      
      document.getElementById('welcome').classList.remove('hidden');
    }
  } catch (err) {
    console.error('checkSession error:', err);
    document.getElementById('welcome').classList.remove('hidden');
  }
  
  hideLoading();
}

function showLoginModal() {
  document.getElementById('loginModal').classList.add('active');
  isSignUpMode = false;
  updateLoginModal();
}

function closeLoginModal() {
  document.getElementById('loginModal').classList.remove('active');
  document.getElementById('loginError').classList.remove('show');
  document.getElementById('loginSuccess').classList.remove('show');
  document.getElementById('loginEmail').value = '';
  document.getElementById('loginPassword').value = '';
  document.getElementById('loginName').value = '';
}

function toggleLoginMode() {
  isSignUpMode = !isSignUpMode;
  updateLoginModal();
}

function updateLoginModal() {
  const title = document.getElementById('loginTitle');
  const subtitle = document.getElementById('loginSubtitle');
  const nameInput = document.getElementById('loginName');
  const submitBtn = document.getElementById('loginSubmit');
  const switchText = document.getElementById('switchText');
  const switchLink = document.getElementById('switchLink');
  
  document.getElementById('loginError').classList.remove('show');
  document.getElementById('loginSuccess').classList.remove('show');
  
  if (isSignUpMode) {
    title.textContent = 'Create Account';
    subtitle.textContent = 'Sign up to save your date plans';
    nameInput.classList.remove('hidden');
    submitBtn.textContent = 'Sign Up';
    switchText.textContent = 'Already have an account?';
    switchLink.textContent = 'Log In';
  } else {
    title.textContent = 'Welcome Back';
    subtitle.textContent = 'Log in to save your date plans';
    nameInput.classList.add('hidden');
    submitBtn.textContent = 'Log In';
    switchText.textContent = "Don't have an account?";
    switchLink.textContent = 'Sign Up';
  }
}

async function handleLogin() {
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;
  const name = document.getElementById('loginName').value.trim();
  const errorEl = document.getElementById('loginError');
  const successEl = document.getElementById('loginSuccess');
  const submitBtn = document.getElementById('loginSubmit');
  
  errorEl.classList.remove('show');
  successEl.classList.remove('show');
  
  if (!email || !password) {
    errorEl.textContent = 'Please fill in all fields';
    errorEl.classList.add('show');
    return;
  }
  
  if (!email.includes('@')) {
    errorEl.textContent = 'Please enter a valid email';
    errorEl.classList.add('show');
    return;
  }
  
  submitBtn.disabled = true;
  submitBtn.textContent = isSignUpMode ? 'Signing up...' : 'Logging in...';
  
  try {
    if (isSignUpMode) {
      // Sign Up
      if (!name) {
        errorEl.textContent = 'Please enter your name';
        errorEl.classList.add('show');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Sign Up';
        return;
      }
      
      const { data, error } = await db.auth.signUp({
        email,
        password,
        options: {
          data: { name }
        }
      });
      
      if (error) {
        errorEl.textContent = error.message;
        errorEl.classList.add('show');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Sign Up';
        return;
      }
      
      if (data.user && !data.session) {
        // Email confirmation required
        successEl.textContent = 'Check your email for the confirmation link!';
        successEl.classList.add('show');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Sign Up';
      } else if (data.session) {
        // Auto-confirmed, proceed
        currentUser = data.user;
        isLoggedIn = true;
        isGuestMode = false;
        closeLoginModal();
        
        userProfile = await loadUserProfile();
        userGeneratedContent = await loadUserContent();
        
        document.getElementById('welcome').classList.add('hidden');
        document.getElementById('welcome2').classList.add('active');
        document.getElementById('userGreeting2').textContent = `Welcome, ${name}!`;
      }
      
    } else {
      // Log In
      const { data, error } = await db.auth.signInWithPassword({
        email,
        password
      });
      
      if (error) {
        errorEl.textContent = error.message;
        errorEl.classList.add('show');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Log In';
        return;
      }
      
      currentUser = data.user;
      isLoggedIn = true;
      isGuestMode = false;
      closeLoginModal();
      
      // Load user data
      userProfile = await loadUserProfile();
      state.savedItems = await loadSavedItems();
      state.swipedIds = await loadSwipedItems();
      state.dates = await loadPlannedDates();
      userGeneratedContent = await loadUserContent();
      
      if (userProfile) {
        state.interests = userProfile.interests || ['restaurants', 'nightlife', 'arts'];
        state.stats.liked = userProfile.stats_liked || 0;
        state.stats.passed = userProfile.stats_passed || 0;
        state.verificationStatus = userProfile.verification_status || 'none';
        
        document.getElementById('welcome').classList.add('hidden');
        
        if (userProfile.profile_type) {
          document.getElementById('app').classList.add('active');
          updateUIForLoggedInUser();
          initApp();
        } else {
          document.getElementById('welcome2').classList.add('active');
          document.getElementById('userGreeting2').textContent = `Welcome back, ${userProfile.name}!`;
        }
      }
    }
  } catch (err) {
    errorEl.textContent = 'An error occurred. Please try again.';
    errorEl.classList.add('show');
    submitBtn.disabled = false;
    submitBtn.textContent = isSignUpMode ? 'Sign Up' : 'Log In';
  }
}

async function continueAsGuest() {
  isLoggedIn = false;
  isGuestMode = true;
  currentUser = null;
  
  state = {
    interests: ['restaurants', 'nightlife', 'arts'],
    savedItems: [],
    swipedIds: [],
    dates: [],
    stats: { liked: 0, passed: 0 },
    browseFilters: [],
    currentTab: 'discover',
    planDate: '',
    numParts: 2,
    parts: ['Dinner', 'Activity', null, null],
    planStep: 'setup',
    currentPartIndex: 0,
    selectedPlanItems: [null, null, null, null],
    modalMedia: [],
    modalIndex: 0,
    verificationStatus: 'none',
    verificationData: { selfieImage: null }
  };
  
  userGeneratedContent = await loadUserContent();
  
  document.getElementById('welcome').classList.add('hidden');
  document.getElementById('welcome2').classList.add('active');
  document.getElementById('userGreeting2').textContent = 'Guest Mode';
}

function goToProfileSelect() {
  document.getElementById('welcome2').classList.remove('active');
  document.getElementById('onboarding').classList.add('active');
}

async function selectProfile(type) {
  if (isLoggedIn && userProfile) {
    await updateUserProfile({ profile_type: type });
    userProfile.profile_type = type;
  }
  
  document.getElementById('welcome2').classList.remove('active');
  document.getElementById('onboarding').classList.remove('active');
  document.getElementById('app').classList.add('active');
  updateUIForLoggedInUser();
  initApp();
}

async function changeProfileType(type) {
  if (isLoggedIn && userProfile) {
    await updateUserProfile({ profile_type: type });
    userProfile.profile_type = type;
  }
  updateProfileTypeButtons();
}

function updateProfileTypeButtons() {
  const profileType = userProfile?.profile_type || 'Solo';
  
  // Remove active class from all buttons
  document.querySelectorAll('.profile-type-btn').forEach(btn => btn.classList.remove('active'));
  
  // Add active class to selected button
  const activeBtn = document.getElementById('profileType' + profileType);
  if (activeBtn) activeBtn.classList.add('active');
}

function updateHeaderAvatar() {
  const headerAvatar = document.getElementById('headerAvatar');
  const headerVerified = document.getElementById('headerVerified');
  
  if (!headerAvatar) return;
  
  // Update avatar
  if (isLoggedIn && userProfile) {
    const avatar = userProfile.avatar;
    if (avatar && avatar.startsWith('http')) {
      headerAvatar.innerHTML = `<img src="${avatar}" alt="">`;
    } else if (avatar && avatar.includes(':')) {
      const [emoji, animation] = avatar.split(':');
      headerAvatar.innerHTML = `<span class="avatar-animated avatar-${animation}" style="font-size:18px;">${emoji}</span>`;
    } else if (avatar) {
      headerAvatar.innerHTML = `<span style="font-size:18px;">${avatar}</span>`;
    } else if (userProfile.name) {
      headerAvatar.innerHTML = userProfile.name.charAt(0).toUpperCase();
    } else {
      headerAvatar.innerHTML = 'ðŸ‘¤';
    }
    
    // Show verified check only if verified
    if (state.verificationStatus === 'verified' && headerVerified) {
      headerVerified.classList.remove('hidden');
    } else if (headerVerified) {
      headerVerified.classList.add('hidden');
    }
  } else {
    headerAvatar.innerHTML = 'ðŸ‘¤';
    if (headerVerified) headerVerified.classList.add('hidden');
  }
}

function updateUIForLoggedInUser() {
  if (isLoggedIn && userProfile) {
    document.getElementById('profileName').textContent = userProfile.name || 'User';
    document.getElementById('profileEmail').textContent = userProfile.email;
    document.getElementById('accountStatus').textContent = 'âœ“ Your data is synced across all devices';
    document.getElementById('logoutBtn').style.display = 'block';
    document.getElementById('verificationSection').style.display = 'block';
  } else {
    document.getElementById('profileName').textContent = 'Guest';
    document.getElementById('profileEmail').textContent = '-';
    document.getElementById('accountStatus').textContent = 'âš ï¸ Guest mode - data won\'t be saved';
    document.getElementById('logoutBtn').style.display = 'none';
    document.getElementById('verificationSection').style.display = 'none';
  }
  
  updateProfileTypeButtons();
  updateHeaderAvatar();
  updateProfileVerificationUI();
}

async function logout() {
  if (confirm('Are you sure you want to log out?')) {
    await db.auth.signOut();
    isLoggedIn = false;
    currentUser = null;
    userProfile = null;
    location.reload();
  }
}

// ============ DISCOVER ============
function getDiscoverPool() {
  const userContent = userGeneratedContent
    .filter(c => !state.swipedIds.includes('user-' + c.id))
    .map(c => ({
      id: 'user-' + c.id,
      odOriginalUserId: c.user_id,
      originalPlaceId: c.place_id,
      title: c.place_name,
      category: c.place_category,
      description: c.caption || `Shared by ${c.user_name}`,
      price: NYC_ACTIVITIES.find(a => a.id === c.place_id)?.price || '$$',
      rating: NYC_ACTIVITIES.find(a => a.id === c.place_id)?.rating || 4.5,
      reviewCount: NYC_ACTIVITIES.find(a => a.id === c.place_id)?.reviewCount || 0,
      distance: 'NYC',
      address: c.place_address,
      tags: NYC_ACTIVITIES.find(a => a.id === c.place_id)?.tags || [],
      media: [c.media_url],
      mediaType: c.media_type,
      isUserContent: true,
      userName: c.user_name,
      userVerified: c.user_verified,
      createdAt: c.created_at,
      likes: c.likes || 0
    }));
  
  const regularActivities = NYC_ACTIVITIES
    .filter(item => state.interests.length === 0 || item.tags.some(t => state.interests.includes(t)))
    .filter(item => !state.swipedIds.includes(item.id));
  
  return [...userContent, ...regularActivities];
}

function renderDiscover() {
  const pool = getDiscoverPool();
  const card = document.getElementById('swipeCard');
  const empty = document.getElementById('emptyDiscover');
  const btns = document.getElementById('swipeButtons');
  
  if (pool.length === 0) {
    card.innerHTML = '';
    empty.classList.remove('hidden');
    btns.classList.add('hidden');
  } else {
    empty.classList.add('hidden');
    btns.classList.remove('hidden');
    const item = pool[0];
    
    // Get popular content for this location (if not user content itself)
    let popularPhotos = '';
    if (!item.isUserContent) {
      const locationContent = userGeneratedContent
        .filter(c => c.place_id === item.id)
        .sort((a, b) => calculatePopularity(b) - calculatePopularity(a))
        .slice(0, 10);
      
      if (locationContent.length > 0) {
        popularPhotos = `
          <div style="padding: 12px 16px; border-top: 1px solid #eee;">
            <div style="font-weight:600;font-size:13px;margin-bottom:8px;display:flex;justify-content:space-between;">
              <span>ðŸ“¸ Popular Photos (${locationContent.length})</span>
              <span style="color:var(--secondary);cursor:pointer;" onclick="event.stopPropagation(); openLocationModal('${item.id}')">See All</span>
            </div>
            <div style="display:flex;gap:6px;overflow-x:auto;padding-bottom:4px;">
              ${locationContent.slice(0, 5).map(c => `
                <div style="flex-shrink:0;width:60px;height:60px;border-radius:8px;overflow:hidden;cursor:pointer;position:relative;" onclick="event.stopPropagation(); openUserProfileModal('${c.user_id}', '${c.user_name}')">
                  ${c.media_type === 'video' 
                    ? `<video src="${c.media_url}" style="width:100%;height:100%;object-fit:cover;" muted></video><span style="position:absolute;top:2px;right:2px;background:rgba(0,0,0,0.6);color:white;padding:1px 4px;border-radius:3px;font-size:8px;">â–¶</span>`
                    : `<img src="${c.media_url}" style="width:100%;height:100%;object-fit:cover;">`
                  }
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }
    }
    
    const userBadge = item.isUserContent ? `
      <div class="user-content-badge">
        <span>ðŸ“¸</span> ${item.userName} ${item.userVerified ? '<span class="verified-check">âœ“</span>' : ''}
      </div>
    ` : '';
    
    const userInfo = item.isUserContent ? `
      <div class="card-user-info card-user-clickable" onclick="event.stopPropagation(); openUserProfileModal('${item.odOriginalUserId || ''}', '${item.userName}')">
        <div style="width:32px;height:32px;border-radius:50%;background:var(--secondary);display:flex;align-items:center;justify-content:center;color:white;font-size:14px;">
          ${item.userName.charAt(0).toUpperCase()}
        </div>
        <span class="card-user-name">${item.userName}</span>
        ${item.userVerified ? '<span class="card-user-verified">âœ“ Verified</span>' : ''}
      </div>
    ` : '';
    
    const mediaContent = item.mediaType === 'video' ? `
      <video class="card-image" src="${item.media[0]}" autoplay loop muted playsinline></video>
    ` : `
      <img class="card-image" src="${item.media[0]}" alt="${item.title}" id="cardImage">
    `;
    
    // Get original activity ID for user content
    const originalActivityId = item.isUserContent ? item.originalPlaceId : item.id;
    
    card.innerHTML = `
      <div class="swipe-card" id="currentCard">
        <div class="swipe-indicator swipe-like">LIKE</div>
        <div class="swipe-indicator swipe-nope">NOPE</div>
        <div class="card-image-wrapper">
          ${mediaContent}
          ${userBadge}
          <button class="card-gallery-btn" onclick="openGallery('${item.id}')">ðŸ“· ${item.media.length}</button>
          ${!item.isUserContent && item.media.length > 1 ? `
          <div class="card-dots">
            ${item.media.map((_, i) => `<div class="card-dot ${i === 0 ? 'active' : ''}" onclick="changeCardImage(${i})"></div>`).join('')}
          </div>
          ` : ''}
        </div>
        <div class="card-body">
          ${userInfo}
          <div class="card-header">
            <h3 class="card-title card-title-link" onclick="event.stopPropagation(); openLocationModal('${originalActivityId || item.id}')">${item.title}</h3>
            <span class="card-price">${item.price}</span>
          </div>
          <div class="card-meta">
            <span>â­ ${item.rating}</span>
            ${item.reviewCount ? `<span>â€¢ ${item.reviewCount} reviews</span>` : ''}
            <span>â€¢ ${item.distance}</span>
          </div>
          <p class="card-desc">${item.description}</p>
          <p class="card-address">ðŸ“ ${item.address}</p>
        </div>
        ${popularPhotos}
      </div>
    `;
    
    // Initialize swipe gestures on the new card
    initSwipeGestures();
  }
}

let cardImageIndex = 0;
function changeCardImage(idx) {
  const pool = getDiscoverPool();
  if (pool.length === 0) return;
  cardImageIndex = idx;
  document.getElementById('cardImage').src = pool[0].media[idx];
  document.querySelectorAll('.card-dot').forEach((d, i) => d.classList.toggle('active', i === idx));
}

// ============ SWIPE GESTURES ============
let swipeStartX = 0;
let swipeStartY = 0;
let swipeCurrentX = 0;
let swipeCurrentY = 0;
let isSwiping = false;
let swipeCard = null;

function initSwipeGestures() {
  swipeCard = document.getElementById('currentCard');
  if (!swipeCard) return;
  
  // Touch events
  swipeCard.addEventListener('touchstart', handleSwipeStart, { passive: true });
  swipeCard.addEventListener('touchmove', handleSwipeMove, { passive: false });
  swipeCard.addEventListener('touchend', handleSwipeEnd);
  
  // Mouse events (for desktop)
  swipeCard.addEventListener('mousedown', handleSwipeStart);
  document.addEventListener('mousemove', handleSwipeMove);
  document.addEventListener('mouseup', handleSwipeEnd);
}

function handleSwipeStart(e) {
  if (!swipeCard) return;
  
  // Don't start swipe if clicking on buttons
  if (e.target.closest('.card-gallery-btn') || e.target.closest('.card-dot')) return;
  
  isSwiping = true;
  swipeCard.classList.remove('animating');
  
  if (e.type === 'touchstart') {
    swipeStartX = e.touches[0].clientX;
    swipeStartY = e.touches[0].clientY;
  } else {
    swipeStartX = e.clientX;
    swipeStartY = e.clientY;
    e.preventDefault();
  }
  
  swipeCurrentX = swipeStartX;
  swipeCurrentY = swipeStartY;
}

function handleSwipeMove(e) {
  if (!isSwiping || !swipeCard) return;
  
  if (e.type === 'touchmove') {
    swipeCurrentX = e.touches[0].clientX;
    swipeCurrentY = e.touches[0].clientY;
  } else {
    swipeCurrentX = e.clientX;
    swipeCurrentY = e.clientY;
  }
  
  const deltaX = swipeCurrentX - swipeStartX;
  const deltaY = swipeCurrentY - swipeStartY;
  
  // Only prevent default if horizontal swipe is dominant
  if (Math.abs(deltaX) > Math.abs(deltaY) && e.cancelable) {
    e.preventDefault();
  }
  
  // Calculate rotation based on swipe distance
  const rotation = deltaX * 0.1;
  const opacity = Math.min(Math.abs(deltaX) / 100, 1);
  
  // Apply transform
  swipeCard.style.transform = `translateX(${deltaX}px) rotate(${rotation}deg)`;
  
  // Show like/nope indicators
  const likeIndicator = swipeCard.querySelector('.swipe-like');
  const nopeIndicator = swipeCard.querySelector('.swipe-nope');
  
  if (likeIndicator && nopeIndicator) {
    if (deltaX > 0) {
      likeIndicator.style.opacity = opacity;
      nopeIndicator.style.opacity = 0;
    } else {
      nopeIndicator.style.opacity = opacity;
      likeIndicator.style.opacity = 0;
    }
  }
}

function handleSwipeEnd(e) {
  if (!isSwiping || !swipeCard) return;
  isSwiping = false;
  
  const deltaX = swipeCurrentX - swipeStartX;
  const threshold = 100; // Minimum swipe distance to trigger action
  
  swipeCard.classList.add('animating');
  
  if (deltaX > threshold) {
    // Swiped right - LIKE
    swipeCard.style.transform = `translateX(${window.innerWidth}px) rotate(30deg)`;
    swipeCard.style.opacity = '0';
    setTimeout(() => {
      likeActivity();
    }, 200);
  } else if (deltaX < -threshold) {
    // Swiped left - NOPE
    swipeCard.style.transform = `translateX(-${window.innerWidth}px) rotate(-30deg)`;
    swipeCard.style.opacity = '0';
    setTimeout(() => {
      passActivity();
    }, 200);
  } else {
    // Not enough swipe - snap back
    swipeCard.style.transform = 'translateX(0) rotate(0)';
    const likeIndicator = swipeCard.querySelector('.swipe-like');
    const nopeIndicator = swipeCard.querySelector('.swipe-nope');
    if (likeIndicator) likeIndicator.style.opacity = 0;
    if (nopeIndicator) nopeIndicator.style.opacity = 0;
  }
}

async function likeActivity() {
  try {
    const pool = getDiscoverPool();
    if (pool.length === 0) return;
    const item = pool[0];
    
    // Animate card flying right
    const card = document.getElementById('currentCard');
    if (card) {
      card.classList.add('animating');
      card.style.transform = `translateX(${window.innerWidth}px) rotate(30deg)`;
      card.style.opacity = '0';
      const likeIndicator = card.querySelector('.swipe-like');
      if (likeIndicator) likeIndicator.style.opacity = 1;
    }
    
    state.swipedIds.push(item.id);
    state.stats.liked++;
    
    if (!item.isUserContent && !state.savedItems.find(i => i.id === item.id)) {
      state.savedItems.push(item);
      if (isLoggedIn) {
        saveSavedItem(item.id).catch(e => console.error('Save error:', e));
      }
    }
    
    if (isLoggedIn) {
      saveSwipedItem(item.id, 'like').catch(e => console.error('Swipe error:', e));
      updateUserProfile({ stats_liked: state.stats.liked }).catch(e => console.error('Profile error:', e));
    }
    
    cardImageIndex = 0;
    setTimeout(() => renderDiscover(), 200);
    
  } catch (err) {
    console.error('likeActivity error:', err);
    renderDiscover();
  }
}

async function passActivity() {
  try {
    const pool = getDiscoverPool();
    if (pool.length === 0) return;
    
    // Animate card flying left
    const card = document.getElementById('currentCard');
    if (card) {
      card.classList.add('animating');
      card.style.transform = `translateX(-${window.innerWidth}px) rotate(-30deg)`;
      card.style.opacity = '0';
      const nopeIndicator = card.querySelector('.swipe-nope');
      if (nopeIndicator) nopeIndicator.style.opacity = 1;
    }
    
    state.swipedIds.push(pool[0].id);
    state.stats.passed++;
    
    if (isLoggedIn) {
      saveSwipedItem(pool[0].id, 'pass').catch(e => console.error('Swipe error:', e));
      updateUserProfile({ stats_passed: state.stats.passed }).catch(e => console.error('Profile error:', e));
    }
    
    cardImageIndex = 0;
    setTimeout(() => renderDiscover(), 200);
    
  } catch (err) {
    console.error('passActivity error:', err);
    renderDiscover();
  }
}

// ============ TABS ============
function showTab(tab) {
  state.currentTab = tab;
  document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
  document.getElementById('tab-' + tab).classList.remove('hidden');
  document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
  event.currentTarget.classList.add('active');
  
  // Pulse discover button when not on discover tab
  const discoverBtn = document.querySelector('.nav-center-btn');
  if (tab === 'discover') {
    discoverBtn.classList.remove('pulse');
  } else {
    discoverBtn.classList.add('pulse');
  }
  
  if (tab === 'discover') renderDiscover();
  if (tab === 'browse') renderBrowse();
  if (tab === 'saved') renderSaved();
  if (tab === 'dates') renderDates();
  if (tab === 'plan') renderPlan();
  if (tab === 'profile') renderProfile();
}

// ============ BROWSE ============
function renderBrowse() {
  const filtersEl = document.getElementById('browseFilters');
  filtersEl.innerHTML = ALL_INTERESTS.map(i => `
    <button class="filter-chip ${state.browseFilters.includes(i.key) ? 'active' : ''}" onclick="toggleBrowseFilter('${i.key}')">${i.label}</button>
  `).join('');
  
  let items = NYC_ACTIVITIES;
  if (state.browseFilters.length > 0) {
    items = items.filter(item => item.tags.some(t => state.browseFilters.includes(t)));
  }
  
  document.getElementById('browseList').innerHTML = items.map(item => {
    // Get popular photos for this location
    const locationContent = userGeneratedContent
      .filter(c => c.place_id === item.id)
      .sort((a, b) => calculatePopularity(b) - calculatePopularity(a))
      .slice(0, 5);
    
    const photoPreview = locationContent.length > 0 ? `
      <div class="browse-card-photos">
        ${locationContent.slice(0, 4).map(c => `
          <img class="browse-card-photo" src="${c.media_url}" alt="">
        `).join('')}
        ${locationContent.length > 4 ? `<div class="browse-card-photo-more">+${locationContent.length - 4}</div>` : ''}
      </div>
    ` : '';
    
    return `
      <div class="browse-card" onclick="openLocationModal('${item.id}')">
        <img class="browse-card-image" src="${item.media[0]}" alt="${item.title}">
        <div class="browse-card-body">
          <div class="browse-card-title">${item.title}</div>
          <div class="browse-card-meta">
            <span>â­ ${item.rating}</span>
            <span>${item.price}</span>
            <span>${item.distance}</span>
            <span>ðŸ“¸ ${locationContent.length}</span>
          </div>
          <p class="browse-card-desc">${item.description}</p>
          ${photoPreview}
        </div>
      </div>
    `;
  }).join('');
}

function toggleBrowseFilter(key) {
  if (state.browseFilters.includes(key)) {
    state.browseFilters = state.browseFilters.filter(k => k !== key);
  } else {
    state.browseFilters.push(key);
  }
  renderBrowse();
}

async function saveItem(id) {
  const item = NYC_ACTIVITIES.find(i => i.id === id);
  if (item && !state.savedItems.find(i => i.id === id)) {
    state.savedItems.push(item);
    if (isLoggedIn) {
      await saveSavedItem(id);
    }
    alert('Saved to your favorites!');
  }
}

function openBooking(title) {
  const slug = title.toLowerCase().replace(/[^a-z0-9]+/g, '-');
  window.open('https://www.opentable.com/r/' + slug, '_blank');
}

// ============ SAVED ============
function renderSaved() {
  const list = document.getElementById('savedList');
  if (state.savedItems.length === 0) {
    list.innerHTML = '<p style="color:#888;">You haven\'t saved anything yet.</p>';
    return;
  }
  list.innerHTML = state.savedItems.map(item => `
    <div class="list-item">
      <img class="list-image" src="${item.media[0]}" alt="${item.title}" onclick="openGallery('${item.id}')">
      <div class="list-content">
        <div class="list-title">${item.title}</div>
        <div class="list-meta">${item.category} â€¢ ${item.price}</div>
        <div class="list-actions">
          <button class="btn-small btn-success" onclick="openBooking('${item.title}')">Book</button>
          <button class="btn-small btn-primary" onclick="removeItem('${item.id}')">Remove</button>
        </div>
      </div>
    </div>
  `).join('');
}

async function removeItem(id) {
  state.savedItems = state.savedItems.filter(i => i.id !== id);
  if (isLoggedIn) {
    await removeSavedItem(id);
  }
  renderSaved();
}

// ============ DATES ============
function renderDates() {
  const upcoming = state.dates.filter(d => d.status === 'upcoming');
  const past = state.dates.filter(d => d.status === 'past');
  
  document.getElementById('upcomingDates').innerHTML = upcoming.length === 0 
    ? '<p style="color:#888;">No upcoming dates yet.</p>'
    : upcoming.map(d => `
      <div class="date-card">
        <div class="date-title">${d.title}</div>
        <div class="date-time">${formatDateTime(d.datetime)}</div>
        <div class="date-activities">${(d.activities || []).join(' â€¢ ')}</div>
        <button class="btn-small btn-gray" style="margin-top:8px;" onclick="removeDate(${d.id})">Remove</button>
      </div>
    `).join('');
    
  document.getElementById('pastDates').innerHTML = past.length === 0
    ? '<p style="color:#888;">Your date history will appear here.</p>'
    : past.map(d => `
      <div class="date-card" style="opacity:0.8;">
        <div class="date-title">${d.title}</div>
        <div class="date-time">${formatDateTime(d.datetime)}</div>
      </div>
    `).join('');
}

async function removeDate(id) {
  state.dates = state.dates.filter(d => d.id !== id);
  if (isLoggedIn) {
    await removePlannedDate(id);
  }
  renderDates();
}

// ============ PLAN ============
function renderPlan() {
  if (!state.planDate) {
    const now = new Date();
    now.setHours(19, 0, 0, 0);
    document.getElementById('planDateTime').value = now.toISOString().slice(0, 16);
  }
  
  document.getElementById('partCountRow').innerHTML = [1,2,3,4].map(n => `
    <button class="part-count-btn ${state.numParts === n ? 'active' : ''}" onclick="setNumParts(${n})">${n}</button>
  `).join('');
  
  document.getElementById('partsPreview').innerHTML = Array.from({length: state.numParts}).map((_, i) => `
    <div class="part-row">
      <span class="part-num">${i + 1}</span>
      <button class="part-select" onclick="cyclePartType(${i})">${state.parts[i] || 'Pick part'}</button>
    </div>
  `).join('');
  
  document.getElementById('planSetup').classList.toggle('hidden', state.planStep !== 'setup');
  document.getElementById('planSelecting').classList.toggle('hidden', state.planStep !== 'selecting');
  document.getElementById('planComplete').classList.toggle('hidden', state.planStep !== 'complete');
  
  if (state.planStep === 'selecting') renderPlanSelecting();
  if (state.planStep === 'complete') renderPlanComplete();
}

function setNumParts(n) {
  state.numParts = n;
  renderPlan();
}

function cyclePartType(idx) {
  const current = state.parts[idx];
  const currentIdx = PART_TYPES.indexOf(current);
  state.parts[idx] = PART_TYPES[(currentIdx + 1) % PART_TYPES.length];
  renderPlan();
}

function startPlanSelection() {
  state.planDate = document.getElementById('planDateTime').value;
  state.planStep = 'selecting';
  state.currentPartIndex = 0;
  state.selectedPlanItems = [null, null, null, null];
  renderPlan();
}

function renderPlanSelecting() {
  document.getElementById('planStepTitle').textContent = `Part ${state.currentPartIndex + 1} of ${state.numParts}`;
  document.getElementById('planStepType').textContent = state.parts[state.currentPartIndex];
  document.getElementById('planProgress').style.width = `${((state.currentPartIndex + 1) / state.numParts) * 100}%`;
  
  const tag = getTagForPart(state.parts[state.currentPartIndex]);
  const activities = tag ? NYC_ACTIVITIES.filter(a => a.tags.includes(tag)) : [];
  
  document.getElementById('planActivities').innerHTML = activities.map(a => `
    <button class="activity-btn" onclick="selectPlanActivity('${a.id}')">
      <img src="${a.media[0]}" alt="${a.title}">
      <div class="activity-btn-content">
        <div class="activity-btn-title">${a.title}</div>
        <div class="activity-btn-category">${a.category}</div>
        <div class="activity-btn-meta">
          <span style="color:var(--primary);">ðŸ“ ${a.distance}</span>
          <span>â­ ${a.rating}</span>
          <span class="price">${a.price}</span>
        </div>
      </div>
      <span class="activity-btn-arrow">â†’</span>
    </button>
  `).join('');
}

function selectPlanActivity(id) {
  const activity = NYC_ACTIVITIES.find(a => a.id === id);
  state.selectedPlanItems[state.currentPartIndex] = activity;
  
  if (state.currentPartIndex < state.numParts - 1) {
    state.currentPartIndex++;
    renderPlan();
  } else {
    state.planStep = 'complete';
    renderPlan();
  }
}

function planBack() {
  if (state.currentPartIndex > 0) {
    state.currentPartIndex--;
    renderPlan();
  } else {
    state.planStep = 'setup';
    renderPlan();
  }
}

function renderPlanComplete() {
  const completed = state.selectedPlanItems.slice(0, state.numParts).filter(Boolean);
  document.getElementById('completedItems').innerHTML = completed.map((a, i) => `
    <div class="complete-item">
      <span class="complete-num">${i + 1}</span>
      <img class="complete-img" src="${a.media[0]}" alt="${a.title}">
      <div class="complete-info">
        <p>${a.title}</p>
        <p>${state.parts[i]} â€¢ ${a.distance}</p>
      </div>
    </div>
  `).join('');
}

async function finishPlan() {
  const selected = state.selectedPlanItems.slice(0, state.numParts).filter(Boolean);
  const newDate = {
    id: Date.now(),
    title: 'Planned Date Night',
    datetime: state.planDate,
    status: 'upcoming',
    activities: selected.map(s => s.title),
  };
  
  state.dates.push(newDate);
  
  if (isLoggedIn) {
    await savePlannedDate(newDate);
  }
  
  state.planStep = 'setup';
  state.selectedPlanItems = [null, null, null, null];
  alert('Your date plan has been added to Upcoming Dates!');
  renderPlan();
}

// ============ PROFILE ============
async function renderProfile() {
  document.getElementById('statLiked').textContent = state.stats.liked;
  document.getElementById('statPassed').textContent = state.stats.passed;
  
  document.getElementById('interestChips').innerHTML = ALL_INTERESTS.map(i => `
    <button class="filter-chip ${state.interests.includes(i.key) ? 'active' : ''}" onclick="toggleInterest('${i.key}')">${i.label}</button>
  `).join('');
  
  updateUIForLoggedInUser();
  
  // Render admin panel if user is admin
  if (isLoggedIn && userProfile?.is_admin) {
    await renderAdminPanel();
  }
  
  // Load my uploads if verified
  await loadMyUploads();
}

async function toggleInterest(key) {
  if (state.interests.includes(key)) {
    state.interests = state.interests.filter(k => k !== key);
  } else {
    state.interests.push(key);
  }
  
  if (isLoggedIn) {
    await updateUserProfile({ interests: state.interests });
  }
  
  renderProfile();
}

async function resetProfile() {
  if (confirm('Reset all your data?')) {
    state.interests = [];
    state.savedItems = [];
    state.swipedIds = [];
    state.stats = { liked: 0, passed: 0 };
    state.dates = [];
    
    // Note: For full reset with Supabase, you'd need to delete from all tables
    
    renderProfile();
    renderDiscover();
  }
}

function updateProfileVerificationUI() {
  const section = document.getElementById('verificationSection');
  const notVerified = document.getElementById('notVerifiedBox');
  const pending = document.getElementById('pendingVerifyBox');
  const verified = document.getElementById('verifiedBox');
  const badge = document.getElementById('profileVerifiedBadge');
  
  if (!isLoggedIn) {
    section.style.display = 'none';
    return;
  }
  
  section.style.display = 'block';
  
  if (state.verificationStatus === 'verified') {
    notVerified.style.display = 'none';
    pending.style.display = 'none';
    verified.style.display = 'block';
    badge.classList.remove('hidden');
  } else if (state.verificationStatus === 'pending') {
    notVerified.style.display = 'none';
    pending.style.display = 'block';
    verified.style.display = 'none';
    badge.classList.add('hidden');
  } else {
    notVerified.style.display = 'block';
    pending.style.display = 'none';
    verified.style.display = 'none';
    badge.classList.add('hidden');
  }
}

// ============ VERIFICATION ============
function openVerifyModal() {
  if (!isLoggedIn) {
    alert('Please log in to get verified.');
    return;
  }
  
  document.getElementById('verifyModal').classList.add('active');
  updateVerifyModalUI();
  
  if (state.verificationStatus !== 'verified' && state.verificationStatus !== 'pending') {
    startCamera();
  }
}

function closeVerifyModal() {
  document.getElementById('verifyModal').classList.remove('active');
  stopCamera();
}

function updateVerifyModalUI() {
  const form = document.getElementById('verifyForm');
  const pendingStatus = document.getElementById('verifyPendingStatus');
  const approvedStatus = document.getElementById('verifyApprovedStatus');
  
  if (state.verificationStatus === 'pending') {
    form.style.display = 'none';
    pendingStatus.style.display = 'block';
    approvedStatus.style.display = 'none';
  } else if (state.verificationStatus === 'verified') {
    form.style.display = 'none';
    pendingStatus.style.display = 'none';
    approvedStatus.style.display = 'block';
  } else {
    form.style.display = 'block';
    pendingStatus.style.display = 'none';
    approvedStatus.style.display = 'none';
  }
}

async function startCamera() {
  try {
    const video = document.getElementById('verifyVideo');
    cameraStream = await navigator.mediaDevices.getUserMedia({ 
      video: { facingMode: 'user' }, 
      audio: false 
    });
    video.srcObject = cameraStream;
    video.style.display = 'block';
    document.getElementById('selfiePreview').style.display = 'none';
    document.getElementById('cameraButtons').style.display = 'block';
    document.getElementById('retakeButtons').style.display = 'none';
  } catch (err) {
    console.error('Camera error:', err);
    alert('Could not access camera. Please allow camera permissions and try again.');
  }
}

function stopCamera() {
  if (cameraStream) {
    cameraStream.getTracks().forEach(track => track.stop());
    cameraStream = null;
  }
}

function captureSelfie() {
  const video = document.getElementById('verifyVideo');
  const canvas = document.getElementById('verifyCanvas');
  const preview = document.getElementById('selfiePreview');
  
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext('2d').drawImage(video, 0, 0);
  
  const imageData = canvas.toDataURL('image/jpeg');
  state.verificationData.selfieImage = imageData;
  
  preview.src = imageData;
  preview.style.display = 'block';
  video.style.display = 'none';
  document.getElementById('cameraButtons').style.display = 'none';
  document.getElementById('retakeButtons').style.display = 'block';
  
  stopCamera();
  checkVerifyFormComplete();
}

function retakeSelfie() {
  state.verificationData.selfieImage = null;
  document.getElementById('selfiePreview').style.display = 'none';
  startCamera();
  checkVerifyFormComplete();
}

function checkVerifyFormComplete() {
  const btn = document.getElementById('submitVerifyBtn');
  btn.disabled = !state.verificationData.selfieImage;
}

async function submitVerification() {
  if (!state.verificationData.selfieImage) {
    alert('Please take a selfie to verify your account.');
    return;
  }
  
  const submitBtn = document.getElementById('submitVerifyBtn');
  submitBtn.disabled = true;
  submitBtn.textContent = 'Verifying...';
  
  try {
    // Upload selfie to storage
    const selfieResponse = await fetch(state.verificationData.selfieImage);
    const selfieBlob = await selfieResponse.blob();
    const selfieFileName = `verifications/${currentUser.id}/selfie-${Date.now()}.jpg`;
    
    const { error: selfieUploadError } = await db.storage
      .from('user-uploads')
      .upload(selfieFileName, selfieBlob, { contentType: 'image/jpeg' });
    
    if (selfieUploadError) {
      console.error('Selfie upload error:', selfieUploadError);
      alert('Error uploading selfie. Please try again.');
      submitBtn.disabled = false;
      submitBtn.textContent = 'Submit for Verification';
      return;
    }
    
    // Get public URL
    const { data: selfieUrl } = db.storage.from('user-uploads').getPublicUrl(selfieFileName);
    
    // AUTO-APPROVE: Set status directly to verified
    state.verificationStatus = 'verified';
    
    await updateUserProfile({
      verification_status: 'verified',
      verification_selfie: selfieUrl.publicUrl,
      verification_submitted_at: new Date().toISOString()
    });
    
    updateVerifyModalUI();
    updateProfileVerificationUI();
    updateHeaderAvatar();
    
    alert('ðŸŽ‰ Congratulations! Your account has been verified. You can now upload your own content!');
    closeVerifyModal();
    
  } catch (err) {
    console.error('Verification error:', err);
    alert('Error submitting verification. Please try again.');
  }
  
  submitBtn.disabled = false;
  submitBtn.textContent = 'Submit for Verification';
}

// ============ UPLOAD CONTENT ============
let uploadedContentFile = null;
let uploadedContentType = null;

// ============ ADMIN FUNCTIONS ============
async function loadPendingVerifications() {
  if (!userProfile?.is_admin) return [];
  
  try {
    const { data, error } = await db
      .from('profiles')
      .select('id, email, name, verification_status, verification_selfie, verification_submitted_at')
      .eq('verification_status', 'pending')
      .order('verification_submitted_at', { ascending: true });
    
    if (error) {
      console.error('Error loading pending verifications:', error);
      return [];
    }
    
    return data || [];
  } catch (err) {
    console.error('loadPendingVerifications error:', err);
    return [];
  }
}

async function approveVerification(userId) {
  if (!userProfile?.is_admin) return;
  
  try {
    const { error } = await db
      .from('profiles')
      .update({ verification_status: 'verified' })
      .eq('id', userId);
    
    if (error) {
      console.error('Error approving:', error);
      alert('Error approving user');
      return;
    }
    
    alert('âœ… User approved!');
    renderProfile();
  } catch (err) {
    console.error('approveVerification error:', err);
  }
}

async function rejectVerification(userId) {
  if (!userProfile?.is_admin) return;
  
  try {
    const { error } = await db
      .from('profiles')
      .update({ 
        verification_status: 'none',
        verification_selfie: null,
        verification_submitted_at: null
      })
      .eq('id', userId);
    
    if (error) {
      console.error('Error rejecting:', error);
      alert('Error rejecting user');
      return;
    }
    
    alert('âŒ User rejected');
    renderProfile();
  } catch (err) {
    console.error('rejectVerification error:', err);
  }
}

function viewVerificationSelfie(selfieImage) {
  // Open selfie in new tab
  if (selfieImage) window.open(selfieImage, '_blank');
}

async function renderAdminPanel() {
  if (!userProfile?.is_admin) {
    document.getElementById('adminSection').style.display = 'none';
    return;
  }
  
  document.getElementById('adminSection').style.display = 'block';
  
  const pending = await loadPendingVerifications();
  const container = document.getElementById('pendingVerifications');
  
  if (pending.length === 0) {
    container.innerHTML = '<p style="color:#888;font-size:13px;">No pending requests</p>';
    return;
  }
  
  container.innerHTML = pending.map(user => `
    <div class="admin-item">
      <img class="admin-item-img" src="${user.verification_selfie || 'https://via.placeholder.com/60'}" alt="Selfie">
      <div class="admin-item-info">
        <div class="admin-item-name">${user.name || 'Unknown'}</div>
        <div class="admin-item-email">${user.email}</div>
        <div class="admin-item-date">Submitted: ${new Date(user.verification_submitted_at).toLocaleDateString()}</div>
      </div>
      <div class="admin-btns">
        <button class="admin-btn view" onclick="viewVerificationSelfie('${user.verification_selfie}')">View</button>
        <button class="admin-btn approve" onclick="approveVerification('${user.id}')">âœ“</button>
        <button class="admin-btn reject" onclick="rejectVerification('${user.id}')">âœ—</button>
      </div>
    </div>
  `).join('');
}

function openUploadModal() {
  if (!isLoggedIn || state.verificationStatus !== 'verified') {
    alert('You must be verified to upload content.');
    return;
  }
  
  document.getElementById('uploadModal').classList.add('active');
  
  const select = document.getElementById('uploadPlace');
  select.innerHTML = '<option value="">Choose a place...</option>' + 
    NYC_ACTIVITIES.map(a => `<option value="${a.id}">${a.title}</option>`).join('');
  
  // Reset all file inputs
  document.getElementById('uploadPreview').style.display = 'none';
  document.getElementById('uploadVideoPreview').style.display = 'none';
  document.getElementById('contentUploadBtn').classList.remove('has-file');
  document.getElementById('contentUploadText').textContent = 'Tap to select photo or video';
  document.getElementById('uploadCaption').value = '';
  document.getElementById('submitContentBtn').disabled = true;
  
  // Reset file inputs
  document.getElementById('contentInput').value = '';
  document.getElementById('cameraInput').value = '';
  document.getElementById('libraryInput').value = '';
  
  uploadedContentFile = null;
  uploadedContentType = null;
}

function closeUploadModal() {
  document.getElementById('uploadModal').classList.remove('active');
}

function handleContentUpload(event) {
  const file = event.target.files[0];
  if (!file) {
    console.log('No file selected');
    return;
  }
  
  console.log('File selected:', file.name, file.type, file.size);
  
  // Check file size (max 50MB)
  if (file.size > 50 * 1024 * 1024) {
    alert('File is too large. Maximum size is 50MB.');
    return;
  }
  
  // Show loading state
  document.getElementById('contentUploadBtn').classList.add('has-file');
  document.getElementById('contentUploadText').textContent = 'Loading...';
  
  // Determine file type
  if (file.type.startsWith('video/')) {
    uploadedContentType = 'video';
  } else if (file.type.startsWith('image/')) {
    uploadedContentType = 'image';
  } else {
    alert('Please select an image or video file.');
    return;
  }
  
  // Use URL.createObjectURL instead of FileReader (faster and more reliable)
  try {
    const objectUrl = URL.createObjectURL(file);
    uploadedContentFile = file; // Store the actual file, not base64
    
    if (uploadedContentType === 'video') {
      document.getElementById('uploadVideoPreview').src = objectUrl;
      document.getElementById('uploadVideoPreview').style.display = 'block';
      document.getElementById('uploadPreview').style.display = 'none';
    } else {
      document.getElementById('uploadPreview').src = objectUrl;
      document.getElementById('uploadPreview').style.display = 'block';
      document.getElementById('uploadVideoPreview').style.display = 'none';
    }
    
    document.getElementById('contentUploadText').textContent = 'âœ“ ' + file.name;
    checkUploadFormComplete();
    
  } catch (err) {
    console.error('Error loading file:', err);
    alert('Error loading file. Please try again.');
    document.getElementById('contentUploadText').textContent = 'Tap to select photo or video';
  }
}

function checkUploadFormComplete() {
  const btn = document.getElementById('submitContentBtn');
  const place = document.getElementById('uploadPlace').value;
  btn.disabled = !(uploadedContentFile && place);
}

async function submitContent() {
  const placeId = document.getElementById('uploadPlace').value;
  const caption = document.getElementById('uploadCaption').value;
  
  if (!uploadedContentFile || !placeId) {
    alert('Please select a photo/video and a place.');
    return;
  }
  
  const place = NYC_ACTIVITIES.find(a => a.id === placeId);
  const submitBtn = document.getElementById('submitContentBtn');
  submitBtn.disabled = true;
  submitBtn.textContent = 'Uploading...';
  
  try {
    // uploadedContentFile is now a File object
    const file = uploadedContentFile;
    
    // Generate unique filename
    const ext = file.name.split('.').pop() || (uploadedContentType === 'video' ? 'mp4' : 'jpg');
    const fileName = `${currentUser.id}/${Date.now()}.${ext}`;
    
    console.log('Uploading file:', fileName, file.type, file.size);
    
    // Upload to Supabase Storage
    const { data: uploadData, error: uploadError } = await db.storage
      .from('user-uploads')
      .upload(fileName, file, {
        contentType: file.type,
        upsert: false
      });
    
    if (uploadError) {
      console.error('Upload error:', uploadError);
      alert('Error uploading file: ' + uploadError.message);
      submitBtn.disabled = false;
      submitBtn.textContent = 'Post';
      return;
    }
    
    console.log('Upload successful:', uploadData);
    
    // Get public URL
    const { data: urlData } = db.storage
      .from('user-uploads')
      .getPublicUrl(fileName);
    
    const publicUrl = urlData.publicUrl;
    console.log('Public URL:', publicUrl);
    
    // Save to database
    const { error } = await db
      .from('user_content')
      .insert({
        user_id: currentUser.id,
        user_name: userProfile.name,
        user_verified: true,
        user_avatar: userProfile.avatar || null,
        place_id: placeId,
        place_name: place.title,
        place_category: place.category,
        place_address: place.address,
        media_url: publicUrl,
        media_type: uploadedContentType,
        caption: caption
      });
    
    if (error) {
      console.error('Error saving content:', error);
      alert('Error saving content: ' + error.message);
      submitBtn.disabled = false;
      submitBtn.textContent = 'Post';
      return;
    }
    
    // Reload user content
    userGeneratedContent = await loadUserContent();
    
    closeUploadModal();
    alert('ðŸŽ‰ Your content has been posted!');
    renderDiscover();
    
  } catch (err) {
    console.error('Submit error:', err);
    alert('Error uploading content: ' + err.message);
  }
  
  submitBtn.disabled = false;
  submitBtn.textContent = 'Post';
}

// ============ MODAL ============
function openGallery(id) {
  let media = [];
  
  if (id.startsWith('user-')) {
    const contentId = parseInt(id.replace('user-', ''));
    const content = userGeneratedContent.find(c => c.id === contentId);
    if (content) media = [content.media_url];
  } else {
    const item = NYC_ACTIVITIES.find(i => i.id === id);
    if (item) media = item.media;
  }
  
  if (media.length === 0) return;
  
  state.modalMedia = media;
  state.modalIndex = 0;
  updateModal();
  document.getElementById('galleryModal').classList.add('active');
}

function updateModal() {
  document.getElementById('modalImage').src = state.modalMedia[state.modalIndex];
  document.getElementById('modalNav').innerHTML = state.modalMedia.map((_, i) => `
    <button class="modal-dot ${i === state.modalIndex ? 'active' : ''}" onclick="setModalIndex(${i})"></button>
  `).join('');
}

function setModalIndex(i) {
  state.modalIndex = i;
  updateModal();
}

function closeModal() {
  document.getElementById('galleryModal').classList.remove('active');
}

// ============ INIT ============
function initApp() {
  renderDiscover();
  renderBrowse();
  renderSaved();
  renderDates();
  renderPlan();
  renderProfile();
  document.querySelector('.nav-center').classList.add('active');
}

// ============ LOCATION DETAIL MODAL ============
let currentLocationId = null;

function openLocationModal(activityId) {
  const activity = NYC_ACTIVITIES.find(a => a.id === activityId);
  if (!activity) return;
  
  currentLocationId = activityId;
  
  document.getElementById('locationImage').src = activity.media[0];
  document.getElementById('locationName').textContent = activity.title;
  document.getElementById('locationCategory').textContent = activity.category;
  document.getElementById('locationRating').textContent = `â­ ${activity.rating}`;
  document.getElementById('locationReviews').textContent = `â€¢ ${activity.reviewCount} reviews`;
  document.getElementById('locationPrice').textContent = `â€¢ ${activity.price}`;
  document.getElementById('locationDesc').textContent = activity.description;
  document.getElementById('locationAddress').textContent = `ðŸ“ ${activity.address}`;
  
  // Load user content for this location
  loadLocationContent(activityId);
  
  document.getElementById('locationModal').classList.add('active');
}

function closeLocationModal() {
  document.getElementById('locationModal').classList.remove('active');
  currentLocationId = null;
}

async function loadLocationContent(activityId) {
  const container = document.getElementById('locationPhotos');
  const countEl = document.getElementById('locationPhotoCount');
  
  // Filter content for this location and sort by popularity - up to 50
  const locationContent = userGeneratedContent
    .filter(c => c.place_id === activityId)
    .sort((a, b) => calculatePopularity(b) - calculatePopularity(a))
    .slice(0, 50);
  
  countEl.textContent = `${locationContent.length} posts`;
  
  if (locationContent.length === 0) {
    container.innerHTML = '<p style="color:#888;font-size:13px;grid-column:1/-1;">No user content yet. Be the first to share!</p>';
    container.className = 'location-photos';
    return;
  }
  
  // Use full grid for more photos
  container.className = locationContent.length > 4 ? 'location-photos-full' : 'location-photos';
  
  container.innerHTML = locationContent.map(content => `
    <div class="location-photo" onclick="openContentDetail(${content.id})">
      ${content.media_type === 'video' 
        ? `<video src="${content.media_url}" muted></video><span class="upload-thumb-video-icon">â–¶</span>`
        : `<img src="${content.media_url}" alt="">`
      }
      <div class="location-photo-user" onclick="event.stopPropagation(); openUserProfileModal('${content.user_id}', '${content.user_name}')">${content.user_name}</div>
      <div class="location-photo-likes">â¤ï¸ ${content.likes || 0}</div>
    </div>
  `).join('');
}

function saveLocationFromModal() {
  if (currentLocationId) {
    saveItem(currentLocationId);
  }
}

function bookLocationFromModal() {
  const activity = NYC_ACTIVITIES.find(a => a.id === currentLocationId);
  if (activity) {
    openBooking(activity.title);
  }
}

// ============ USER PROFILE MODAL ============
let currentProfileUserId = null;
let isOwnProfile = false;

async function openUserProfileModal(userId, userName) {
  currentProfileUserId = userId;
  isOwnProfile = isLoggedIn && currentUser && currentUser.id === userId;
  
  // Show edit icon only for own profile
  document.getElementById('avatarEditIcon').style.display = isOwnProfile ? 'flex' : 'none';
  document.getElementById('userProfileAvatarContainer').style.cursor = isOwnProfile ? 'pointer' : 'default';
  
  document.getElementById('userProfileName').textContent = userName;
  
  // Show share button only for own profile
  document.getElementById('shareProfileBtn').style.display = isOwnProfile ? 'block' : 'none';
  
  // Get user's content
  const userContent = userGeneratedContent.filter(c => c.user_id === userId);
  const totalLikes = userContent.reduce((sum, c) => sum + (c.likes || 0), 0);
  
  document.getElementById('userProfilePosts').textContent = userContent.length;
  document.getElementById('userProfileLikes').textContent = totalLikes;
  
  // Set avatar - check if user has custom avatar in their content or profile
  const avatarEl = document.getElementById('userProfileAvatar');
  let userAvatar = null;
  
  // If viewing own profile, use profile avatar
  if (isOwnProfile && userProfile?.avatar) {
    userAvatar = userProfile.avatar;
  } else {
    // Try to get avatar from user's content
    const contentWithAvatar = userContent.find(c => c.user_avatar);
    if (contentWithAvatar) userAvatar = contentWithAvatar.user_avatar;
  }
  
  // Display avatar with animation if applicable
  if (userAvatar && userAvatar.startsWith('http')) {
    avatarEl.innerHTML = `<img src="${userAvatar}" style="width:100%;height:100%;object-fit:cover;">`;
  } else if (userAvatar && userAvatar.includes(':')) {
    const [emoji, animation] = userAvatar.split(':');
    avatarEl.innerHTML = `<span class="avatar-animated avatar-${animation}" style="font-size:36px;">${emoji}</span>`;
  } else if (userAvatar) {
    avatarEl.innerHTML = userAvatar;
    avatarEl.style.fontSize = '36px';
  } else {
    avatarEl.innerHTML = userName.charAt(0).toUpperCase();
    avatarEl.style.fontSize = '36px';
  }
  
  const grid = document.getElementById('userProfileGrid');
  
  if (userContent.length === 0) {
    grid.innerHTML = '<p style="color:#888;font-size:13px;grid-column:1/-1;">No posts yet.</p>';
  } else {
    grid.innerHTML = userContent.map(content => `
      <div class="user-profile-item" onclick="openContentDetail(${content.id})">
        ${content.media_type === 'video' 
          ? `<video src="${content.media_url}" muted></video><span class="upload-thumb-video-icon">â–¶</span>`
          : `<img src="${content.media_url}" alt="">`
        }
        <div class="user-profile-item-likes">â¤ï¸ ${content.likes || 0}</div>
      </div>
    `).join('');
  }
  
  document.getElementById('userProfileModal').classList.add('active');
}

function closeUserProfileModal() {
  document.getElementById('userProfileModal').classList.remove('active');
  currentProfileUserId = null;
  isOwnProfile = false;
}

function openMyPublicProfile() {
  closeSideMenu();
  if (!isLoggedIn || !currentUser || state.verificationStatus !== 'verified') {
    alert('You need to be verified to have a public profile.');
    return;
  }
  openUserProfileModal(currentUser.id, userProfile?.name || 'User');
}

async function shareProfile() {
  if (!currentProfileUserId) return;
  
  const userName = document.getElementById('userProfileName').textContent;
  const shareUrl = `${window.location.origin}${window.location.pathname}?user=${currentProfileUserId}`;
  const shareText = `Check out ${userName}'s date reviews on Our Date Night! ðŸ’•`;
  
  if (navigator.share) {
    try {
      await navigator.share({
        title: `${userName} on Our Date Night`,
        text: shareText,
        url: shareUrl
      });
    } catch (err) {
      if (err.name !== 'AbortError') {
        copyToClipboard(shareUrl);
      }
    }
  } else {
    copyToClipboard(shareUrl);
  }
}

function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(() => {
    alert('Profile link copied to clipboard! ðŸ“‹');
  }).catch(() => {
    // Fallback for older browsers
    const textarea = document.createElement('textarea');
    textarea.value = text;
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand('copy');
    document.body.removeChild(textarea);
    alert('Profile link copied to clipboard! ðŸ“‹');
  });
}

// ============ CONTENT DETAIL & LIKES ============
let currentViewingContent = null;

function openContentDetail(contentId) {
  const content = userGeneratedContent.find(c => c.id === contentId);
  if (!content) return;
  
  currentViewingContent = content;
  
  // Set user info with animated avatar support
  const avatarEl = document.getElementById('contentViewerAvatar');
  const userAvatar = content.user_avatar;
  
  if (userAvatar && userAvatar.startsWith('http')) {
    avatarEl.innerHTML = `<img src="${userAvatar}" alt="">`;
  } else if (userAvatar && userAvatar.includes(':')) {
    const [emoji, animation] = userAvatar.split(':');
    avatarEl.innerHTML = `<span class="avatar-animated avatar-${animation}">${emoji}</span>`;
  } else if (userAvatar) {
    avatarEl.innerHTML = userAvatar;
  } else {
    avatarEl.innerHTML = content.user_name.charAt(0).toUpperCase();
  }
  
  document.getElementById('contentViewerName').textContent = content.user_name;
  
  // Set media
  const mediaEl = document.getElementById('contentViewerMedia');
  if (content.media_type === 'video') {
    mediaEl.innerHTML = `<video src="${content.media_url}" controls autoplay playsinline style="max-width:100%;max-height:100%;"></video>`;
  } else {
    mediaEl.innerHTML = `<img src="${content.media_url}" alt="">`;
  }
  
  // Set info
  document.getElementById('contentViewerPlace').textContent = content.place_name;
  document.getElementById('contentViewerCaption').textContent = content.caption || '';
  document.getElementById('contentViewerLikeCount').textContent = `${content.likes || 0} likes`;
  document.getElementById('contentViewerLikeBtn').textContent = 'ðŸ¤';
  
  document.getElementById('contentViewerModal').classList.add('active');
}

function closeContentViewer() {
  document.getElementById('contentViewerModal').classList.remove('active');
  currentViewingContent = null;
}

function viewContentUserProfile() {
  if (!currentViewingContent) return;
  closeContentViewer();
  openUserProfileModal(currentViewingContent.user_id, currentViewingContent.user_name);
}

async function likeCurrentContent() {
  if (!currentViewingContent) return;
  if (!isLoggedIn) {
    alert('Please log in to like content');
    return;
  }
  
  try {
    const newLikes = (currentViewingContent.likes || 0) + 1;
    
    const { error } = await db
      .from('user_content')
      .update({ likes: newLikes })
      .eq('id', currentViewingContent.id);
    
    if (error) {
      console.error('Error liking content:', error);
      return;
    }
    
    // Update local state
    currentViewingContent.likes = newLikes;
    const contentInArray = userGeneratedContent.find(c => c.id === currentViewingContent.id);
    if (contentInArray) contentInArray.likes = newLikes;
    
    // Update UI
    document.getElementById('contentViewerLikeCount').textContent = `${newLikes} likes`;
    document.getElementById('contentViewerLikeBtn').textContent = 'â¤ï¸';
    
  } catch (err) {
    console.error('likeCurrentContent error:', err);
  }
}

async function likeContent(contentId) {
  if (!isLoggedIn) {
    alert('Please log in to like content');
    return;
  }
  
  try {
    // Update likes in database
    const content = userGeneratedContent.find(c => c.id === contentId);
    if (!content) return;
    
    const newLikes = (content.likes || 0) + 1;
    
    const { error } = await db
      .from('user_content')
      .update({ likes: newLikes })
      .eq('id', contentId);
    
    if (error) {
      console.error('Error liking content:', error);
      return;
    }
    
    // Update local state
    content.likes = newLikes;
    
  } catch (err) {
    console.error('likeContent error:', err);
  }
}

// ============ AVATAR MANAGEMENT ============
let selectedAvatar = null;
let selectedAnimation = null;
let customAvatarUrl = null;

function openAvatarSelector() {
  // Only allow editing own profile
  if (!isOwnProfile) return;
  
  selectedAvatar = null;
  selectedAnimation = null;
  customAvatarUrl = null;
  
  // Clear previous selections
  document.querySelectorAll('.avatar-option').forEach(opt => opt.classList.remove('selected'));
  
  // Reset upload button
  const uploadBtn = document.querySelector('.avatar-upload-btn');
  if (uploadBtn) uploadBtn.innerHTML = 'âž•<input type="file" id="avatarUploadInput" accept="image/*" style="display:none;" onchange="handleAvatarUpload(event)">';
  
  document.getElementById('avatarModal').classList.add('active');
}

function closeAvatarModal() {
  document.getElementById('avatarModal').classList.remove('active');
}

function selectAvatar(emoji, animation) {
  selectedAvatar = emoji;
  selectedAnimation = animation || 'none';
  customAvatarUrl = null;
  
  // Update selection UI
  document.querySelectorAll('.avatar-option').forEach(opt => {
    opt.classList.remove('selected');
  });
  
  // Find and select the clicked option
  event.currentTarget.classList.add('selected');
}

async function handleAvatarUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  // Check file size (max 2MB)
  if (file.size > 2 * 1024 * 1024) {
    alert('Image is too large. Maximum size is 2MB.');
    return;
  }
  
  try {
    // Upload to Supabase Storage
    const fileName = `avatars/${currentUser.id}/${Date.now()}.jpg`;
    
    const { error: uploadError } = await db.storage
      .from('user-uploads')
      .upload(fileName, file, { contentType: file.type });
    
    if (uploadError) {
      console.error('Avatar upload error:', uploadError);
      alert('Error uploading avatar');
      return;
    }
    
    // Get public URL
    const { data: urlData } = db.storage
      .from('user-uploads')
      .getPublicUrl(fileName);
    
    customAvatarUrl = urlData.publicUrl;
    selectedAvatar = null;
    selectedAnimation = null;
    
    // Show preview
    document.querySelectorAll('.avatar-option').forEach(opt => opt.classList.remove('selected'));
    
    // Update the upload button to show preview
    const uploadBtn = document.querySelector('.avatar-upload-btn');
    uploadBtn.innerHTML = `<img src="${customAvatarUrl}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
    uploadBtn.classList.add('selected');
    
  } catch (err) {
    console.error('handleAvatarUpload error:', err);
    alert('Error uploading avatar');
  }
}

async function saveAvatar() {
  if (!selectedAvatar && !customAvatarUrl) {
    alert('Please select an avatar');
    return;
  }
  
  // Format: "emoji:animation" or just URL for custom
  const avatarValue = customAvatarUrl || `${selectedAvatar}:${selectedAnimation}`;
  
  try {
    // Update profile in database
    await updateUserProfile({ avatar: avatarValue });
    
    // Update local profile
    if (userProfile) userProfile.avatar = avatarValue;
    
    // Update UI
    updateAvatarDisplay(avatarValue);
    updateHeaderAvatar();
    
    closeAvatarModal();
    alert('Avatar updated!');
    
  } catch (err) {
    console.error('saveAvatar error:', err);
    alert('Error saving avatar');
  }
}

function updateAvatarDisplay(avatar) {
  const avatarEl = document.getElementById('userProfileAvatar');
  
  if (!avatar) {
    avatarEl.innerHTML = userProfile?.name?.charAt(0).toUpperCase() || 'U';
    avatarEl.style.fontSize = '36px';
    return;
  }
  
  if (avatar.startsWith('http')) {
    // Custom uploaded image
    avatarEl.innerHTML = `<img src="${avatar}" style="width:100%;height:100%;object-fit:cover;">`;
  } else if (avatar.includes(':')) {
    // Animated emoji format "emoji:animation"
    const [emoji, animation] = avatar.split(':');
    avatarEl.innerHTML = `<span class="avatar-animated avatar-${animation}">${emoji}</span>`;
    avatarEl.style.fontSize = '36px';
  } else {
    // Just emoji (legacy)
    avatarEl.innerHTML = avatar;
    avatarEl.style.fontSize = '36px';
  }
}

function renderAvatarHtml(avatar, size = '36px') {
  if (!avatar) return '';
  
  if (avatar.startsWith('http')) {
    return `<img src="${avatar}" style="width:100%;height:100%;object-fit:cover;">`;
  } else if (avatar.includes(':')) {
    const [emoji, animation] = avatar.split(':');
    return `<span class="avatar-animated avatar-${animation}" style="font-size:${size};">${emoji}</span>`;
  } else {
    return avatar;
  }
}

// Popularity formula: likes * 2 + recency bonus (newer = higher)
function calculatePopularity(content) {
  const likes = content.likes || 0;
  const createdAt = new Date(content.created_at).getTime();
  const now = Date.now();
  const ageInDays = (now - createdAt) / (1000 * 60 * 60 * 24);
  
  // Recency bonus: decays over 30 days
  const recencyBonus = Math.max(0, 30 - ageInDays);
  
  return (likes * 2) + recencyBonus;
}

// ============ MY UPLOADS ============
async function loadMyUploads() {
  if (!isLoggedIn || !currentUser || state.verificationStatus !== 'verified') {
    document.getElementById('myUploadsSection').style.display = 'none';
    return;
  }
  
  document.getElementById('myUploadsSection').style.display = 'block';
  
  const myContent = userGeneratedContent.filter(c => c.user_id === currentUser.id);
  const grid = document.getElementById('myUploadsGrid');
  
  if (myContent.length === 0) {
    grid.innerHTML = '<p style="color:#888;font-size:13px;grid-column:1/-1;">You haven\'t uploaded anything yet.</p>';
    return;
  }
  
  grid.innerHTML = myContent.map(content => `
    <div class="upload-thumb">
      ${content.media_type === 'video' 
        ? `<video src="${content.media_url}" muted></video><span class="upload-thumb-video-icon">â–¶</span>`
        : `<img src="${content.media_url}" alt="">`
      }
      <div class="upload-thumb-overlay">
        <button class="upload-thumb-delete" onclick="deleteMyUpload(${content.id})">ðŸ—‘ï¸ Delete</button>
      </div>
    </div>
  `).join('');
}

async function deleteMyUpload(contentId) {
  if (!confirm('Delete this upload? This cannot be undone.')) return;
  
  try {
    const { error } = await db
      .from('user_content')
      .delete()
      .eq('id', contentId)
      .eq('user_id', currentUser.id);
    
    if (error) {
      console.error('Error deleting content:', error);
      alert('Error deleting content');
      return;
    }
    
    // Remove from local state
    userGeneratedContent = userGeneratedContent.filter(c => c.id !== contentId);
    
    // Refresh UI
    loadMyUploads();
    renderDiscover();
    
    alert('Upload deleted successfully');
    
  } catch (err) {
    console.error('deleteMyUpload error:', err);
    alert('Error deleting upload');
  }
}

// ============ SIDE MENU ============
function openSideMenu() {
  // Show/hide My Public Profile based on verification status
  const myProfileItem = document.getElementById('myPublicProfileItem');
  if (isLoggedIn && state.verificationStatus === 'verified') {
    myProfileItem.style.display = 'flex';
  } else {
    myProfileItem.style.display = 'none';
  }
  
  // Show admin dashboard link for admins
  const adminDashboardItem = document.getElementById('adminDashboardItem');
  if (isLoggedIn && userProfile?.is_admin) {
    adminDashboardItem.style.display = 'flex';
  } else {
    adminDashboardItem.style.display = 'none';
  }
  
  document.getElementById('sideMenu').classList.add('active');
  document.getElementById('sideMenuOverlay').classList.add('active');
}

function closeSideMenu() {
  document.getElementById('sideMenu').classList.remove('active');
  document.getElementById('sideMenuOverlay').classList.remove('active');
}

// ============ ADMIN DASHBOARD ============
let adminUsers = [];
let adminCurrentTab = 'users';
let adminRefreshInterval = null;

async function openAdminDashboard() {
  closeSideMenu();
  document.getElementById('adminDashboardModal').classList.add('active');
  await loadAdminDashboardData();
  
  // Auto-refresh every 10 seconds while dashboard is open
  adminRefreshInterval = setInterval(async () => {
    await loadAdminDashboardData();
  }, 10000);
}

function closeAdminDashboard() {
  document.getElementById('adminDashboardModal').classList.remove('active');
  
  // Stop auto-refresh when dashboard is closed
  if (adminRefreshInterval) {
    clearInterval(adminRefreshInterval);
    adminRefreshInterval = null;
  }
}

function showAdminTab(tab) {
  adminCurrentTab = tab;
  
  // Update tab buttons
  document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
  event.currentTarget.classList.add('active');
  
  // Show/hide tab content
  document.getElementById('adminTabUsers').style.display = tab === 'users' ? 'block' : 'none';
  document.getElementById('adminTabContent').style.display = tab === 'content' ? 'block' : 'none';
  document.getElementById('adminTabLocations').style.display = tab === 'locations' ? 'block' : 'none';
}

async function loadAdminDashboardData() {
  try {
    // Reload user content from database
    userGeneratedContent = await loadUserContent();
    
    // Load all users
    const { data: users, error: usersError } = await db
      .from('profiles')
      .select('*')
      .order('created_at', { ascending: false });
    
    if (usersError) {
      console.error('Error loading users:', usersError);
      return;
    }
    
    adminUsers = users || [];
    
    // Calculate metrics
    const totalUsers = adminUsers.length;
    const verifiedUsers = adminUsers.filter(u => u.verification_status === 'verified').length;
    const totalPosts = userGeneratedContent.length;
    const totalLikes = userGeneratedContent.reduce((sum, c) => sum + (c.likes || 0), 0);
    
    // Update metric cards
    document.getElementById('metricTotalUsers').textContent = totalUsers;
    document.getElementById('metricVerifiedUsers').textContent = verifiedUsers;
    document.getElementById('metricTotalPosts').textContent = totalPosts;
    document.getElementById('metricTotalLikes').textContent = totalLikes;
    
    // Render users table
    renderAdminUsersTable();
    
    // Render content list
    renderAdminContentList();
    
    // Render locations
    renderAdminLocationsList();
    
    // Render top creators
    renderTopCreators();
    
    // Render recent activity
    renderRecentActivity();
    
  } catch (err) {
    console.error('loadAdminDashboardData error:', err);
  }
}

function renderAdminUsersTable() {
  const tbody = document.getElementById('adminUsersTable');
  document.getElementById('userCount').textContent = `${adminUsers.length} users`;
  
  if (adminUsers.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#888;">No users yet</td></tr>';
    return;
  }
  
  tbody.innerHTML = adminUsers.map(user => {
    const userPosts = userGeneratedContent.filter(c => c.user_id === user.id).length;
    const statusClass = user.verification_status === 'verified' ? 'verified' : 
                        user.verification_status === 'pending' ? 'pending' : 'none';
    const statusText = user.verification_status === 'verified' ? 'Verified' :
                       user.verification_status === 'pending' ? 'Pending' : 'Not Verified';
    
    const avatarContent = user.avatar && user.avatar.startsWith('http') 
      ? `<img src="${user.avatar}" alt="">`
      : (user.avatar && user.avatar.includes(':') 
        ? user.avatar.split(':')[0]
        : (user.name?.charAt(0).toUpperCase() || 'U'));
    
    return `
      <tr>
        <td>
          <div class="admin-table-user">
            <div class="admin-table-avatar">${avatarContent}</div>
            <div>
              <div style="font-weight:600;">${user.name || 'Unknown'}</div>
              <div style="font-size:11px;color:#888;">${user.email}</div>
            </div>
          </div>
        </td>
        <td><span class="admin-status ${statusClass}">${statusText}</span></td>
        <td>${userPosts}</td>
        <td style="font-size:12px;">${user.created_at ? new Date(user.created_at).toLocaleDateString() : 'N/A'}</td>
        <td>
          ${user.verification_status !== 'verified' 
            ? `<button class="admin-action-btn primary" onclick="adminVerifyUser('${user.id}')">Verify</button>`
            : `<button class="admin-action-btn secondary" onclick="adminUnverifyUser('${user.id}')">Unverify</button>`
          }
          <button class="admin-action-btn danger" onclick="adminDeleteUser('${user.id}')">Delete</button>
        </td>
      </tr>
    `;
  }).join('');
}

function renderAdminContentList() {
  const container = document.getElementById('adminContentList');
  document.getElementById('contentCount').textContent = `${userGeneratedContent.length} posts`;
  
  if (userGeneratedContent.length === 0) {
    container.innerHTML = '<p style="text-align:center;color:#888;">No content yet</p>';
    return;
  }
  
  const sortedContent = [...userGeneratedContent].sort((a, b) => 
    new Date(b.created_at) - new Date(a.created_at)
  );
  
  container.innerHTML = sortedContent.slice(0, 20).map(content => `
    <div class="top-content-item">
      ${content.media_type === 'video' 
        ? `<video class="top-content-thumb" src="${content.media_url}" muted></video>`
        : `<img class="top-content-thumb" src="${content.media_url}" alt="">`
      }
      <div class="top-content-info">
        <div class="top-content-place">${content.place_name}</div>
        <div class="top-content-user">by ${content.user_name}</div>
        <div class="top-content-stats">â¤ï¸ ${content.likes || 0} likes â€¢ ${new Date(content.created_at).toLocaleDateString()}</div>
      </div>
      <button class="admin-action-btn danger" onclick="adminDeleteContent(${content.id})">ðŸ—‘ï¸</button>
    </div>
  `).join('');
}

function renderAdminLocationsList() {
  const container = document.getElementById('adminLocationsList');
  
  // Count posts per location
  const locationCounts = {};
  userGeneratedContent.forEach(c => {
    if (!locationCounts[c.place_id]) {
      locationCounts[c.place_id] = { id: c.place_id, name: c.place_name, count: 0, likes: 0 };
    }
    locationCounts[c.place_id].count++;
    locationCounts[c.place_id].likes += (c.likes || 0);
  });
  
  const sortedLocations = Object.values(locationCounts).sort((a, b) => b.count - a.count);
  
  if (sortedLocations.length === 0) {
    container.innerHTML = '<p style="text-align:center;color:#888;">No location data yet</p>';
    return;
  }
  
  container.innerHTML = sortedLocations.slice(0, 10).map((loc, i) => {
    const activity = NYC_ACTIVITIES.find(a => a.id === loc.id);
    return `
      <div class="top-content-item">
        <div style="width:40px;height:40px;border-radius:50%;background:var(--secondary);display:flex;align-items:center;justify-content:center;color:white;font-weight:700;">${i + 1}</div>
        <div class="top-content-info">
          <div class="top-content-place">${loc.name}</div>
          <div class="top-content-stats">ðŸ“¸ ${loc.count} posts â€¢ â¤ï¸ ${loc.likes} likes</div>
        </div>
      </div>
    `;
  }).join('');
}

function renderTopCreators() {
  const container = document.getElementById('topCreatorsList');
  
  // Count posts and likes per user
  const creatorStats = {};
  userGeneratedContent.forEach(c => {
    if (!creatorStats[c.user_id]) {
      creatorStats[c.user_id] = { id: c.user_id, name: c.user_name, avatar: c.user_avatar, posts: 0, likes: 0 };
    }
    creatorStats[c.user_id].posts++;
    creatorStats[c.user_id].likes += (c.likes || 0);
  });
  
  const sortedCreators = Object.values(creatorStats).sort((a, b) => b.posts - a.posts);
  
  if (sortedCreators.length === 0) {
    container.innerHTML = '<p style="text-align:center;color:#888;">No creators yet</p>';
    return;
  }
  
  container.innerHTML = sortedCreators.slice(0, 5).map((creator, i) => {
    let avatarContent = creator.name?.charAt(0).toUpperCase() || 'U';
    if (creator.avatar && creator.avatar.startsWith('http')) {
      avatarContent = `<img src="${creator.avatar}" style="width:100%;height:100%;object-fit:cover;">`;
    } else if (creator.avatar && creator.avatar.includes(':')) {
      avatarContent = creator.avatar.split(':')[0];
    }
    
    return `
      <div class="top-content-item">
        <div style="width:40px;height:40px;border-radius:50%;background:${i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? '#cd7f32' : 'var(--secondary)'};display:flex;align-items:center;justify-content:center;color:white;font-size:14px;overflow:hidden;">${avatarContent}</div>
        <div class="top-content-info">
          <div class="top-content-place">${creator.name}</div>
          <div class="top-content-stats">ðŸ“¸ ${creator.posts} posts â€¢ â¤ï¸ ${creator.likes} likes</div>
        </div>
      </div>
    `;
  }).join('');
}

function renderRecentActivity() {
  const container = document.getElementById('recentActivityList');
  
  // Combine user signups and content posts
  const activities = [];
  
  adminUsers.forEach(user => {
    if (user.created_at) {
      activities.push({
        type: 'signup',
        user: user.name || user.email,
        date: new Date(user.created_at),
        text: 'joined Our Date Night'
      });
    }
  });
  
  userGeneratedContent.forEach(content => {
    activities.push({
      type: 'post',
      user: content.user_name,
      date: new Date(content.created_at),
      text: `posted at ${content.place_name}`
    });
  });
  
  activities.sort((a, b) => b.date - a.date);
  
  if (activities.length === 0) {
    container.innerHTML = '<p style="text-align:center;color:#888;">No activity yet</p>';
    return;
  }
  
  container.innerHTML = activities.slice(0, 10).map(activity => `
    <div style="padding:8px 0;border-bottom:1px solid #eee;font-size:13px;">
      <span style="font-weight:600;">${activity.user}</span>
      <span style="color:#666;"> ${activity.text}</span>
      <div style="font-size:11px;color:#888;margin-top:2px;">${formatTimeAgo(activity.date)}</div>
    </div>
  `).join('');
}

function formatTimeAgo(date) {
  const seconds = Math.floor((new Date() - date) / 1000);
  if (seconds < 60) return 'Just now';
  const minutes = Math.floor(seconds / 60);
  if (minutes < 60) return `${minutes}m ago`;
  const hours = Math.floor(minutes / 60);
  if (hours < 24) return `${hours}h ago`;
  const days = Math.floor(hours / 24);
  if (days < 7) return `${days}d ago`;
  return date.toLocaleDateString();
}

async function adminVerifyUser(userId) {
  if (!confirm('Verify this user?')) return;
  
  try {
    const { error } = await db
      .from('profiles')
      .update({ verification_status: 'verified' })
      .eq('id', userId);
    
    if (error) throw error;
    
    await loadAdminDashboardData();
    alert('User verified!');
  } catch (err) {
    console.error('adminVerifyUser error:', err);
    alert('Error verifying user');
  }
}

async function adminUnverifyUser(userId) {
  if (!confirm('Remove verification from this user?')) return;
  
  try {
    const { error } = await db
      .from('profiles')
      .update({ verification_status: 'none' })
      .eq('id', userId);
    
    if (error) throw error;
    
    await loadAdminDashboardData();
    alert('User unverified');
  } catch (err) {
    console.error('adminUnverifyUser error:', err);
    alert('Error unverifying user');
  }
}

async function adminDeleteUser(userId) {
  if (!confirm('âš ï¸ Delete this user? This cannot be undone!')) return;
  if (!confirm('Are you absolutely sure? All their content will also be deleted.')) return;
  
  try {
    // Delete user's content first
    await db.from('user_content').delete().eq('user_id', userId);
    await db.from('saved_items').delete().eq('user_id', userId);
    await db.from('swiped_items').delete().eq('user_id', userId);
    await db.from('planned_dates').delete().eq('user_id', userId);
    
    // Delete user profile
    const { error } = await db.from('profiles').delete().eq('id', userId);
    
    if (error) throw error;
    
    // Reload content
    userGeneratedContent = await loadUserContent();
    await loadAdminDashboardData();
    alert('User deleted');
  } catch (err) {
    console.error('adminDeleteUser error:', err);
    alert('Error deleting user');
  }
}

async function adminDeleteContent(contentId) {
  if (!confirm('Delete this content?')) return;
  
  try {
    const { error } = await db
      .from('user_content')
      .delete()
      .eq('id', contentId);
    
    if (error) throw error;
    
    // Reload content
    userGeneratedContent = await loadUserContent();
    await loadAdminDashboardData();
    renderDiscover();
    alert('Content deleted');
  } catch (err) {
    console.error('adminDeleteContent error:', err);
    alert('Error deleting content');
  }
}

async function adminRefreshData() {
  userGeneratedContent = await loadUserContent();
  await loadAdminDashboardData();
  alert('Data refreshed!');
}

function adminExportUsers() {
  const csv = [
    ['Name', 'Email', 'Status', 'Posts', 'Joined'].join(','),
    ...adminUsers.map(u => {
      const posts = userGeneratedContent.filter(c => c.user_id === u.id).length;
      return [
        u.name || '',
        u.email,
        u.verification_status || 'none',
        posts,
        u.created_at ? new Date(u.created_at).toLocaleDateString() : ''
      ].join(',');
    })
  ].join('\n');
  
  downloadCSV(csv, 'users.csv');
}

function adminExportContent() {
  const csv = [
    ['User', 'Place', 'Caption', 'Likes', 'Date'].join(','),
    ...userGeneratedContent.map(c => [
      c.user_name,
      `"${c.place_name}"`,
      `"${(c.caption || '').replace(/"/g, '""')}"`,
      c.likes || 0,
      new Date(c.created_at).toLocaleDateString()
    ].join(','))
  ].join('\n');
  
  downloadCSV(csv, 'content.csv');
}

function downloadCSV(csv, filename) {
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}

// ============ PAYMENT METHODS ============
let savedPaymentMethods = JSON.parse(localStorage.getItem('dateNightPayments') || '[]');

function openPaymentModal() {
  closeSideMenu();
  document.getElementById('paymentModal').classList.add('active');
  renderSavedCards();
  
  // Clear form
  document.getElementById('cardNumber').value = '';
  document.getElementById('cardName').value = '';
  document.getElementById('cardExpiry').value = '';
  document.getElementById('cardCvv').value = '';
}

function closePaymentModal() {
  document.getElementById('paymentModal').classList.remove('active');
}

function renderSavedCards() {
  const container = document.getElementById('savedCards');
  const noCards = document.getElementById('noCardsMessage');
  
  if (savedPaymentMethods.length === 0) {
    noCards.style.display = 'block';
    container.innerHTML = '';
    container.appendChild(noCards);
    return;
  }
  
  noCards.style.display = 'none';
  container.innerHTML = savedPaymentMethods.map((card, index) => `
    <div class="saved-card">
      <span class="saved-card-icon">${getCardIcon(card.number)}</span>
      <div class="saved-card-info">
        <div class="saved-card-number">â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ ${card.last4}</div>
        <div class="saved-card-exp">Expires ${card.expiry}</div>
      </div>
      <button class="saved-card-delete" onclick="deletePaymentMethod(${index})">ðŸ—‘ï¸</button>
    </div>
  `).join('');
}

function getCardIcon(number) {
  const firstDigit = number.charAt(0);
  if (firstDigit === '4') return 'ðŸ’³'; // Visa
  if (firstDigit === '5') return 'ðŸ’³'; // Mastercard
  if (firstDigit === '3') return 'ðŸ’³'; // Amex
  return 'ðŸ’³';
}

function formatCardNumber(input) {
  let value = input.value.replace(/\D/g, '');
  value = value.replace(/(.{4})/g, '$1 ').trim();
  input.value = value.substring(0, 19);
}

function formatExpiry(input) {
  let value = input.value.replace(/\D/g, '');
  if (value.length >= 2) {
    value = value.substring(0, 2) + '/' + value.substring(2);
  }
  input.value = value.substring(0, 5);
}

function savePaymentMethod() {
  const number = document.getElementById('cardNumber').value.replace(/\s/g, '');
  const name = document.getElementById('cardName').value.trim();
  const expiry = document.getElementById('cardExpiry').value;
  const cvv = document.getElementById('cardCvv').value;
  
  if (!number || number.length < 15) {
    alert('Please enter a valid card number');
    return;
  }
  if (!name) {
    alert('Please enter the cardholder name');
    return;
  }
  if (!expiry || expiry.length < 5) {
    alert('Please enter a valid expiry date');
    return;
  }
  if (!cvv || cvv.length < 3) {
    alert('Please enter a valid CVV');
    return;
  }
  
  const newCard = {
    last4: number.slice(-4),
    number: number.charAt(0), // Only store first digit for card type
    name: name,
    expiry: expiry
    // Note: Never store full card number or CVV in real app!
  };
  
  savedPaymentMethods.push(newCard);
  localStorage.setItem('dateNightPayments', JSON.stringify(savedPaymentMethods));
  
  // Clear form
  document.getElementById('cardNumber').value = '';
  document.getElementById('cardName').value = '';
  document.getElementById('cardExpiry').value = '';
  document.getElementById('cardCvv').value = '';
  
  renderSavedCards();
  alert('âœ… Payment method saved!');
}

function deletePaymentMethod(index) {
  if (confirm('Remove this payment method?')) {
    savedPaymentMethods.splice(index, 1);
    localStorage.setItem('dateNightPayments', JSON.stringify(savedPaymentMethods));
    renderSavedCards();
  }
}

// Start app
document.addEventListener('DOMContentLoaded', async function() {
  try {
    // Set a timeout to force hide loading after 5 seconds
    setTimeout(() => {
      hideLoading();
      if (!document.getElementById('app').classList.contains('active') && 
          !document.getElementById('onboarding').classList.contains('active')) {
        document.getElementById('welcome').classList.remove('hidden');
      }
    }, 5000);
    
    await checkSession();
    
    // Check for shared user profile URL
    checkSharedProfileUrl();
  } catch (err) {
    console.error('Startup error:', err);
    hideLoading();
    document.getElementById('welcome').classList.remove('hidden');
  }
  
  // Add event listener for place selection
  document.getElementById('uploadPlace').addEventListener('change', checkUploadFormComplete);
});

// Check for shared profile URL parameter
function checkSharedProfileUrl() {
  const urlParams = new URLSearchParams(window.location.search);
  const sharedUserId = urlParams.get('user');
  
  if (sharedUserId && userGeneratedContent.length > 0) {
    // Find content from this user to get their name
    const userContent = userGeneratedContent.find(c => c.user_id === sharedUserId);
    if (userContent) {
      // Small delay to ensure UI is ready
      setTimeout(() => {
        openUserProfileModal(sharedUserId, userContent.user_name);
      }, 500);
    }
  }
}

// Close modals on backdrop click
document.getElementById('galleryModal').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});
document.getElementById('loginModal').addEventListener('click', function(e) {
  if (e.target === this) closeLoginModal();
});
document.getElementById('verifyModal').addEventListener('click', function(e) {
  if (e.target === this) closeVerifyModal();
});
document.getElementById('uploadModal').addEventListener('click', function(e) {
  if (e.target === this) closeUploadModal();
});
document.getElementById('paymentModal').addEventListener('click', function(e) {
  if (e.target === this) closePaymentModal();
});
document.getElementById('locationModal').addEventListener('click', function(e) {
  if (e.target === this) closeLocationModal();
});
document.getElementById('userProfileModal').addEventListener('click', function(e) {
  if (e.target === this) closeUserProfileModal();
});
document.getElementById('contentViewerModal').addEventListener('click', function(e) {
  if (e.target === this) closeContentViewer();
});
document.getElementById('avatarModal').addEventListener('click', function(e) {
  if (e.target === this) closeAvatarModal();
});
document.getElementById('adminDashboardModal').addEventListener('click', function(e) {
  if (e.target === this) closeAdminDashboard();
});
</script>
</body>
</html>
